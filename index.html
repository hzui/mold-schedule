<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模具制造工艺流程跟踪系统</title>
    <!-- 生产环境使用独立的Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#27AE60',
                        warning: '#F59E0B',
                        danger: '#E53E3E',
                        pending: '#94A3B8',
                        neutral: '#64748B',
                        light: '#F8FAFC',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-bg {
                transition: background-color 0.3s ease;
            }
            .transition-transform {
                transition: transform 0.2s ease;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
            }
            .process-name-col {
                width: 150px;
                min-width: 150px;
            }
            .date-col {
                width: 75px;
                min-width: 75px;
            }
            .plan-days-col, .actual-days-col {
                width: 80px;
                min-width: 80px;
            }
            .remark-col {
                min-width: 140px;
            }
            .serial-number-col {
                width: 50px;
                min-width: 50px;
            }
            .status-col {
                width: 85px;
                min-width: 85px;
            }
            .action-col {
                width: 90px;
                min-width: 90px;
            }
            .status-badge {
                transition: all 0.2s ease;
            }
            .status-badge:hover {
                transform: scale(1.05);
            }
            input[type="date"] {
                position: relative;
            }
            input[type="date"]::-webkit-calendar-picker-indicator {
                background: transparent;
                padding: 0;
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
            }
            .date-picker-wrapper {
                position: relative;
            }
            .date-picker-icon {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: #64748B;
            }
            /* 优化的统计卡片样式 */
            .stat-card {
                background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf1 100%);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .stat-card.primary::before {
                background-color: #165DFF;
            }
            .stat-card.success::before {
                background-color: #27AE60;
            }
            .stat-card.warning::before {
                background-color: #F59E0B;
            }
            .stat-card.danger::before {
                background-color: #E53E3E;
            }
            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(22, 93, 255, 0.15);
            }
            .stat-card:hover::before {
                opacity: 1;
            }
            .stat-value {
                transition: all 0.5s ease-out;
                display: inline-block;
            }
            .stat-card:hover .stat-value {
                transform: scale(1.1);
            }
            .stat-container {
                position: relative;
                z-index: 10;
            }
            .floating-bg {
                position: absolute;
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background-color: rgba(22, 93, 255, 0.05);
                top: -60px;
                right: -60px;
                transition: all 0.5s ease;
            }
            .stat-card:hover .floating-bg {
                transform: scale(2);
            }
            .stat-card.success .floating-bg {
                background-color: rgba(39, 174, 96, 0.05);
            }
            .stat-card.warning .floating-bg {
                background-color: rgba(245, 158, 11, 0.05);
            }
            .stat-card.danger .floating-bg {
                background-color: rgba(229, 62, 62, 0.05);
            }
            .stat-trend {
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                margin-top: 4px;
            }
            .trend-up {
                color: #E53E3E;
            }
            .trend-down {
                color: #27AE60;
            }
            /* 排期冲突提示样式 */
            .conflict-highlight {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { background-color: rgba(229, 62, 62, 0.1); }
                50% { background-color: rgba(229, 62, 62, 0.2); }
                100% { background-color: rgba(229, 62, 62, 0.1); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark">
    <!-- 顶部导航栏 -->
    <header class="bg-primary text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col items-center text-center">
            <div class="mb-2">
                <h1 class="text-2xl md:text-[clamp(1.5rem,3vw,2.2rem)] font-bold tracking-tight">模具制造工艺流程跟踪系统</h1>
            </div>
            <p class="text-sm md:text-base opacity-90 max-w-md">
                实时监控生产进度 · 优化制造流程 · 提升生产效率
            </p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- 模具基本信息卡片 -->
        <section class="mb-8 bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg">
            <h2 class="text-lg md:text-xl font-semibold mb-4 pb-2 border-b border-gray-100 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>模具基本信息
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- 第一行：5个输入项 -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具编号</label>
                    <input type="text" id="moldNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具名称</label>
                    <input type="text" id="moldName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具类型</label>
                    <input type="text" id="moldType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">版本号</label>
                    <input type="text" id="version" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">产品名称</label>
                    <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <!-- 第二行：5个输入项 -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">材料</label>
                    <input type="text" id="material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">穴数</label>
                    <input type="number" id="cavityCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">开模通知</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="moldOpenNotice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all pr-8">
                        <i class="fa fa-calendar date-picker-icon"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">试模日期</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="testDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all pr-8">
                        <i class="fa fa-calendar date-picker-icon"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="moldRemark" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="输入其他信息..."></textarea>
                </div>
            </div>
        </section>
        
        <!-- 功能按钮区 - 调整按钮顺序和颜色 -->
        <section class="mb-6 flex flex-wrap justify-center gap-3">
            <!-- 主要操作按钮组 - 颜色一致 -->
            <button id="saveBtn" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-save mr-2"></i>保存数据
            </button>
            <button id="addBtn" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-plus mr-2"></i>添加工序
            </button>
            <button id="recalculateBtn" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-calculator mr-2"></i>重新计算
            </button>
            
            <!-- 其他功能按钮 -->
            <button id="exportBtn" class="flex items-center px-4 py-2 bg-success text-white rounded-lg hover:bg-success/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-file-excel-o mr-2"></i>导出Excel
            </button>
            <button id="clearBtn" class="flex items-center px-4 py-2 bg-neutral text-white rounded-lg hover:bg-neutral/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-trash mr-2"></i>清空数据
            </button>
            <button id="initBtn" class="flex items-center px-4 py-2 bg-warning text-white rounded-lg hover:bg-warning/90 transition-all shadow hover:shadow-md hover-lift">
                <i class="fa fa-refresh mr-2"></i>初始化流程
            </button>
        </section>
        
        <!-- 周期统计卡片 - 只保留总计划周期和总实际周期 -->
        <section class="mb-8">
            <div class="w-full">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="stat-card primary rounded-xl p-5 border border-gray-200 shadow-sm relative overflow-hidden">
                        <div class="floating-bg"></div>
                        <div class="stat-container relative z-10">
                            <h3 class="text-sm font-medium text-gray-500 mb-1 flex items-center">
                                <i class="fa fa-clock-o mr-2"></i>总计划周期
                            </h3>
                            <div class="flex items-baseline mb-2">
                                <span id="totalPlanDays" class="stat-value text-2xl font-bold text-primary">0</span>
                                <span class="ml-1 text-gray-600">天</span>
                            </div>
                            <div id="planTrend" class="stat-trend">
                                <i class="fa fa-arrow-right mr-1"></i>
                                <span>预计完成日期待定</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card success rounded-xl p-5 border border-gray-200 shadow-sm relative overflow-hidden">
                        <div class="floating-bg"></div>
                        <div class="stat-container relative z-10">
                            <h3 class="text-sm font-medium text-gray-500 mb-1 flex items-center">
                                <i class="fa fa-check-square-o mr-2"></i>总实际周期
                            </h3>
                            <div class="flex items-baseline mb-2">
                                <span id="totalActualDays" class="stat-value text-2xl font-bold text-success">0</span>
                                <span class="ml-1 text-gray-600">天</span>
                            </div>
                            <div id="actualTrend" class="stat-trend">
                                <i class="fa fa-arrow-right mr-1"></i>
                                <span>实际进度跟踪中</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 工艺流程跟踪表 -->
        <section class="bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg">
            <h2 class="text-lg md:text-xl font-semibold mb-4 pb-2 border-b border-gray-100 flex items-center">
                <i class="fa fa-tasks text-primary mr-2"></i>工艺流程跟踪表
            </h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="serial-number-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                            <th scope="col" class="process-name-col px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">工序名称</th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">计划开始</th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">计划结束</th>
                            <th scope="col" class="plan-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">计划天数</th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">实际开始</th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">实际结束</th>
                            <th scope="col" class="actual-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">实际天数</th>
                            <th scope="col" class="status-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th scope="col" class="remark-col px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                            <th scope="col" class="action-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 表格内容将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-500 italic">
                <i class="fa fa-info-circle mr-1"></i>操作提示：点击状态标签可切换工序状态，修改日期或天数会自动计算关联值
            </div>
        </section>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6 mt-10">
        <div class="container mx-auto px-4 text-center">
            <p>模具制造工艺流程跟踪系统 &copy; 2025 版权所有</p>
            <p class="text-sm text-gray-400 mt-2">
                <a href="https://beian.miit.gov.cn/" target="_blank" class="hover:text-primary transition-colors">
                    ICP备案号：粤ICP备12345678号
                </a>
            </p>
        </div>
    </footer>
    
    <!-- 通知提示组件 -->
    <div id="notification" class="fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform-lg transform transform translate-x-full transition-transform duration-300 flex items-center z-50"></div>

    <script>
        // 全局变量
        let processData = [];
        let nextProcessId = 1;
        let scheduleSettings = {
            includeDependencies: true // 仅保留工序依赖关系设置
        };
        
        // DOM元素
        const processTableBody = document.getElementById('processTableBody');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const initBtn = document.getElementById('initBtn');
        const addBtn = document.getElementById('addBtn');
        const recalculateBtn = document.getElementById('recalculateBtn'); // 重新计算按钮
        const notification = document.getElementById('notification');
        const totalPlanDaysElement = document.getElementById('totalPlanDays');
        const totalActualDaysElement = document.getElementById('totalActualDays');
        const planTrendElement = document.getElementById('planTrend');
        const actualTrendElement = document.getElementById('actualTrend');
        
        // 状态选项
        const statusOptions = [
            { id: 'pending', name: '未开始', class: 'bg-pending/20 text-pending border border-pending/30' },
            { id: 'inProgress', name: '进行中', class: 'bg-warning/20 text-warning border border-warning/30' },
            { id: 'completed', name: '已完成', class: 'bg-success/20 text-success border border-success/30' },
            { id: 'delayed', name: '已延迟', class: 'bg-danger/20 text-danger border border-danger/30' }
        ];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
            updateCycleStatistics();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            saveBtn.addEventListener('click', saveData);
            exportBtn.addEventListener('click', exportToExcel);
            clearBtn.addEventListener('click', clearAllData);
            initBtn.addEventListener('click', initializeDefaultProcesses);
            addBtn.addEventListener('click', addNewProcess);
            
            // 重新计算按钮事件
            recalculateBtn.addEventListener('click', recalculateSchedule);
            
            // 为日期选择器添加点击事件
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                
                wrapper.addEventListener('click', () => {
                    input.showPicker();
                });
            });
        }
        
        // 重新计算排期 - 从第一个工序的计划开始日期计算
        function recalculateSchedule() {
            if (processData.length === 0) {
                showNotification('请先添加工序再进行计算', 'warning');
                return;
            }
            
            // 从第一个工序的计划开始日期计算
            let startDate;
            
            // 以第一个工序的计划开始日期作为基准
            if (processData[0].planStart) {
                startDate = processData[0].planStart;
            } else {
                // 如果第一个工序没有计划开始日期，使用开模通知日期或当前日期
                startDate = document.getElementById('moldOpenNotice').value || formatDate(new Date());
                processData[0].planStart = startDate;
            }
            
            // 保存当前数据
            saveData();
            
            // 使用当前设置执行排期算法，从第一个工序开始
            scheduleProcesses(startDate, scheduleSettings);
            
            // 检查排期冲突
            const conflicts = checkScheduleConflicts();
            if (conflicts.length > 0) {
                highlightConflicts(conflicts);
                showNotification(`检测到 ${conflicts.length} 处排期冲突`, 'warning');
            }
            
            // 更新界面
            renderProcessTable();
            updateCycleStatistics();
            showNotification('排期已重新计算', 'success');
        }
        
        // 检查排期冲突
        function checkScheduleConflicts() {
            const conflicts = [];
            
            // 检查工序间的日期冲突
            for (let i = 1; i < processData.length; i++) {
                const current = processData[i];
                const prev = processData[i - 1];
                
                // 检查计划日期冲突
                if (current.planStart && prev.planEnd && 
                    new Date(current.planStart) < new Date(prev.planEnd)) {
                    conflicts.push({
                        type: 'plan',
                        index: i,
                        message: `工序 ${i+1} 的计划开始日期早于工序 ${i} 的计划结束日期`
                    });
                }
                
                // 检查实际日期冲突
                if (current.actualStart && prev.actualEnd && 
                    new Date(current.actualStart) < new Date(prev.actualEnd)) {
                    conflicts.push({
                        type: 'actual',
                        index: i,
                        message: `工序 ${i+1} 的实际开始日期早于工序 ${i} 的实际结束日期`
                    });
                }
                
                // 检查实际日期是否超过计划日期
                if (current.actualEnd && current.planEnd && 
                    new Date(current.actualEnd) > new Date(current.planEnd) &&
                    current.status === 'completed') {
                    conflicts.push({
                        type: 'delay',
                        index: i,
                        message: `工序 ${i+1} 实际完成日期超过计划日期`
                    });
                }
            }
            
            return conflicts;
        }
        
        // 高亮显示冲突
        function highlightConflicts(conflicts) {
            conflicts.forEach(conflict => {
                const row = document.querySelector(`tr[data-id="${processData[conflict.index].id}"]`);
                if (row) {
                    row.classList.add('conflict-highlight');
                    
                    // 5秒后移除高亮
                    setTimeout(() => {
                        row.classList.remove('conflict-highlight');
                    }, 5000);
                }
            });
        }
        
        // 排期算法 - 不再排除周末
        function scheduleProcesses(startDate, settings) {
            let currentDate = new Date(startDate);
            
            for (let i = 0; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // 处理已完成工序
                if (currentProcess.status === 'completed') {
                    // 跳过已完成工序
                    if (currentProcess.actualEnd) {
                        currentDate = new Date(currentProcess.actualEnd);
                    } else if (currentProcess.planEnd) {
                        currentDate = new Date(currentProcess.planEnd);
                    }
                    continue;
                }
                
                // 如果考虑依赖关系，当前工序的计划开始日期应为前序工序的计划结束日期
                if (settings.includeDependencies && prevProcess && prevProcess.planEnd) {
                    currentDate = new Date(prevProcess.planEnd);
                }
                
                currentProcess.planStart = formatDate(currentDate);
                
                // 计算计划结束日期（包含所有日期，不再排除周末）
                if (currentProcess.planDays && currentProcess.planDays > 0) {
                    // 增加计划天数（包含所有日期）
                    currentDate.setDate(currentDate.getDate() + currentProcess.planDays);
                    currentProcess.planEnd = formatDate(currentDate);
                }
            }
        }
        
        // 更新周期统计
        function updateCycleStatistics() {
            if (processData.length === 0) {
                animateValue(totalPlanDaysElement, 0, 0, 500);
                animateValue(totalActualDaysElement, 0, 0, 500);
                return;
            }
            
            // 计算计划总周期
            const planStarts = processData.map(p => p.planStart).filter(d => d);
            const planEnds = processData.map(p => p.planEnd).filter(d => d);
            
            let totalPlanDays = 0;
            let lastPlanEndDate = null;
            if (planStarts.length > 0 && planEnds.length > 0) {
                const firstPlanStart = new Date(Math.min(...planStarts.map(d => new Date(d).getTime())));
                lastPlanEndDate = new Date(Math.max(...planEnds.map(d => new Date(d).getTime())));
                totalPlanDays = calculateDaysBetween(firstPlanStart, lastPlanEndDate);
            }
            
            // 更新计划趋势
            if (lastPlanEndDate) {
                const formattedDate = formatDateWithYear(lastPlanEndDate.toISOString().split('T')[0]);
                planTrendElement.innerHTML = `<i class="fa fa-calendar mr-1"></i><span>预计完成: ${formattedDate}</span>`;
            } else {
                planTrendElement.innerHTML = `<i class="fa fa-arrow-right mr-1"></i><span>预计完成日期待定</span>`;
            }
            
            // 计算实际总周期
            const actualStarts = processData.map(p => p.actualStart).filter(d => d);
            const actualEnds = processData.map(p => p.actualEnd).filter(d => d);
            
            let totalActualDays = 0;
            let lastActualEndDate = null;
            if (actualStarts.length > 0 && actualEnds.length > 0) {
                const firstActualStart = new Date(Math.min(...actualStarts.map(d => new Date(d).getTime())));
                lastActualEndDate = new Date(Math.max(...actualEnds.map(d => new Date(d).getTime())));
                totalActualDays = calculateDaysBetween(firstActualStart, lastActualEndDate);
            }
            
            // 更新实际趋势
            if (lastActualEndDate) {
                const formattedDate = formatDateWithYear(lastActualEndDate.toISOString().split('T')[0]);
                actualTrendElement.innerHTML = `<i class="fa fa-calendar-check-o mr-1"></i><span>当前完成至: ${formattedDate}</span>`;
            } else {
                actualTrendElement.innerHTML = `<i class="fa fa-arrow-right mr-1"></i><span>实际进度跟踪中</span>`;
            }
            
            // 更新显示，添加动画效果
            animateValue(totalPlanDaysElement, parseInt(totalPlanDaysElement.textContent) || 0, totalPlanDays, 500);
            animateValue(totalActualDaysElement, parseInt(totalActualDaysElement.textContent) || 0, totalActualDays, 500);
        }
        
        // 精确计算两个日期之间的天数（包含所有日期）
        function calculateDaysBetween(startDate, endDate) {
            // 确保日期对象有效
            if (!(startDate instanceof Date) || !(endDate instanceof Date) || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return 0;
            }
            
            // 如果开始日期晚于结束日期，返回0
            if (startDate > endDate) {
                return 0;
            }
            
            // 计算时间差（毫秒）
            const timeDiff = endDate.getTime() - startDate.getTime();
            
            // 转换为天数并向上取整
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }
        
        // 数字变化动画
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // 使用缓动函数使动画更自然
                const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                element.textContent = Math.floor(easeProgress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // 加载数据
        function loadData() {
            const savedData = localStorage.getItem('moldTrackingData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    processData = data.processes || [];
                    nextProcessId = data.nextId || 1;
                    
                    // 加载模具基本信息
                    if (data.moldInfo) {
                        Object.keys(data.moldInfo).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data.moldInfo[key];
                            }
                        });
                    }
                    
                    // 加载排期设置（移除周末排除相关）
                    if (data.scheduleSettings) {
                        scheduleSettings.includeDependencies = data.scheduleSettings.includeDependencies !== undefined 
                            ? data.scheduleSettings.includeDependencies 
                            : true;
                    }
                    
                    renderProcessTable();
                    updateCycleStatistics();
                } catch (error) {
                    console.error('加载数据失败:', error);
                    showNotification('加载数据失败，将初始化新数据', 'error');
                    initializeDefaultProcesses();
                }
            } else {
                initializeDefaultProcesses();
            }
        }
        
        // 保存数据
        function saveData() {
            // 收集模具基本信息
            const moldInfo = {
                moldNumber: document.getElementById('moldNumber').value,
                moldName: document.getElementById('moldName').value,
                moldType: document.getElementById('moldType').value,
                version: document.getElementById('version').value,
                productName: document.getElementById('productName').value,
                material: document.getElementById('material').value,
                cavityCount: document.getElementById('cavityCount').value,
                moldOpenNotice: document.getElementById('moldOpenNotice').value,
                testDate: document.getElementById('testDate').value,
                moldRemark: document.getElementById('moldRemark').value
            };
            
            // 保存到localStorage
            const dataToSave = {
                moldInfo,
                processes: processData,
                nextId: nextProcessId,
                scheduleSettings: scheduleSettings
            };
            
            localStorage.setItem('moldTrackingData', JSON.stringify(dataToSave));
            showNotification('数据保存成功', 'success');
        }
        
        // 导出到Excel
        function exportToExcel() {
            if (processData.length === 0) {
                showNotification('没有工序数据可导出', 'warning');
                return;
            }
            
            // 创建工作簿
            const workbook = new ExcelJS.Workbook();
            workbook.creator = '模具制造系统';
            workbook.lastModifiedBy = '系统用户';
            workbook.created = new Date();
            workbook.modified = new Date();
            
            // 添加工作表
            const worksheet = workbook.addWorksheet('模具制造流程跟踪');
            
            // 定义列宽设置 - 所有日期列宽保持一致
            const columnWidths = [10, 15, 10, 10, 10, 10, 10, 10, 10, 16]; // 序号列宽设置为10
            worksheet.columns = columnWidths.map((width, index) => ({
                width,
                key: String.fromCharCode(65 + index)
            }));
            
            // 添加标题行
            const titleText = `模具制造流程跟踪表 - ${document.getElementById('moldName').value || '未命名'}`;
            const titleRow = worksheet.addRow([titleText]);
            titleRow.height = 35;
            titleRow.font = { bold: true, size: 20, color: { argb: 'FF165DFF' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
            worksheet.mergeCells('A1:J1');
            
            // 模具基本信息区域
            const basicInfoHeader = worksheet.addRow(['模具基本信息']);
            formatSectionHeader(worksheet, basicInfoHeader, 1, 10);
            
            // 第一行：模具编号、模具名称、模具类型、版本号、产品名称
            let rowNum = worksheet.rowCount + 1;
            const firstRow = worksheet.getRow(rowNum);
            firstRow.height = 25;
            
            const firstRowItems = [
                { label: '模具编号', id: 'moldNumber', width: 10 }, // 模具编号列宽设置为10
                { label: '模具名称', id: 'moldName', width: 10 }, // 模具名称列宽设置为10
                { label: '模具类型', id: 'moldType', width: 10 },
                { label: '版本号', id: 'version', width: 10 },
                { label: '产品名称', id: 'productName', width: 10 }
            ];
            
            firstRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // 标题单元格
                const cell = firstRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // 信息单元格
                const valueCell = firstRow.getCell(cellIndex + 1);
                valueCell.value = value;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // 第二行：材料、穴数、开模通知、试模日期、备注
            rowNum = worksheet.rowCount + 1;
            const secondRow = worksheet.getRow(rowNum);
            secondRow.height = 25;
            
            const secondRowItems = [
                { label: '材料', id: 'material', width: 10 }, // 材料列宽设置为10
                { label: '穴数', id: 'cavityCount', width: 10 }, // 穴数列宽设置为10
                { label: '开模通知', id: 'moldOpenNotice', width: 10 },
                { label: '试模日期', id: 'testDate', width: 10 },
                { label: '备注', id: 'moldRemark', width: 10 }
            ];
            
            secondRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // 所有日期都使用不带年份的格式
                let displayValue;
                if (item.id.includes('Date') || item.id === 'moldOpenNotice') {
                    displayValue = value ? formatDateWithoutYear(value) : '';
                } else {
                    displayValue = value;
                }
                
                // 标题单元格
                const cell = secondRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // 信息单元格
                const valueCell = secondRow.getCell(cellIndex + 1);
                valueCell.value = displayValue;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // 添加工序表头（移除多余空白行）
            const headerRow = worksheet.addRow([
                '序号', '工序名称', '计划开始', '计划结束', 
                '计划天数', '实际开始', '实际结束', '实际天数', '状态', '备注'
            ]);
            headerRow.height = 30;
            headerRow.eachCell(cell => {
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
                cell.border = {
                    top: { style: 'medium' },
                    left: { style: 'medium' },
                    bottom: { style: 'medium' },
                    right: { style: 'medium' }
                };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
            });
            
            // 重置数据列宽，确保所有日期列宽度一致
            [3, 4, 6, 7].forEach(colIndex => {
                worksheet.getColumn(colIndex).width = 10;
            });
            
            // 计算总计划天数和总实际天数
            let totalPlanDays = 0;
            let totalActualDays = 0;
            
            // 添加工序数据
            processData.forEach((process, index) => {
                // 累加各工序的计划天数和实际天数
                const planDays = process.planDays ? parseInt(process.planDays) : 0;
                const actualDays = process.actualDays ? parseInt(process.actualDays) : 0;
                totalPlanDays += planDays;
                totalActualDays += actualDays;
                
                // 修复计划结束日期显示问题
                const planEndDate = process.planEnd ? formatDateWithoutYear(process.planEnd) : '';
                
                const row = worksheet.addRow([
                    index + 1,
                    process.name || '',
                    process.planStart ? formatDateWithoutYear(process.planStart) : '',
                    planEndDate,
                    planDays,
                    process.actualStart ? formatDateWithoutYear(process.actualStart) : '',
                    process.actualEnd ? formatDateWithoutYear(process.actualEnd) : '',
                    actualDays,
                    getStatusName(process.status),
                    process.remark || ''
                ]);
                
                row.height = 25;
                
                // 设置状态单元格样式
                const statusCell = row.getCell(9);
                const statusInfo = statusOptions.find(s => s.name === statusCell.value) || statusOptions[0];
                if (statusInfo.id === 'completed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F4EA' } };
                } else if (statusInfo.id === 'inProgress') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF3C7' } };
                } else if (statusInfo.id === 'delayed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
                } else if (statusInfo.id === 'pending') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEF2F7' } };
                }
                
                // 设置边框和对齐方式
                row.eachCell(cell => {
                    cell.border = getStandardBorder();
                    cell.alignment = { vertical: 'middle' };
                });
                
                // 设置水平居中的列
                [1, 3, 4, 5, 6, 7, 8, 9].forEach(colIndex => {
                    row.getCell(colIndex).alignment = { ...row.getCell(colIndex).alignment, horizontal: 'center' };
                });
                
                // 确保备注列宽为16
                worksheet.getColumn(10).width = 16;
            });
            
            // 移除了工艺流程跟踪表和周期统计之间的空行
            
            // 优化的周期统计区域 - 只保留总计划周期和总实际周期
            worksheet.addRow([]).height = 5; // 空白分隔行
            
            // 创建周期统计标题行 - 醒目样式
            const statsHeaderRow = worksheet.getRow(worksheet.rowCount + 1);
            statsHeaderRow.height = 28;
            statsHeaderRow.values = ['', '周期统计摘要', '', '', '', '', '', '', '', ''];
            statsHeaderRow.getCell(2).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            statsHeaderRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
            statsHeaderRow.getCell(2).border = getStandardBorder();
            statsHeaderRow.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.mergeCells(statsHeaderRow.number, 2, statsHeaderRow.number, 9);
            
            // 计算从开始到结束的总周期（包含所有日期，不再排除周末）
            const firstPlanStart = processData[0]?.planStart ? new Date(processData[0].planStart) : null;
            const lastPlanEnd = processData.length > 0 ? 
                new Date(processData[processData.length - 1].planEnd) : null;
            const totalPlanDuration = firstPlanStart && lastPlanEnd ? 
                calculateDaysBetween(firstPlanStart, lastPlanEnd) : 0;
                
            const firstActualStart = processData[0]?.actualStart ? new Date(processData[0].actualStart) : null;
            const lastActualEnd = processData.length > 0 && processData[processData.length - 1].actualEnd ? 
                new Date(processData[processData.length - 1].actualEnd) : null;
            const totalActualDuration = firstActualStart && lastActualEnd ? 
                calculateDaysBetween(firstActualStart, lastActualEnd) : 0;
            
            // 创建周期统计详情表格 - 只保留总计划周期和总实际周期
            const statsRows = [
                { label: "总计划周期", value: `${totalPlanDuration} 天`, color: "FF165DFF" },
                { label: "总实际周期", value: `${totalActualDuration} 天`, color: "FF27AE60" }
            ];
            
            // 添加统计数据行
            statsRows.forEach((stat, idx) => {
                const statRow = worksheet.getRow(worksheet.rowCount + 1);
                statRow.height = 24;
                
                // 标签单元格
                const labelCell = statRow.getCell(2);
                labelCell.value = stat.label;
                labelCell.font = { bold: true, size: 11 };
                labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                labelCell.border = getStandardBorder();
                labelCell.alignment = { vertical: 'middle', horizontal: 'right' };
                
                // 值单元格
                const valueCell = statRow.getCell(3);
                valueCell.value = stat.value;
                valueCell.font = { bold: true, size: 11, color: { argb: stat.color } };
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                
                // 合并值单元格到第9列，使内容更突出
                worksheet.mergeCells(statRow.number, 3, statRow.number, 9);
                
                // 为交替行添加背景色，增强可读性
                if (idx % 2 === 1) {
                    labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                    valueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                }
            });
            
            // 统一周期统计栏和工艺流程跟踪表的列宽
            const statsStartRow = statsHeaderRow.number;
            const statsEndRow = worksheet.rowCount;
            
            // 优化周期统计摘要栏的列宽
            worksheet.getColumn(1).width = 10;  // 序号列保持10
            worksheet.getColumn(2).width = 12;  // 标签列稍微加宽
            worksheet.getColumn(3).width = 15;  // 值列加宽
            for (let i = 4; i <= 10; i++) {
                worksheet.getColumn(i).width = columnWidths[i - 1];  // 其他列保持原设定
            }
            
            // 设置打印选项
            worksheet.pageSetup.printArea = `A1:J${worksheet.rowCount}`;
            worksheet.pageSetup.orientation = 'landscape';
            worksheet.pageSetup.fitToPage = true;
            worksheet.pageSetup.fitToWidth = 1;
            worksheet.pageSetup.fitToHeight = 0;
            
            // 添加页脚
            const exportDate = formatDateWithYear(new Date().toISOString().split('T')[0]);
            worksheet.headerFooter.footerCenter = `导出日期: ${exportDate} | 第 &P 页 / 共 &N 页`;
            
            // 生成Excel文件并下载
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const fileName = `模具流程跟踪_${document.getElementById('moldNumber').value || '未知编号'}_${formatDateWithYear(new Date().toISOString().split('T')[0]).replace(/年|月|日/g, '')}.xlsx`;
                saveAs(blob, fileName);
                showNotification('Excel导出成功', 'success');
            }).catch(err => {
                console.error('导出失败:', err);
                showNotification('Excel导出失败', 'error');
            });
        }
        
        // 格式化分组标题
        function formatSectionHeader(worksheet, row, startCol, endCol) {
            row.height = 25;
            row.font = { bold: true, size: 14, color: { argb: 'FF333333' } };
            row.alignment = { horizontal: 'center', vertical: 'middle' };
            row.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                cell.border = getStandardBorder();
            });
            worksheet.mergeCells(row.number, startCol, row.number, endCol);
        }
        
        // 获取标准边框样式
        function getStandardBorder() {
            return {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        }
        
        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复。')) {
                // 清空模具基本信息
                document.getElementById('moldNumber').value = '';
                document.getElementById('moldName').value = '';
                document.getElementById('moldType').value = '';
                document.getElementById('version').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('material').value = '';
                document.getElementById('cavityCount').value = '';
                document.getElementById('moldOpenNotice').value = '';
                document.getElementById('testDate').value = '';
                document.getElementById('moldRemark').value = '';
                
                // 清空工序数据
                processData = [];
                nextProcessId = 1;
                // 重置排期设置为默认值
                scheduleSettings = {
                    includeDependencies: true
                };
                
                renderProcessTable();
                updateCycleStatistics();
                
                // 清除localStorage
                localStorage.removeItem('moldTrackingData');
                
                showNotification('所有数据已清空', 'info');
            }
        }
        
        // 初始化默认工序
        function initializeDefaultProcesses() {
            if (processData.length > 0 && !confirm('确定要初始化流程吗？当前流程数据将被覆盖。')) {
                return;
            }
            
            // 获取开模通知日期作为起始日期
            const startDate = document.getElementById('moldOpenNotice').value 
                ? new Date(document.getElementById('moldOpenNotice').value)
                : new Date();
            
            // 调整后的默认工序列表
            const defaultProcesses = [
                { name: '设计评审', planDays: 2, remark: '' },
                { name: '材料采购', planDays: 3, remark: '' },
                { name: '深孔钻/铣床加工', planDays: 4, remark: '' },
                { name: '粗加工', planDays: 5, remark: '' },
                { name: '热处理/磨床加工', planDays: 2, remark: '' },
                { name: '线割加工', planDays: 3, remark: '' },
                { name: '精加工', planDays: 7, remark: '' },
                { name: 'EDM加工', planDays: 4, remark: '' },
                { name: '省模/抛光', planDays: 2, remark: '' },
                { name: '配装合模', planDays: 3, remark: '' },
                { name: '试模', planDays: 1, remark: '' }
            ];
            
            processData = [];
            let currentDate = new Date(startDate);
            
            // 应用排期初始化（包含所有日期，不再排除周末）
            const settings = {
                includeDependencies: scheduleSettings.includeDependencies
            };
            
            defaultProcesses.forEach((process) => {
                // 计算计划开始和结束日期
                const planStart = formatDate(currentDate);
                
                // 增加计划天数（包含所有日期）
                currentDate.setDate(currentDate.getDate() + process.planDays);
                
                const planEnd = formatDate(currentDate);
                
                // 添加到工序数据
                processData.push({
                    id: nextProcessId++,
                    name: process.name,
                    planStart,
                    planEnd,
                    planDays: process.planDays,
                    actualStart: '',
                    actualEnd: '',
                    actualDays: '',
                    status: 'pending',
                    remark: process.remark
                });
            });
            
            renderProcessTable();
            updateCycleStatistics();
            showNotification('流程已初始化', 'info');
        }
        
        // 添加新工序
        function addNewProcess() {
            // 默认将新工序添加到最后
            const newProcess = {
                id: nextProcessId++,
                name: `新工序${processData.length + 1}`,
                planStart: '',
                planEnd: '',
                planDays: 1,
                actualStart: '',
                actualEnd: '',
                actualDays: '',
                status: 'pending',
                remark: ''
            };
            
            // 如果有其他工序，设置新工序的计划开始日期为上一工序的计划结束日期
            if (processData.length > 0) {
                const lastProcess = processData[processData.length - 1];
                newProcess.planStart = lastProcess.planEnd;
                
                // 计算计划结束日期（包含所有日期）
                if (newProcess.planStart) {
                    const startDate = new Date(newProcess.planStart);
                    startDate.setDate(startDate.getDate() + newProcess.planDays);
                    newProcess.planEnd = formatDate(startDate);
                }
            }
            
            processData.push(newProcess);
            renderProcessTable();
            updateCycleStatistics();
            
            // 自动聚焦到新工序的名称输入框
            setTimeout(() => {
                const newInput = document.querySelector(`.process-name[data-id="${newProcess.id}"]`);
                if (newInput) {
                    newInput.focus();
                    newInput.select();
                }
            }, 100);
            
            showNotification('已添加新工序', 'info');
        }
        
        // 渲染工序表格
        function renderProcessTable() {
            processTableBody.innerHTML = '';
            
            if (processData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-folder-open-o text-2xl mb-2"></i>
                        <p>暂无工序数据，请点击"初始化流程"或"添加工序"</p>
                    </td>
                `;
                processTableBody.appendChild(emptyRow);
                return;
            }
            
            processData.forEach((process, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-bg';
                row.dataset.id = process.id;
                
                // 获取状态样式
                const statusInfo = statusOptions.find(s => s.id === process.status) || statusOptions[0];
                
                row.innerHTML = `
                    <td class="serial-number-col px-2 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900 text-center">${index + 1}</div>
                    </td>
                    <td class="process-name-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.name || ''}" 
                               class="process-name w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               maxlength="15">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <div class="date-picker-wrapper">
                            <input type="date" value="${process.planStart || ''}" 
                                   class="plan-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm pr-8"
                                   data-id="${process.id}"
                                   data-index="${index}">
                            <i class="fa fa-calendar date-picker-icon"></i>
                        </div>
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <div class="date-picker-wrapper">
                            <input type="date" value="${process.planEnd || ''}" 
                                   class="plan-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm pr-8"
                                   data-id="${process.id}"
                                   data-index="${index}">
                            <i class="fa fa-calendar date-picker-icon"></i>
                        </div>
                    </td>
                    <td class="plan-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="1" value="${process.planDays || 1}" 
                               class="plan-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <div class="date-picker-wrapper">
                            <input type="date" value="${process.actualStart || ''}" 
                                   class="actual-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm pr-8"
                                   data-id="${process.id}"
                                   data-index="${index}">
                            <i class="fa fa-calendar date-picker-icon"></i>
                        </div>
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <div class="date-picker-wrapper">
                            <input type="date" value="${process.actualEnd || ''}" 
                                   class="actual-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm pr-8"
                                   data-id="${process.id}"
                                   data-index="${index}">
                            <i class="fa fa-calendar date-picker-icon"></i>
                        </div>
                    </td>
                    <td class="actual-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="0" value="${process.actualDays || ''}" 
                               class="actual-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}">
                    </td>
                    <td class="status-col px-2 py-3 whitespace-nowrap">
                        <span class="status-badge inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.class} cursor-pointer border"
                              data-id="${process.id}" data-current="${process.status}">
                            ${statusInfo.name}
                        </span>
                    </td>
                    <td class="remark-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.remark || ''}" 
                               class="remark w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               placeholder="备注">
                    </td>
                    <td class="action-col px-2 py-3 whitespace-nowrap text-sm font-medium text-center">
                        <button class="delete-process text-danger hover:text-danger/80 mr-1 p-1" data-id="${process.id}" title="删除">
                            <i class="fa fa-trash-o"></i>
                        </button>
                        <button class="move-up text-gray-500 hover:text-primary mr-1 p-1" data-id="${process.id}" title="上移">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                        <button class="move-down text-gray-500 hover:text-primary p-1" data-id="${process.id}" title="下移">
                            <i class="fa fa-arrow-down"></i>
                        </button>
                    </td>
                `;
                
                processTableBody.appendChild(row);
            });
            
            // 添加事件监听器到动态生成的元素
            attachProcessEvents();
        }
        
        // 为工序表格元素添加事件监听器
        function attachProcessEvents() {
            // 工序名称输入
            document.querySelectorAll('.process-name').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.name = e.target.value.substring(0, 15);
                    }
                });
            });
            
            // 备注输入
            document.querySelectorAll('.remark').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.remark = e.target.value;
                    }
                });
            });
            
            // 增强日期选择器体验
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                
                wrapper.addEventListener('click', () => {
                    if (typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                });
            });
            
            // 计划开始日期 - 修改时自动计算计划结束日期和后续工序，并重新计算
            document.querySelectorAll('.plan-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planStart = e.target.value;
                        calculateAndUpdatePlanEnd(processId);
                        updateSubsequentPlans(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 计划结束日期 - 修改时自动计算计划天数和后续工序，并重新计算
            document.querySelectorAll('.plan-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planEnd = e.target.value;
                        calculateAndUpdatePlanDays(processId);
                        
                        // 修复：更新当前工序的前序工序的结束日期（如果有）
                        if (processIndex > 0) {
                            const prevProcess = processData[processIndex - 1];
                            if (prevProcess && (!prevProcess.planEnd || new Date(prevProcess.planEnd) > new Date(process.planStart))) {
                                prevProcess.planEnd = process.planStart;
                                calculateAndUpdatePlanDays(prevProcess.id);
                                updateSubsequentPlans(processIndex - 1);
                            }
                        }
                        
                        updateSubsequentPlans(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 计划天数 - 修改时自动计算计划结束日期和后续工序，并重新计算
            document.querySelectorAll('.plan-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const days = parseInt(e.target.value) || 1;
                        process.planDays = days;
                        calculateAndUpdatePlanEnd(processId);
                        updateSubsequentPlans(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 实际开始日期 - 修改时自动计算实际结束日期和后续工序，并重新计算
            document.querySelectorAll('.actual-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualStart = e.target.value;
                        
                        // 修复：更新当前工序的前序工序的实际结束日期（如果有）
                        if (processIndex > 0) {
                            const prevProcess = processData[processIndex - 1];
                            if (prevProcess && (!prevProcess.actualEnd || new Date(prevProcess.actualEnd) > new Date(process.actualStart))) {
                                prevProcess.actualEnd = process.actualStart;
                                calculateAndUpdateActualDays(prevProcess.id);
                            }
                        }
                        
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 实际结束日期 - 修改时自动计算实际天数和后续工序，并重新计算
            document.querySelectorAll('.actual-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualEnd = e.target.value;
                        calculateAndUpdateActualDays(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 实际天数 - 修改时自动计算实际结束日期和后续工序，并重新计算
            document.querySelectorAll('.actual-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const days = parseInt(e.target.value) || 0;
                        process.actualDays = days;
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 状态标签点击切换
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const currentStatus = e.target.dataset.current;
                    const currentIndex = statusOptions.findIndex(s => s.id === currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOptions.length;
                    const nextStatus = statusOptions[nextIndex].id;
                    
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.status = nextStatus;
                        renderProcessTable();
                        updateCycleStatistics();
                    }
                });
            });
            
            // 删除工序
            document.querySelectorAll('.delete-process').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    if (confirm('确定要删除此工序吗？后续工序将自动调整。')) {
                        const processIndex = processData.findIndex(p => p.id === processId);
                        processData = processData.filter(p => p.id !== processId);
                        
                        // 如果删除的不是最后一个工序，需要调整后续工序
                        if (processIndex < processData.length) {
                            // 找到前一个工序
                            const prevProcess = processIndex > 0 ? processData[processIndex - 1] : null;
                            // 获取下一个工序
                            const nextProcess = processData[processIndex];
                            
                            // 更新下一个工序的开始日期
                            if (prevProcess && nextProcess) {
                                // 更新计划日期
                                if (prevProcess.planEnd) {
                                    nextProcess.planStart = prevProcess.planEnd;
                                    calculateAndUpdatePlanEnd(nextProcess.id);
                                }
                                
                                // 更新实际日期
                                if (prevProcess.actualEnd) {
                                    nextProcess.actualStart = prevProcess.actualEnd;
                                    calculateAndUpdateActualEnd(nextProcess.id);
                                }
                            }
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        showNotification('工序已删除，后续工序已自动调整', 'info');
                    }
                });
            });
            
            // 上移工序
            document.querySelectorAll('.move-up').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index > 0) {
                        // 交换位置
                        [processData[index], processData[index - 1]] = [processData[index - 1], processData[index]];
                        
                        // 调整受影响的工序日期
                        if (index - 1 > 0) {
                            // 更新上一个工序的后续
                            updateSubsequentPlans(index - 2);
                            updateSubsequentActuals(index - 2);
                        } else {
                            // 如果上移到第一个位置，从第一个工序开始更新后续
                            updateSubsequentPlans(index - 1);
                            updateSubsequentActuals(index - 1);
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 下移工序
            document.querySelectorAll('.move-down').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index < processData.length - 1) {
                        // 交换位置
                        [processData[index], processData[index + 1]] = [processData[index + 1], processData[index]];
                        
                        // 调整受影响的工序日期
                        updateSubsequentPlans(index - 1);
                        updateSubsequentActuals(index - 1);
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
        }
        
        // 更新后续工序的计划日期
        function updateSubsequentPlans(startIndex) {
            const settings = {
                includeDependencies: scheduleSettings.includeDependencies
            };
            
            // 从startIndex + 1开始更新所有后续工序
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // 设置当前工序的计划开始日期为前一工序的计划结束日期
                if (prevProcess.planEnd) {
                    currentProcess.planStart = prevProcess.planEnd;
                    
                    // 根据计划开始日期和计划天数计算计划结束日期
                    calculateAndUpdatePlanEnd(currentProcess.id);
                }
            }
        }
        
        // 更新后续工序的实际日期
        function updateSubsequentActuals(startIndex) {
            // 从startIndex + 1开始更新所有后续工序
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // 设置当前工序的实际开始日期为前一工序的实际结束日期
                if (prevProcess.actualEnd) {
                    currentProcess.actualStart = prevProcess.actualEnd;
                    
                    // 根据实际开始日期和实际天数计算实际结束日期
                    calculateAndUpdateActualEnd(currentProcess.id);
                }
            }
        }
        
        // 计算并更新计划结束日期（包含所有日期）
        function calculateAndUpdatePlanEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planDays || process.planDays <= 0) return;
            
            let startDate = new Date(process.planStart);
            if (isNaN(startDate.getTime())) return;
            
            // 增加计划天数（包含所有日期）
            startDate.setDate(startDate.getDate() + process.planDays);
            
            const formattedEndDate = formatDate(startDate);
            process.planEnd = formattedEndDate;
            
            // 直接更新输入框
            const endInput = document.querySelector(`.plan-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // 计算并更新计划天数（包含所有日期）
        function calculateAndUpdatePlanDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planEnd) return;
            
            const startDate = new Date(process.planStart);
            const endDate = new Date(process.planEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // 计算总天数（包含所有日期）
            const days = calculateDaysBetween(startDate, endDate);
            
            process.planDays = days;
            
            // 直接更新输入框
            const daysInput = document.querySelector(`.plan-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // 计算并更新实际结束日期（包含所有日期）
        function calculateAndUpdateActualEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || process.actualDays === undefined || process.actualDays <= 0) return;
            
            let startDate = new Date(process.actualStart);
            if (isNaN(startDate.getTime())) return;
            
            // 增加实际天数（包含所有日期）
            startDate.setDate(startDate.getDate() + process.actualDays);
            
            const formattedEndDate = formatDate(startDate);
            process.actualEnd = formattedEndDate;
            
            // 直接更新输入框
            const endInput = document.querySelector(`.actual-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // 计算并更新实际天数（包含所有日期）
        function calculateAndUpdateActualDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || !process.actualEnd) return;
            
            const startDate = new Date(process.actualStart);
            const endDate = new Date(process.actualEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // 计算总天数（包含所有日期）
            const days = calculateDaysBetween(startDate, endDate);
            
            process.actualDays = days;
            
            // 直接更新输入框
            const daysInput = document.querySelector(`.actual-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // 格式化日期为YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 格式化日期为X月XX日（不含年份）
        function formatDateWithoutYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${month}月${day}日`;
            }
            return dateStr;
        }
        
        // 格式化日期为YYYY年X月XX日（包含年份）
        function formatDateWithYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${year}年${month}月${day}日`;
            }
            return dateStr;
        }
        
        // 获取状态名称
        function getStatusName(statusId) {
            const status = statusOptions.find(s => s.id === statusId);
            return status ? status.name : '未知';
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            let bgColor, textColor, icon;
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-success';
                    textColor = 'text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-danger';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-warning';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-primary';
                    textColor = 'text-white';
                    icon = 'fa-info-circle';
            }
            
            notification.className = `fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 flex items-center z-50 ${bgColor} ${textColor}`;
            notification.innerHTML = `<i class="fa ${icon} mr-2"></i>${message}`;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(calc(100% + 20px))';
            }, 3000);
        }
    </script>
</body>
</html>
