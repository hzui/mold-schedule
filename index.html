<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å…·åˆ¶é€ å·¥è‰ºæµç¨‹è·Ÿè¸ªç³»ç»Ÿ</title>
    <!-- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        pending: '#94a3b8',
                        neutral: '#64748b',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-bg {
                transition: background-color 0.3s ease;
            }
            .transition-transform {
                transition: transform 0.2s ease;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
            }
            .process-name-col {
                width: 150px;
                min-width: 150px;
            }
            .date-col {
                width: 75px;
                min-width: 75px;
            }
            .plan-days-col, .actual-days-col {
                width: 80px;
                min-width: 80px;
            }
            .remark-col {
                min-width: 140px;
            }
            .serial-number-col {
                width: 50px;
                min-width: 50px;
            }
            .status-col {
                width: 85px;
                min-width: 85px;
            }
            .action-col {
                width: 90px;
                min-width: 90px;
            }
            .status-badge {
                transition: all 0.2s ease;
            }
            .status-badge:hover {
                transform: scale(1.05);
            }
            input[type="date"] {
                position: relative;
            }
            input[type="date"]::-webkit-calendar-picker-indicator {
                background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat center;
                background-size: 16px 16px;
                padding: 8px;
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                opacity: 0.7;
            }
            
            input[type="date"]::-webkit-calendar-picker-indicator:hover {
                opacity: 1;
            }
            
            /* ç¡®ä¿æ—¥æœŸè¾“å…¥æ¡†å®Œå…¨å¯ç”¨ */
            input[type="date"] {
                -webkit-appearance: none;
                -moz-appearance: textfield;
                appearance: none;
                background: white;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                padding: 8px 40px 8px 12px;
                font-size: 14px;
                line-height: 1.5;
                color: #374151;
            }
            
            input[type="date"]:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            /* ä¿®å¤Firefoxæ—¥æœŸé€‰æ‹©å™¨ */
            input[type="date"]::-moz-focus-inner {
                border: 0;
                padding: 0;
            }
            .date-picker-wrapper {
                position: relative;
            }
            /* ä¼˜åŒ–çš„ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
            .stat-card {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                border: 1px solid #e2e8f0;
            }
            .stat-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                opacity: 0.8;
                transition: opacity 0.3s ease;
            }
            .stat-card.primary::before {
                background: linear-gradient(to bottom, #3b82f6, #2563eb);
            }
            .stat-card.success::before {
                background: linear-gradient(to bottom, #10b981, #059669);
            }
            .stat-card.warning::before {
                background: linear-gradient(to bottom, #f59e0b, #d97706);
            }
            .stat-card.danger::before {
                background: linear-gradient(to bottom, #ef4444, #dc2626);
            }
            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            }
            .stat-card:hover::before {
                opacity: 1;
            }
            .stat-value {
                transition: all 0.5s ease-out;
                display: inline-block;
                letter-spacing: -0.5px;
            }
            .stat-card:hover .stat-value {
                transform: scale(1.05);
            }
            .stat-container {
                position: relative;
                z-index: 10;
            }
            .floating-bg {
                position: absolute;
                width: 150px;
                height: 150px;
                border-radius: 50%;
                background-color: rgba(22, 93, 255, 0.08);
                top: -75px;
                right: -75px;
                transition: all 0.5s ease;
            }
            .stat-card:hover .floating-bg {
                transform: scale(1.8);
            }
            .stat-card.success .floating-bg {
                background-color: rgba(39, 174, 96, 0.08);
            }
            .stat-card.warning .floating-bg {
                background-color: rgba(245, 158, 11, 0.08);
            }
            .stat-card.danger .floating-bg {
                background-color: rgba(229, 62, 62, 0.08);
            }
            .stat-trend {
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                margin-top: 2px;
                font-weight: 500;
            }
            .trend-up {
                color: #E53E3E;
            }
            .trend-down {
                color: #27AE60;
            }
            /* æ’æœŸå†²çªæç¤ºæ ·å¼ */
            .conflict-highlight {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { background-color: rgba(229, 62, 62, 0.1); }
                50% { background-color: rgba(229, 62, 62, 0.2); }
                100% { background-color: rgba(229, 62, 62, 0.1); }
            }
            /* ç°ä»£åšå®¢é£æ ¼å¯¼èˆªæ ·å¼ */
            .nav-btn.active {
                background-color: #3b82f6;
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
                transform: translateY(-1px);
            }
            
            .nav-btn.active:hover {
                background-color: #2563eb;
                color: white;
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
                transform: translateY(-1.5px);
            }
            
            /* æ¯›ç»ç’ƒæ•ˆæœ */
            .backdrop-blur-md {
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }
            
            /* æ¸å˜èƒŒæ™¯ */
            .bg-gradient-to-br {
                background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
            }
            
            .bg-gradient-to-r {
                background-image: linear-gradient(to right, var(--tw-gradient-stops));
            }
            
            .from-blue-500 {
                --tw-gradient-from: #3b82f6;
                --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0));
            }
            
            .to-purple-600 {
                --tw-gradient-to: #9333ea;
            }
            
            .from-blue-50 {
                --tw-gradient-from: #eff6ff;
                --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0));
            }
            
            .to-purple-50 {
                --tw-gradient-to: #faf5ff;
            }
            
            /* LogoåŠ¨ç”»æ•ˆæœ */
            .logo-animation {
                animation: logoFloat 3s ease-in-out infinite;
            }
            
            @keyframes logoFloat {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-3px); }
            }
            
            /* å¯¼èˆªæŒ‰é’®æ‚¬åœæ•ˆæœ */
            .nav-btn {
                position: relative;
                overflow: hidden;
                border-radius: 12px;
            }
            
            .nav-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
                transition: left 0.4s ease;
            }
            
            .nav-btn:hover::before {
                left: 100%;
            }
            /* é¡µé¢åˆ‡æ¢æ ·å¼ */
            .page-content {
                display: none;
            }
            .page-content.active {
                display: block;
            }
            /* æ¨¡å…·å¡ç‰‡æ ·å¼ */
            .mold-card {
                transition: all 0.3s ease;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                overflow: hidden;
            }
            .mold-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }
            .mold-status {
                display: inline-flex;
                align-items: center;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
            }
            .status-active {
                background-color: #dcfce7;
                color: #166534;
            }
            .status-completed {
                background-color: #dbeafe;
                color: #1e40af;
            }
            .status-pending {
                background-color: #fef3c7;
                color: #92400e;
            }
            
            /* æ–‡æœ¬å¯¹é½æ–¹å¼ */
            .text-left { text-align: left; }
            .text-center { text-align: center; }
            .text-right { text-align: right; }
            .text-justify { text-align: justify; }
            
            /* æ¨¡å…·å¡ç‰‡ç»†èŠ‚ä¼˜åŒ– */
            .mold-card-details {
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            
            .mold-card-details:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                transform: translateY(-1px);
            }
            
            .detail-label {
                font-weight: 500;
                color: #64748b;
                width: 60px;
                flex-shrink: 0;
            }
            
            .detail-value {
                color: #1e293b;
                font-weight: 500;
                flex: 1;
                min-width: 0;
            }
            
            .process-status-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-right: 6px;
            }
            
            .process-status-pending { background-color: #f59e0b; }
            .process-status-progress { background-color: #3b82f6; }
            .process-status-completed { background-color: #10b981; }
            
            /* å¡ç‰‡æ’ç‰ˆä¼˜åŒ– */
            .card-section {
                background-color: #f8fafc;
                border-radius: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .card-section-title {
                font-size: 0.75rem;
                font-weight: 600;
                color: #475569;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }
            
            /* é¡µé¢å¸ƒå±€ä¼˜åŒ– */
            body {
                min-height: 100vh;
                display: flex;
                background-color: #f1f5f9;
            }
            
            /* ä¾§è¾¹æ æ ·å¼ - ä¸è¡¨æ ¼é£æ ¼åè°ƒ */
            .sidebar {
                width: 240px;
                min-width: 240px;
                background: white;
                border-right: 1px solid #e2e8f0;
                display: flex;
                flex-direction: column;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            
            .sidebar-header {
                padding: 1.5rem 1.25rem;
                border-bottom: 1px solid #e2e8f0;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                position: relative;
            }
            
            .sidebar-header::before {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: linear-gradient(to right, #3b82f6, #2563eb);
            }
            
            .sidebar-title {
                font-size: 1.125rem;
                font-weight: 700;
                color: #1e293b;
                margin: 0;
                letter-spacing: -0.025em;
            }
            
            .sidebar-subtitle {
                font-size: 0.75rem;
                color: #64748b;
                margin-top: 0.25rem;
                font-weight: 500;
            }
            
            .sidebar-nav {
                flex: 1;
                padding: 1.5rem 0;
            }
            
            .nav-section {
                margin-bottom: 1.5rem;
            }
            
            .nav-section-title {
                padding: 0 1.25rem 0.5rem;
                font-size: 0.75rem;
                font-weight: 600;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .sidebar-nav-item {
                display: flex;
                align-items: center;
                width: 100%;
                padding: 0.875rem 1.25rem;
                text-align: left;
                color: #64748b;
                font-size: 0.875rem;
                font-weight: 500;
                border: none;
                background: none;
                cursor: pointer;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
                position: relative;
                margin: 0.125rem 0;
            }
            
            .sidebar-nav-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                width: 0;
                height: 100%;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                transition: width 0.3s ease;
                z-index: 1;
            }
            
            .sidebar-nav-item .nav-icon {
                width: 20px;
                height: 20px;
                margin-right: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 6px;
                background: #f1f5f9;
                color: #64748b;
                font-size: 0.75rem;
                transition: all 0.3s ease;
                position: relative;
                z-index: 2;
            }
            
            .sidebar-nav-item .nav-text {
                position: relative;
                z-index: 2;
                transition: all 0.3s ease;
            }
            
            .sidebar-nav-item:hover {
                background-color: #f8fafc;
                color: #3b82f6;
                transform: translateX(2px);
            }
            
            .sidebar-nav-item:hover::before {
                width: 3px;
            }
            
            .sidebar-nav-item:hover .nav-icon {
                background: #dbeafe;
                color: #3b82f6;
                transform: scale(1.1);
            }
            
            .sidebar-nav-item.active {
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                color: #1e40af;
                border-left-color: #3b82f6;
                font-weight: 600;
                transform: translateX(2px);
            }
            
            .sidebar-nav-item.active::before {
                width: 3px;
            }
            
            .sidebar-nav-item.active .nav-icon {
                background: #3b82f6;
                color: white;
                transform: scale(1.1);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }
            
            /* ä¸åŒåŠŸèƒ½ç±»å‹çš„é¢œè‰²åŒºåˆ† */
            .nav-section.main-functions .sidebar-nav-item .nav-icon {
                background: #dbeafe;
                color: #3b82f6;
            }
            
            .nav-section.main-functions .sidebar-nav-item:hover .nav-icon {
                background: #3b82f6;
                color: white;
            }
            
            .nav-section.project-management .sidebar-nav-item .nav-icon {
                background: #dcfce7;
                color: #16a34a;
            }
            
            .nav-section.project-management .sidebar-nav-item:hover .nav-icon {
                background: #16a34a;
                color: white;
            }
            
            .nav-section.operation-tools .sidebar-nav-item .nav-icon {
                background: #fef3c7;
                color: #d97706;
            }
            
            .nav-section.operation-tools .sidebar-nav-item:hover .nav-icon {
                background: #d97706;
                color: white;
            }
            
            .nav-section.cycle-stats .stat-icon:first-child {
                background: #dbeafe !important;
                color: #3b82f6 !important;
            }
            
            .nav-section.cycle-stats .stat-icon:last-child {
                background: #dcfce7 !important;
                color: #16a34a !important;
            }
            
            .sidebar-footer {
                padding: 1rem 1.25rem;
                border-top: 1px solid #e2e8f0;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            }
            
            .sidebar-footer-text {
                font-size: 0.75rem;
                color: #64748b;
                text-align: center;
                line-height: 1.4;
            }
            
            .footer-main-text {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
                font-size: 0.8rem;
                color: #1e293b;
            }
            
            .footer-sub-text {
                font-size: 0.7rem;
                color: #64748b;
                margin-bottom: 0.75rem;
                line-height: 1.3;
            }
            
            .footer-tips {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;
                font-size: 0.65rem;
                color: #94a3b8;
                padding: 0.4rem 0.6rem;
                background: rgba(255, 255, 255, 0.6);
                border-radius: 6px;
                border: 1px solid #e2e8f0;
            }
            
            /* ä¸»å†…å®¹åŒºåŸŸ */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                background: #f8fafc;
            }
            
            .content-header {
                background: white;
                border-bottom: 1px solid #e2e8f0;
                padding: 1.25rem 2rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            
            .content-header-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1e293b;
                margin: 0;
                display: flex;
                align-items: center;
            }
            
            .content-header-icon {
                width: 24px;
                height: 24px;
                margin-right: 0.75rem;
                background: #3b82f6;
                color: white;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.875rem;
            }
            
            .content-body {
                flex: 1;
                padding: 2rem;
                overflow-x: auto;
            }
            
            /* é¢åŒ…å±‘å¯¼èˆª */
            .breadcrumb {
                display: flex;
                align-items: center;
                margin-top: 0.5rem;
                font-size: 0.875rem;
                color: #64748b;
            }
            
            .breadcrumb-item {
                display: flex;
                align-items: center;
            }
            
            .breadcrumb-item:not(:last-child)::after {
                content: 'â€º';
                margin: 0 0.5rem;
                color: #cbd5e1;
            }
            
            .breadcrumb-home {
                color: #3b82f6;
                text-decoration: none;
            }
            
            .breadcrumb-home:hover {
                text-decoration: underline;
            }
            
            /* ä¾§è¾¹æ ç»Ÿè®¡æ ·å¼ */
            .sidebar-stats {
                padding: 0 1.25rem;
            }
            
            .stat-item {
                display: flex;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .stat-item:last-child {
                border-bottom: none;
            }
            
            .stat-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 0.75rem;
                font-size: 0.875rem;
                flex-shrink: 0;
            }
            
            .stat-item:first-child .stat-icon {
                background: #dbeafe;
                color: #3b82f6;
            }
            
            .stat-item:last-child .stat-icon {
                background: #dcfce7;
                color: #16a34a;
            }
            
            .stat-content {
                flex: 1;
                min-width: 0;
            }
            
            .stat-label {
                font-size: 0.75rem;
                color: #64748b;
                font-weight: 500;
                margin-bottom: 0.125rem;
            }
            
            .stat-value {
                font-size: 0.875rem;
                font-weight: 600;
                color: #1e293b;
            }
            
            /* ç¡®ä¿é¡µé¢å†…å®¹åŒºåŸŸæœ‰æœ€å°é«˜åº¦ */
            .page-content {
                min-height: calc(100vh - 200px);
            }
            
            /* å¯è°ƒæ•´åˆ—å®½çš„è¡¨æ ¼æ ·å¼ */
            .resizable-table {
                table-layout: fixed;
                width: 100%;
            }
            
            .resizable-table th {
                position: relative;
                user-select: none;
            }
            
            .resizable-table th:not(:last-child) {
                border-right: 1px solid #e2e8f0;
            }
            
            .column-resizer {
                position: absolute;
                top: 0;
                right: 0;
                width: 4px;
                height: 100%;
                cursor: col-resize;
                background: transparent;
                z-index: 10;
            }
            
            .column-resizer:hover {
                background: #3b82f6;
            }
            
            .column-resizer.resizing {
                background: #3b82f6;
            }
            
            /* æ°´å°æ ·å¼ */
            .watermark {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 48px;
                color: rgba(0, 0, 0, 0.05);
                font-weight: bold;
                pointer-events: none;
                z-index: 1;
                user-select: none;
                white-space: nowrap;
            }
        }
        
        
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen">
    <!-- å·¦ä¾§è¾¹æ  -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">æ¨¡å…·åˆ¶é€ è·Ÿè¸ªç³»ç»Ÿ</h1>
            <p class="sidebar-subtitle">Mold Manufacturing Tracking</p>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section main-functions">
                <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                <button id="navManagement" class="sidebar-nav-item active">
                    <div class="nav-icon">
                        <i class="fa fa-th-large"></i>
                    </div>
                    <span class="nav-text">æ¨¡å…·ç®¡ç†</span>
                </button>
                <button id="navTracking" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-tasks"></i>
                    </div>
                    <span class="nav-text">æµç¨‹è·Ÿè¸ª</span>
                </button>
            </div>
            
            <div class="nav-section project-management">
                <div class="nav-section-title">é¡¹ç›®ç®¡ç†</div>
                <button id="createNewMoldSidebar" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-plus-circle"></i>
                    </div>
                    <span class="nav-text">æ–°å»ºæ¨¡å…·é¡¹ç›®</span>
                </button>
            </div>
            
            <div class="nav-section operation-tools">
                <div class="nav-section-title">æ“ä½œå·¥å…·</div>
                <button id="saveBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-save"></i>
                    </div>
                    <span class="nav-text">ä¿å­˜æ•°æ®</span>
                </button>
                <button id="addBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-plus"></i>
                    </div>
                    <span class="nav-text">æ·»åŠ å·¥åº</span>
                </button>
                <button id="recalculateBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-refresh"></i>
                    </div>
                    <span class="nav-text">é‡æ–°è®¡ç®—</span>
                </button>
                <button id="exportBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                    <span class="nav-text">å¯¼å‡ºExcel</span>
                </button>
                <button id="clearBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-trash"></i>
                    </div>
                    <span class="nav-text">æ¸…ç©ºæ•°æ®</span>
                </button>
                <button id="initBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-cogs"></i>
                    </div>
                    <span class="nav-text">åˆå§‹åŒ–æµç¨‹</span>
                </button>
            </div>
            
            <div class="nav-section cycle-stats">
                <div class="nav-section-title">å‘¨æœŸç»Ÿè®¡</div>
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fa fa-clock-o"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">æ€»è®¡åˆ’å‘¨æœŸ</div>
                            <div class="stat-value">
                                <span id="sidebarPlanDays">0</span> å¤©
                            </div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">æ€»å®é™…å‘¨æœŸ</div>
                            <div class="stat-value">
                                <span id="sidebarActualDays">0</span> å¤©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-footer-text">
                <div class="footer-main-text">
                    <i class="fa fa-shield text-blue-500"></i>
                    <strong>ä»…ä¾›å†…éƒ¨ä½¿ç”¨</strong>
                </div>
                <div class="footer-sub-text">
                    æ¨¡å…·åˆ¶é€ å·¥è‰ºæµç¨‹è·Ÿè¸ªç³»ç»Ÿ<br>
                    æ™ºèƒ½åŒ–ç®¡ç† Â· ç²¾å‡†åŒ–æ§åˆ¶ Â· é«˜æ•ˆåŒ–åä½œ
                </div>
            </div>
        </div>
    </aside>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- æ°´å° -->
        <div class="watermark">å†…éƒ¨ä½¿ç”¨ INTERNAL USE</div>
        <main class="content-body">
        <!-- æ¨¡å…·ç®¡ç†é¡µé¢ -->
        <div id="managementPage" class="page-content active">
            <!-- ä¼˜åŒ–çš„æ ‡é¢˜åŒºåŸŸ -->
            <section class="mb-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- æ ‡é¢˜æ  -->
                    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-semibold text-gray-800">æ¨¡å…·ä¿¡æ¯ç®¡ç†</h2>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯æ  -->
                    <div class="px-6 py-3 bg-white border-b border-gray-200">
                        <div class="grid grid-cols-4 gap-6 text-sm">
                            <div class="text-center">
                                <div class="text-lg font-semibold text-gray-800" id="totalMoldsCount">0</div>
                                <div class="text-gray-600">æ€»é¡¹ç›®æ•°</div>
                            </div>
                            <div class="text-center border-l border-gray-200">
                                <div class="text-lg font-semibold text-orange-600" id="activeMoldsCount">0</div>
                                <div class="text-gray-600">è¿›è¡Œä¸­</div>
                            </div>
                            <div class="text-center border-l border-gray-200">
                                <div class="text-lg font-semibold text-green-600" id="completedMoldsCount">0</div>
                                <div class="text-gray-600">å·²å®Œæˆ</div>
                            </div>
                            <div class="text-center border-l border-gray-200">
                                <div class="text-lg font-semibold text-gray-600" id="pendingMoldsCount">0</div>
                                <div class="text-gray-600">å¾…å¼€å§‹</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ä¼˜åŒ–çš„æœç´¢ç­›é€‰åŒºåŸŸ -->
            <section class="mb-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex flex-col lg:flex-row gap-4">
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="text" id="searchMolds" placeholder="æœç´¢æ¨¡å…·ç¼–å·ã€åç§°ã€äº§å“æˆ–ææ–™..." 
                                           class="w-full px-4 py-2 border border-gray-300 text-sm focus:border-blue-500 focus:outline-none bg-white rounded-lg pl-10">
                                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <select id="statusFilter" class="px-3 py-2 border border-gray-300 text-sm focus:border-blue-500 focus:outline-none bg-white min-w-[120px] rounded-lg">
                                    <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                    <option value="pending">å¾…å¼€å§‹</option>
                                    <option value="active">è¿›è¡Œä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                </select>
                                <button id="refreshMolds" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition-colors rounded-lg flex items-center">
                                    <i class="fa fa-refresh mr-1"></i>åˆ·æ–°
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¼˜åŒ–çš„å¿«é€Ÿç­›é€‰å·¥å…·æ  -->
                    <div class="px-6 py-3 bg-white border-b border-gray-200">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="text-sm text-gray-600 font-medium">å¿«é€Ÿç­›é€‰:</span>
                            <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition-colors rounded-lg" data-filter="today">
                                ä»Šæ—¥æ›´æ–°
                            </button>
                            <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition-colors rounded-lg" data-filter="week">
                                æœ¬å‘¨åˆ›å»º
                            </button>
                            <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition-colors rounded-lg" data-filter="completed">
                                å…¨éƒ¨å®Œæˆ
                            </button>
                            <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition-colors rounded-lg" data-filter="urgent">
                                å³å°†è¯•æ¨¡ <span id="upcomingTestCount" class="ml-1 px-1.5 py-0.5 text-xs bg-orange-100 text-orange-600 rounded-full">0</span>
                            </button>
                            <div class="ml-auto text-sm text-gray-500">
                                å…± <span id="filteredCount">0</span> æ¡è®°å½•
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç´§å‡‘çš„æ¨¡å…·å¡ç‰‡åˆ—è¡¨ -->
            <section class="mb-6">
                <!-- æ¨¡å…·å¡ç‰‡ç½‘æ ¼ - èŒåœºæ ‡å‡†å¸ƒå±€ -->
                <div id="moldsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3">
                    <!-- æ¨¡å…·å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div id="emptyState" class="text-center py-12 hidden">
                    <div class="text-gray-400 mb-3">
                        <div class="text-4xl mb-2">ğŸ­</div>
                    </div>
                    <h3 class="text-lg font-medium text-gray-600 mb-2">è¿˜æ²¡æœ‰æ¨¡å…·é¡¹ç›®</h3>
                    <p class="text-gray-500 text-sm">ä½¿ç”¨ä¾§æ çš„"æ–°å»ºæ¨¡å…·é¡¹ç›®"å¼€å§‹åˆ›å»º</p>
                </div>
            </section>
        </div>

        <!-- æµç¨‹è·Ÿè¸ªé¡µé¢ -->
        <div id="trackingPage" class="page-content">
        <!-- ä¼˜åŒ–çš„æ¨¡å…·åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
        <section class="mb-6 bg-white rounded-2xl p-6 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md">
            <div class="mb-4 pb-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    æ¨¡å…·åŸºæœ¬ä¿¡æ¯
                </h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- ç¬¬ä¸€è¡Œï¼š5ä¸ªè¾“å…¥é¡¹ -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å…·ç¼–å·</label>
                    <input type="text" id="moldNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å…·åç§°</label>
                    <input type="text" id="moldName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å…·ç±»å‹</label>
                    <input type="text" id="moldType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç‰ˆæœ¬å·</label>
                    <input type="text" id="version" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“åç§°</label>
                    <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼š5ä¸ªè¾“å…¥é¡¹ -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“ææ–™</label>
                    <input type="text" id="material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç©´æ•°</label>
                    <input type="number" id="cavityCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¼€æ¨¡é€šçŸ¥</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="moldOpenNotice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯•æ¨¡æ—¥æœŸ</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="testDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                    <textarea id="moldRemark" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="è¾“å…¥å…¶ä»–ä¿¡æ¯..."></textarea>
                </div>
            </div>
        </section>
        

        
        <!-- ä¼˜åŒ–çš„å·¥è‰ºæµç¨‹è·Ÿè¸ªè¡¨ -->
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md">
            <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    å·¥è‰ºæµç¨‹è·Ÿè¸ªè¡¨
                </h2>
                <div class="ml-auto flex items-center text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span>å¯æ‹–æ‹½è°ƒæ•´åˆ—å®½</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="processTable" class="resizable-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="serial-number-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 60px;">
                                åºå·
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="process-name-col px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="width: 150px;">
                                å·¥åºåç§°
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                è®¡åˆ’å¼€å§‹
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                è®¡åˆ’ç»“æŸ
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="plan-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 80px;">
                                è®¡åˆ’å¤©æ•°
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                å®é™…å¼€å§‹
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                å®é™…ç»“æŸ
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="actual-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 80px;">
                                å®é™…å¤©æ•°
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="status-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 85px;">
                                çŠ¶æ€
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="remark-col px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 140px;">
                                å¤‡æ³¨
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="action-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 120px;">
                                æ“ä½œ
                            </th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-500">
                æ“ä½œæç¤ºï¼šç‚¹å‡»çŠ¶æ€æ ‡ç­¾å¯åˆ‡æ¢å·¥åºçŠ¶æ€ï¼Œä¿®æ”¹æ—¥æœŸæˆ–å¤©æ•°ä¼šè‡ªåŠ¨è®¡ç®—å…³è”å€¼
            </div>
        </section>
        </div> <!-- ç»“æŸæµç¨‹è·Ÿè¸ªé¡µé¢ -->
        </main>
    </div>
    
    <!-- é€šçŸ¥æç¤ºç»„ä»¶ -->
    <div id="notification" class="fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center z-50"></div>

    <script>
        // å…¨å±€å˜é‡
        let processData = [];
        let nextProcessId = 1;
        let scheduleSettings = {
            includeDependencies: true // ä»…ä¿ç•™å·¥åºä¾èµ–å…³ç³»è®¾ç½®
        };
        let autoSaveTimer = null;
        let isCalculating = false; // é˜²æ­¢é‡å¤è®¡ç®—
        
        // æ¨¡å…·ç®¡ç†ç›¸å…³å˜é‡
        let moldsData = [];
        let currentMoldId = null;
        let nextMoldId = 1;
        let currentPage = 'management'; // 'management' æˆ– 'tracking'
        
        // DOMå…ƒç´ 
        const processTableBody = document.getElementById('processTableBody');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const initBtn = document.getElementById('initBtn');
        const addBtn = document.getElementById('addBtn');
        const recalculateBtn = document.getElementById('recalculateBtn'); // é‡æ–°è®¡ç®—æŒ‰é’®
        const notification = document.getElementById('notification');

        
        // æ¨¡å…·ç®¡ç†DOMå…ƒç´ 
        const navManagement = document.getElementById('navManagement');
        const navTracking = document.getElementById('navTracking');
        const managementPage = document.getElementById('managementPage');
        const trackingPage = document.getElementById('trackingPage');
        const moldsListElement = document.getElementById('moldsList');
        const emptyState = document.getElementById('emptyState');
        const createNewMold = document.getElementById('createNewMold');
        const searchMolds = document.getElementById('searchMolds');
        const statusFilter = document.getElementById('statusFilter');
        const refreshMolds = document.getElementById('refreshMolds');
        
        // çŠ¶æ€é€‰é¡¹
        const statusOptions = [
            { id: 'pending', name: 'æœªå¼€å§‹', class: 'bg-pending/20 text-pending border border-pending/30' },
            { id: 'inProgress', name: 'è¿›è¡Œä¸­', class: 'bg-warning/20 text-warning border border-warning/30' },
            { id: 'completed', name: 'å·²å®Œæˆ', class: 'bg-success/20 text-success border border-success/30' },
            { id: 'delayed', name: 'å·²å»¶è¿Ÿ', class: 'bg-danger/20 text-danger border border-danger/30' }
        ];
        
        // åˆå§‹åŒ– - å¢å¼ºç‰ˆ
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadMoldsData();
            
            // å¦‚æœæ²¡æœ‰æ¨¡å…·æ•°æ®ï¼Œåˆ›å»ºä¸€äº›æ¼”ç¤ºæ•°æ®
            if (moldsData.length === 0) {
                createDemoMoldsData();
            }
            
            setupEventListeners();
            setupMoldManagementListeners();
            updateCycleStatistics();
            
            // æ ¹æ®currentPageæ˜¾ç¤ºå¯¹åº”çš„é¡µé¢
            if (currentPage === 'management') {
                switchPage('management');
            } else {
                switchPage('tracking');
            }
            
            // è‡ªåŠ¨åŒæ­¥å½“å‰ç¼–è¾‘çš„æ•°æ®åˆ°æ¨¡å…·ç®¡ç†
            if (processData.length > 0) {
                setTimeout(() => {
                    autoSaveWithSync();
                }, 500);
            }
            
            // æ£€æŸ¥åˆå§‹æ•°æ®ä¸­çš„æ’æœŸå†²çª
            setTimeout(() => {
                const conflicts = checkScheduleConflicts();
                if (conflicts.length > 0) {
                    highlightConflicts(conflicts);
                    showNotification(`æ£€æµ‹åˆ° ${conflicts.length} å¤„æ’æœŸå†²çªï¼Œè¯·æ£€æŸ¥æ•°æ®`, 'warning');
                }
            }, 1000);
            
            // æ˜¾ç¤ºæ¬¢è¿æç¤º
            setTimeout(() => {
                if (processData.length === 0) {
                    showNotification('æ¬¢è¿ä½¿ç”¨æ¨¡å…·åˆ¶é€ è·Ÿè¸ªç³»ç»Ÿï¼ç‚¹å‡»"åˆå§‹åŒ–æµç¨‹"å¼€å§‹', 'info');
                }
            }, 2000);
        });
        
        // åˆ›å»ºæ¼”ç¤ºæ¨¡å…·æ•°æ®
        function createDemoMoldsData() {
            const demoProcesses1 = [
                { id: 1, name: 'è®¾è®¡è¯„å®¡', planStart: '2024-01-01', planEnd: '2024-01-02', planDays: 2, actualStart: '2024-01-01', actualEnd: '2024-01-02', actualDays: 2, status: 'completed', remark: 'å›¾çº¸å®¡æ ¸å®Œæˆ' },
                { id: 2, name: 'ææ–™é‡‡è´­', planStart: '2024-01-03', planEnd: '2024-01-05', planDays: 3, actualStart: '2024-01-03', actualEnd: '', actualDays: '', status: 'inProgress', remark: 'é’¢æé‡‡è´­ä¸­' },
                { id: 3, name: 'CNCç²—åŠ å·¥', planStart: '2024-01-06', planEnd: '2024-01-10', planDays: 5, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' }
            ];
            
            const demoProcesses2 = [
                { id: 1, name: 'è®¾è®¡è¯„å®¡', planStart: '2024-01-15', planEnd: '2024-01-16', planDays: 2, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' },
                { id: 2, name: 'ææ–™é‡‡è´­', planStart: '2024-01-17', planEnd: '2024-01-19', planDays: 3, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' }
            ];
            
            moldsData = [
                {
                    id: 1,
                    moldNumber: 'MD001',
                    moldName: 'æ‰‹æœºå¤–å£³æ¨¡å…·',
                    moldType: 'æ³¨å¡‘æ¨¡',
                    productName: 'æ‰‹æœºå¤–å£³',
                    material: 'ABS',
                    status: 'active',
                    progress: 50,
                    currentProcess: 'ææ–™é‡‡è´­',
                    totalDays: 10,
                    completedDays: 2,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    processes: demoProcesses1
                },
                {
                    id: 2,
                    moldNumber: 'MD002',
                    moldName: 'æ±½è½¦é…ä»¶æ¨¡å…·',
                    moldType: 'å‹é“¸æ¨¡',
                    productName: 'æ±½è½¦é…ä»¶',
                    material: 'é“åˆé‡‘',
                    status: 'pending',
                    progress: 0,
                    currentProcess: 'å¾…å¼€å§‹: è®¾è®¡è¯„å®¡',
                    totalDays: 5,
                    completedDays: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    processes: demoProcesses2
                }
            ];
            nextMoldId = 3;
            saveMoldsData();
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¾§è¾¹æ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const sidebarSaveBtn = document.getElementById('saveBtn');
            const sidebarExportBtn = document.getElementById('exportBtn');
            const sidebarClearBtn = document.getElementById('clearBtn');
            const sidebarInitBtn = document.getElementById('initBtn');
            const sidebarAddBtn = document.getElementById('addBtn');
            const sidebarRecalculateBtn = document.getElementById('recalculateBtn');
            
            if (sidebarSaveBtn) sidebarSaveBtn.addEventListener('click', saveData);
            if (sidebarExportBtn) sidebarExportBtn.addEventListener('click', exportToExcel);
            if (sidebarClearBtn) sidebarClearBtn.addEventListener('click', clearAllData);
            if (sidebarInitBtn) sidebarInitBtn.addEventListener('click', initializeDefaultProcesses);
            if (sidebarAddBtn) sidebarAddBtn.addEventListener('click', addNewProcess);
            if (sidebarRecalculateBtn) sidebarRecalculateBtn.addEventListener('click', recalculateSchedule);
            
            // å¯¼èˆªåˆ‡æ¢äº‹ä»¶
            navManagement.addEventListener('click', () => switchPage('management'));
            navTracking.addEventListener('click', () => switchPage('tracking'));
            
            // ä¾§è¾¹æ æ–°å»ºæ¨¡å…·é¡¹ç›®æŒ‰é’®
            const createNewMoldSidebar = document.getElementById('createNewMoldSidebar');
            if (createNewMoldSidebar) {
                createNewMoldSidebar.addEventListener('click', createNewMoldProject);
            }
            
            // ä¸ºæ—¥æœŸé€‰æ‹©å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                
                wrapper.addEventListener('click', () => {
                    if (typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                });
            });
        }
        
        // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹æ“ä½œ
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // é‡æ–°è®¡ç®—æ’æœŸ - æ™ºèƒ½è®¡ç®—æ‰€æœ‰å·¥åºçš„æ—¥æœŸå’Œå¤©æ•°
        function recalculateSchedule() {
            if (processData.length === 0) {
                showNotification('è¯·å…ˆæ·»åŠ å·¥åºå†è¿›è¡Œè®¡ç®—', 'warning');
                return;
            }
            
            try {
                // æ‰§è¡Œæ™ºèƒ½å…¨é‡é‡æ–°è®¡ç®—
                performIntelligentRecalculation();
                
                // æ£€æŸ¥æ’æœŸå†²çª
                const conflicts = checkScheduleConflicts();
                if (conflicts.length > 0) {
                    highlightConflicts(conflicts);
                    showNotification(`æ’æœŸå·²é‡æ–°è®¡ç®—ï¼Œæ£€æµ‹åˆ° ${conflicts.length} å¤„éœ€è¦æ³¨æ„çš„é—®é¢˜`, 'warning');
                } else {
                    showNotification('æ’æœŸå·²é‡æ–°è®¡ç®—å®Œæˆ', 'success');
                }
                
                // æ›´æ–°ç•Œé¢
                renderProcessTable();
                updateCycleStatistics();
                
                // ä¿å­˜å½“å‰æ•°æ®
                saveData();
                
            } catch (error) {
                console.error('é‡æ–°è®¡ç®—æ’æœŸæ—¶å‡ºé”™:', error);
                showNotification('é‡æ–°è®¡ç®—æ’æœŸå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®', 'error');
            }
        }

        // æ‰§è¡Œæ™ºèƒ½å…¨é‡é‡æ–°è®¡ç®—
        function performIntelligentRecalculation() {
            if (processData.length === 0) return;
            
            // 1. ç¡®å®šèµ·å§‹æ—¥æœŸ
            let startDate = getCalculationStartDate();
            
            // 2. ä¸ºç¬¬ä¸€ä¸ªå·¥åºè®¾ç½®å¼€å§‹æ—¥æœŸ
            processData[0].planStart = startDate;
            
            // 3. è‡ªåŠ¨å¡«å……åˆç†çš„é»˜è®¤å¤©æ•°ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            autoFillDefaultDays();
            
            // 4. æ™ºèƒ½è®¡ç®—æ‰€æœ‰å·¥åºçš„æ—¥æœŸ
            calculateAllProcessDates();
            
            // 5. é‡æ–°è®¡ç®—æ‰€æœ‰ç»“æŸæ—¥æœŸ
            recalculateAllEndDates();
            
            // 6. åŒæ­¥æ•°æ®åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨
            syncToMoldManagement();
        }

        // è·å–è®¡ç®—èµ·å§‹æ—¥æœŸ
        function getCalculationStartDate() {
            // ä¼˜å…ˆçº§ï¼šç¬¬ä¸€ä¸ªå·¥åºçš„è®¡åˆ’å¼€å§‹æ—¥æœŸ > å¼€æ¨¡é€šçŸ¥æ—¥æœŸ > å½“å‰æ—¥æœŸ
            if (processData.length > 0 && processData[0].planStart) {
                return processData[0].planStart;
            }
            
            const moldOpenNotice = document.getElementById('moldOpenNotice').value;
            if (moldOpenNotice) {
                return moldOpenNotice;
            }
            
            return formatDate(new Date());
        }

        // è®¡ç®—æ‰€æœ‰å·¥åºçš„æ—¥æœŸ
        function calculateAllProcessDates() {
            for (let i = 0; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå·¥åºï¼Œæ ¹æ®å‰ä¸€å·¥åºè®¡ç®—å¼€å§‹æ—¥æœŸ
                if (i > 0 && prevProcess) {
                    if (prevProcess.planEnd) {
                        // å‰ä¸€å·¥åºæœ‰ç»“æŸæ—¥æœŸï¼Œä¸‹ä¸€å·¥åºä»ç»“æŸæ—¥æœŸçš„ä¸‹ä¸€å¤©å¼€å§‹
                        const nextStartDate = new Date(prevProcess.planEnd);
                        nextStartDate.setDate(nextStartDate.getDate() + 1);
                        currentProcess.planStart = formatDate(nextStartDate);
                    } else if (prevProcess.planStart) {
                        // å‰ä¸€å·¥åºåªæœ‰å¼€å§‹æ—¥æœŸï¼Œå‡è®¾1å¤©å·¥æœŸ
                        const nextStartDate = new Date(prevProcess.planStart);
                        nextStartDate.setDate(nextStartDate.getDate() + 1);
                        currentProcess.planStart = formatDate(nextStartDate);
                    }
                }
                
                // å¦‚æœå½“å‰å·¥åºæœ‰è®¡åˆ’å¤©æ•°ï¼Œè®¡ç®—ç»“æŸæ—¥æœŸ
                if (currentProcess.planStart && currentProcess.planDays && currentProcess.planDays > 0) {
                    calculateAndUpdatePlanEnd(currentProcess.id);
                }
            }
        }

        // è‡ªåŠ¨å¡«å……åˆç†çš„é»˜è®¤å¤©æ•°
        function autoFillDefaultDays() {
            const defaultDaysMap = {
                'è®¾è®¡è¯„å®¡': 2,
                'ææ–™é‡‡è´­': 3,
                'æ·±å­”é’»/é“£åºŠåŠ å·¥': 4,
                'CNCç²—åŠ å·¥': 5,
                'çƒ­å¤„ç†/ç£¨åºŠåŠ å·¥': 2,
                'çº¿å‰²åŠ å·¥': 3,
                'CNCç²¾åŠ å·¥': 7,
                'EDMåŠ å·¥': 4,
                'çœæ¨¡/æŠ›å…‰': 2,
                'é…è£…åˆæ¨¡': 3,
                'è¯•æ¨¡': 1
            };
            
            processData.forEach(process => {
                // åªä¸ºæ²¡æœ‰å¤©æ•°æˆ–å¤©æ•°ä¸º0çš„å·¥åºè‡ªåŠ¨å¡«å……
                if (!process.planDays || process.planDays === '' || process.planDays === 0) {
                    const defaultDays = defaultDaysMap[process.name] || 2; // é»˜è®¤2å¤©
                    process.planDays = defaultDays;
                }
            });
        }

        // é‡æ–°è®¡ç®—æ‰€æœ‰ç»“æŸæ—¥æœŸ
        function recalculateAllEndDates() {
            processData.forEach(process => {
                if (process.planStart && process.planDays && process.planDays > 0) {
                    calculateAndUpdatePlanEnd(process.id);
                }
            });
        }
        
        // åˆ›å»ºé˜²æŠ–ç‰ˆæœ¬çš„é‡æ–°è®¡ç®—å‡½æ•°
        const debouncedRecalculate = debounce(recalculateSchedule, 300);
        
        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
                saveData();
            }, 2000); // 2ç§’åè‡ªåŠ¨ä¿å­˜
        }
        
        // ä¼˜åŒ–çš„æ•°æ®æ›´æ–°å‡½æ•°ï¼Œé¿å…é‡å¤è®¡ç®—
        function updateProcessData(processId, field, value, skipRecalculate = false) {
            const process = processData.find(p => p.id === processId);
            if (!process) return;
            
            process[field] = value;
            
            if (!skipRecalculate && !isCalculating) {
                isCalculating = true;
                setTimeout(() => {
                    debouncedRecalculate();
                    isCalculating = false;
                }, 100);
            }
            
            scheduleAutoSave();
        }
        
        // æ£€æŸ¥æ’æœŸå†²çª
        function checkScheduleConflicts() {
            const conflicts = [];
            
            // æ£€æŸ¥å·¥åºé—´çš„æ—¥æœŸå†²çª
            for (let i = 1; i < processData.length; i++) {
                const current = processData[i];
                const prev = processData[i - 1];
                
                // æ£€æŸ¥è®¡åˆ’æ—¥æœŸå†²çª
                if (current.planStart && prev.planEnd && 
                    new Date(current.planStart) < new Date(prev.planEnd)) {
                    conflicts.push({
                        type: 'plan',
                        index: i,
                        message: `å·¥åº ${i+1} çš„è®¡åˆ’å¼€å§‹æ—¥æœŸæ—©äºå·¥åº ${i} çš„è®¡åˆ’ç»“æŸæ—¥æœŸ`
                    });
                }
                
                // æ£€æŸ¥å®é™…æ—¥æœŸå†²çª
                if (current.actualStart && prev.actualEnd && 
                    new Date(current.actualStart) < new Date(prev.actualEnd)) {
                    conflicts.push({
                        type: 'actual',
                        index: i,
                        message: `å·¥åº ${i+1} çš„å®é™…å¼€å§‹æ—¥æœŸæ—©äºå·¥åº ${i} çš„å®é™…ç»“æŸæ—¥æœŸ`
                    });
                }
                
                // æ£€æŸ¥å®é™…æ—¥æœŸæ˜¯å¦è¶…è¿‡è®¡åˆ’æ—¥æœŸ
                if (current.actualEnd && current.planEnd && 
                    new Date(current.actualEnd) > new Date(current.planEnd) &&
                    current.status === 'completed') {
                    conflicts.push({
                        type: 'delay',
                        index: i,
                        message: `å·¥åº ${i+1} å®é™…å®Œæˆæ—¥æœŸè¶…è¿‡è®¡åˆ’æ—¥æœŸ`
                    });
                }
                
                // æ£€æŸ¥è®¡åˆ’å¤©æ•°æ˜¯å¦ä¸ºæœ‰æ•ˆå€¼
                if (current.planDays && current.planDays <= 0) {
                    conflicts.push({
                        type: 'invalid',
                        index: i,
                        message: `å·¥åº ${i+1} çš„è®¡åˆ’å¤©æ•°å¿…é¡»å¤§äº0`
                    });
                }
                
                // æ£€æŸ¥å®é™…å¤©æ•°æ˜¯å¦è¶…è¿‡è®¡åˆ’å¤©æ•°ï¼ˆä»…å¯¹å·²å®Œæˆå·¥åºï¼‰
                if (current.actualDays && current.planDays && 
                    current.actualDays > current.planDays &&
                    current.status === 'completed') {
                    conflicts.push({
                        type: 'overrun',
                        index: i,
                        message: `å·¥åº ${i+1} å®é™…å¤©æ•°è¶…è¿‡è®¡åˆ’å¤©æ•°`
                    });
                }
            }
            
            // æ£€æŸ¥ç¬¬ä¸€ä¸ªå·¥åºæ˜¯å¦æœ‰è®¡åˆ’å¼€å§‹æ—¥æœŸ
            if (processData.length > 0 && !processData[0].planStart) {
                conflicts.push({
                    type: 'missing',
                    index: 0,
                    message: 'ç¬¬ä¸€ä¸ªå·¥åºç¼ºå°‘è®¡åˆ’å¼€å§‹æ—¥æœŸ'
                });
            }
            
            return conflicts;
        }
        
        // é«˜äº®æ˜¾ç¤ºå†²çª
        function highlightConflicts(conflicts) {
            conflicts.forEach(conflict => {
                const row = document.querySelector(`tr[data-id="${processData[conflict.index].id}"]`);
                if (row) {
                    row.classList.add('conflict-highlight');
                    
                    // 5ç§’åç§»é™¤é«˜äº®
                    setTimeout(() => {
                        row.classList.remove('conflict-highlight');
                    }, 5000);
                }
            });
        }
        
        // æ’æœŸç®—æ³• - ä¸å†æ’é™¤å‘¨æœ«
        function scheduleProcesses(startDate, settings) {
            let currentDate = new Date(startDate);
            
            for (let i = 0; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // å¤„ç†å·²å®Œæˆå·¥åº
                if (currentProcess.status === 'completed') {
                    // è·³è¿‡å·²å®Œæˆå·¥åº
                    if (currentProcess.actualEnd) {
                        currentDate = new Date(currentProcess.actualEnd);
                    } else if (currentProcess.planEnd) {
                        currentDate = new Date(currentProcess.planEnd);
                    }
                    continue;
                }
                
                // å¦‚æœè€ƒè™‘ä¾èµ–å…³ç³»ï¼Œå½“å‰å·¥åºçš„è®¡åˆ’å¼€å§‹æ—¥æœŸåº”ä¸ºå‰åºå·¥åºçš„è®¡åˆ’ç»“æŸæ—¥æœŸ
                if (settings.includeDependencies && prevProcess && prevProcess.planEnd) {
                    currentDate = new Date(prevProcess.planEnd);
                }
                
                currentProcess.planStart = formatDate(currentDate);
                
                // è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼Œä¸å†æ’é™¤å‘¨æœ«ï¼‰
                if (currentProcess.planDays && currentProcess.planDays > 0) {
                    // å¢åŠ è®¡åˆ’å¤©æ•°å‡1ï¼ˆå› ä¸ºåŒ…å«å½“å¤©ï¼‰
                    // å¦‚æœè®¡åˆ’å¤©æ•°ä¸º1ï¼Œåˆ™ç»“æŸæ—¥æœŸä¸å¼€å§‹æ—¥æœŸç›¸åŒ
                    if (currentProcess.planDays > 1) {
                        currentDate.setDate(currentDate.getDate() + currentProcess.planDays - 1);
                    }
                    currentProcess.planEnd = formatDate(currentDate);
                }
            }
        }
        
        // æ›´æ–°å‘¨æœŸç»Ÿè®¡
        function updateCycleStatistics() {
            // è®¡ç®—è®¡åˆ’æ€»å‘¨æœŸ
            const planStarts = processData.map(p => p.planStart).filter(d => d);
            const planEnds = processData.map(p => p.planEnd).filter(d => d);
            
            let totalPlanDays = 0;
            if (planStarts.length > 0 && planEnds.length > 0) {
                const firstPlanStart = new Date(Math.min(...planStarts.map(d => new Date(d).getTime())));
                const lastPlanEndDate = new Date(Math.max(...planEnds.map(d => new Date(d).getTime())));
                totalPlanDays = calculateDaysBetween(firstPlanStart, lastPlanEndDate);
            }
            
            // è®¡ç®—å®é™…æ€»å‘¨æœŸ
            const actualStarts = processData.map(p => p.actualStart).filter(d => d);
            const actualEnds = processData.map(p => p.actualEnd).filter(d => d);
            
            let totalActualDays = 0;
            if (actualStarts.length > 0 && actualEnds.length > 0) {
                const firstActualStart = new Date(Math.min(...actualStarts.map(d => new Date(d).getTime())));
                const lastActualEndDate = new Date(Math.max(...actualEnds.map(d => new Date(d).getTime())));
                totalActualDays = calculateDaysBetween(firstActualStart, lastActualEndDate);
            }
            
            // æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡æ•°æ®
            const sidebarPlanDays = document.getElementById('sidebarPlanDays');
            const sidebarActualDays = document.getElementById('sidebarActualDays');
            
            if (sidebarPlanDays) {
                animateValue(sidebarPlanDays, parseInt(sidebarPlanDays.textContent) || 0, totalPlanDays, 500);
            }
            if (sidebarActualDays) {
                animateValue(sidebarActualDays, parseInt(sidebarActualDays.textContent) || 0, totalActualDays, 500);
            }
        }
        
        // ç²¾ç¡®è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°ï¼ˆåŒ…å«å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼‰
        function calculateDaysBetween(startDate, endDate) {
            // ç¡®ä¿æ—¥æœŸå¯¹è±¡æœ‰æ•ˆ
            if (!(startDate instanceof Date) || !(endDate instanceof Date) || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return 0;
            }
            
            // å¦‚æœå¼€å§‹æ—¥æœŸæ™šäºç»“æŸæ—¥æœŸï¼Œè¿”å›0
            if (startDate > endDate) {
                return 0;
            }
            
            // æ ‡å‡†åŒ–æ—¥æœŸåˆ°å½“å¤©çš„å¼€å§‹æ—¶é—´ï¼Œé¿å…æ—¶åŒºå’Œæ—¶é—´å·®å¼‚
            const normalizedStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const normalizedEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            // è®¡ç®—æ—¶é—´å·®ï¼ˆæ¯«ç§’ï¼‰
            const timeDiff = normalizedEnd.getTime() - normalizedStart.getTime();
            
            // è½¬æ¢ä¸ºå¤©æ•°å¹¶åŠ 1ä»¥åŒ…å«å½“å¤©
            return Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
        }
        
        // æ•°å­—å˜åŒ–åŠ¨ç”»
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°ä½¿åŠ¨ç”»æ›´è‡ªç„¶
                const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                element.textContent = Math.floor(easeProgress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // åŠ è½½æ•°æ®
        function loadData() {
            const savedData = localStorage.getItem('moldTrackingData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    processData = data.processes || [];
                    nextProcessId = data.nextId || 1;
                    
                    // åŠ è½½æ¨¡å…·åŸºæœ¬ä¿¡æ¯
                    if (data.moldInfo) {
                        Object.keys(data.moldInfo).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data.moldInfo[key];
                            }
                        });
                    }
                    
                    // åŠ è½½æ’æœŸè®¾ç½®ï¼ˆç§»é™¤å‘¨æœ«æ’é™¤ç›¸å…³ï¼‰
                    if (data.scheduleSettings) {
                        scheduleSettings.includeDependencies = data.scheduleSettings.includeDependencies !== undefined 
                            ? data.scheduleSettings.includeDependencies 
                            : true;
                    }
                    
                    renderProcessTable();
                    updateCycleStatistics();
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œå°†åˆå§‹åŒ–æ–°æ•°æ®', 'error');
                    initializeDefaultProcesses();
                }
            } else {
                initializeDefaultProcesses();
            }
        }
        
        // ä¿å­˜æ•°æ®
        function saveData() {
            try {
                // éªŒè¯æ•°æ®
                const validationErrors = validateProcessData();
                if (validationErrors.length > 0) {
                    showNotification(`æ•°æ®éªŒè¯å¤±è´¥ï¼š${validationErrors[0]}`, 'warning');
                    return false;
                }
                
                // æ”¶é›†æ¨¡å…·åŸºæœ¬ä¿¡æ¯
                const moldInfo = {
                    moldNumber: document.getElementById('moldNumber').value.trim(),
                    moldName: document.getElementById('moldName').value.trim(),
                    moldType: document.getElementById('moldType').value.trim(),
                    version: document.getElementById('version').value.trim(),
                    productName: document.getElementById('productName').value.trim(),
                    material: document.getElementById('material').value.trim(),
                    cavityCount: document.getElementById('cavityCount').value.trim(),
                    moldOpenNotice: document.getElementById('moldOpenNotice').value,
                    testDate: document.getElementById('testDate').value,
                    moldRemark: document.getElementById('moldRemark').value.trim()
                };
                
                // ä¿å­˜åˆ°localStorage
                const dataToSave = {
                    moldInfo,
                    processes: processData,
                    nextId: nextProcessId,
                    scheduleSettings: scheduleSettings,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('moldTrackingData', JSON.stringify(dataToSave));
                
                // åŒæ­¥æ•°æ®åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨
                syncToMoldManagement(moldInfo, processData);
                
                showNotification('æ•°æ®ä¿å­˜æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showNotification('ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                return false;
            }
        }

        // åŒæ­¥æ•°æ®åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨ï¼ˆå¢å¼ºç‰ˆï¼‰
        function syncToMoldManagement(moldInfo, processes) {
            try {
                // å³ä½¿æ²¡æœ‰å®Œæ•´ä¿¡æ¯ä¹Ÿè¦å°è¯•åŒæ­¥ï¼Œåˆ›å»ºä¸´æ—¶è®°å½•
                const moldNumber = moldInfo.moldNumber || `TEMP_${Date.now()}`;
                const moldName = moldInfo.moldName || 'æœªå‘½åæ¨¡å…·';
                
                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç¼–å·çš„æ¨¡å…·
                let existingMold = moldsData.find(m => m.moldNumber === moldNumber);
                
                if (existingMold) {
                    // æ›´æ–°ç°æœ‰æ¨¡å…·ä¿¡æ¯
                    existingMold.moldName = moldName;
                    existingMold.moldType = moldInfo.moldType || '';
                    existingMold.version = moldInfo.version || '';
                    existingMold.productName = moldInfo.productName || '';
                    existingMold.material = moldInfo.material || '';
                    existingMold.cavityCount = moldInfo.cavityCount || '';
                    existingMold.moldOpenNotice = moldInfo.moldOpenNotice || '';
                    existingMold.testDate = moldInfo.testDate || '';
                    existingMold.moldRemark = moldInfo.moldRemark || '';
                    existingMold.processes = JSON.parse(JSON.stringify(processes)); // æ·±æ‹·è´
                    existingMold.updatedAt = new Date().toISOString();
                    
                    // æ ¹æ®å·¥åºçŠ¶æ€æ›´æ–°æ¨¡å…·çŠ¶æ€å’Œè¿›åº¦ä¿¡æ¯
                    existingMold.status = calculateMoldStatus(processes);
                    existingMold.progress = calculateMoldProgress(processes);
                    existingMold.currentProcess = getCurrentProcessName(processes);
                    existingMold.totalDays = calculateTotalPlanDays(processes);
                    existingMold.completedDays = calculateCompletedDays(processes);
                    
                    console.log('æ›´æ–°ç°æœ‰æ¨¡å…·:', existingMold.moldNumber);
                } else {
                    // åˆ›å»ºæ–°æ¨¡å…·è®°å½•
                    const newMold = {
                        id: nextMoldId++,
                        moldNumber: moldNumber,
                        moldName: moldName,
                        moldType: moldInfo.moldType || '',
                        version: moldInfo.version || '',
                        productName: moldInfo.productName || '',
                        material: moldInfo.material || '',
                        cavityCount: moldInfo.cavityCount || '',
                        moldOpenNotice: moldInfo.moldOpenNotice || '',
                        testDate: moldInfo.testDate || '',
                        moldRemark: moldInfo.moldRemark || '',
                        status: calculateMoldStatus(processes),
                        progress: calculateMoldProgress(processes),
                        currentProcess: getCurrentProcessName(processes),
                        totalDays: calculateTotalPlanDays(processes),
                        completedDays: calculateCompletedDays(processes),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        processes: JSON.parse(JSON.stringify(processes)) // æ·±æ‹·è´
                    };
                    
                    moldsData.push(newMold);
                    console.log('åˆ›å»ºæ–°æ¨¡å…·:', newMold.moldNumber);
                }
                
                // ä¿å­˜æ¨¡å…·æ•°æ®
                saveMoldsData();
                
                // å®æ—¶æ›´æ–°æ¨¡å…·ç®¡ç†åˆ—è¡¨æ˜¾ç¤º
                updateMoldManagementDisplay();
                
                return true;
            } catch (error) {
                console.error('åŒæ­¥åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨å¤±è´¥:', error);
                return false;
            }
        }

        // æ›´æ–°æ¨¡å…·ç®¡ç†æ˜¾ç¤º
        function updateMoldManagementDisplay() {
            // å¦‚æœå½“å‰åœ¨æ¨¡å…·ç®¡ç†é¡µé¢ï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨
            if (managementPage && managementPage.style.display !== 'none') {
                renderMoldsList();
            }
            
            // æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡ä¿¡æ¯
            updateSidebarStats();
        }

        // æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡ä¿¡æ¯
        function updateSidebarStats() {
            const totalMolds = moldsData.length;
            const activeMolds = moldsData.filter(m => m.status === 'active').length;
            const completedMolds = moldsData.filter(m => m.status === 'completed').length;
            
            // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤ºçš„ç»Ÿè®¡æ•°æ®
            const statsElement = document.querySelector('.sidebar-stats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <div class="text-xs text-gray-500 mt-2">
                        æ€»æ¨¡å…·: ${totalMolds} | è¿›è¡Œä¸­: ${activeMolds} | å·²å®Œæˆ: ${completedMolds}
                    </div>
                `;
            }
        }

        // æ ¹æ®å·¥åºçŠ¶æ€è®¡ç®—æ¨¡å…·çŠ¶æ€
        function calculateMoldStatus(processes) {
            if (!processes || processes.length === 0) {
                return 'pending';
            }
            
            const completedCount = processes.filter(p => p.status === 'completed').length;
            const inProgressCount = processes.filter(p => p.status === 'inProgress').length;
            const delayedCount = processes.filter(p => p.status === 'delayed').length;
            
            if (completedCount === processes.length) {
                return 'completed';
            } else if (delayedCount > 0) {
                return 'delayed';
            } else if (inProgressCount > 0 || completedCount > 0) {
                return 'active';
            } else {
                return 'pending';
            }
        }
        
        // å¯¼å‡ºåˆ°Excel
        function exportToExcel() {
            if (processData.length === 0) {
                showNotification('æ²¡æœ‰å·¥åºæ•°æ®å¯å¯¼å‡º', 'warning');
                return;
            }
            
            // éªŒè¯æ•°æ®å®Œæ•´æ€§
            const validationErrors = validateProcessData();
            if (validationErrors.length > 0) {
                if (!confirm(`å‘ç°æ•°æ®é—®é¢˜ï¼š${validationErrors[0]}\n\næ˜¯å¦ä»è¦ç»§ç»­å¯¼å‡ºï¼Ÿ`)) {
                    return;
                }
            }
            
            try {
                showNotification('æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶...', 'info');
                
                // åˆ›å»ºå·¥ä½œç°¿
                const workbook = new ExcelJS.Workbook();
            workbook.creator = 'æ¨¡å…·åˆ¶é€ ç³»ç»Ÿ';
            workbook.lastModifiedBy = 'ç³»ç»Ÿç”¨æˆ·';
            workbook.created = new Date();
            workbook.modified = new Date();
            
            // æ·»åŠ å·¥ä½œè¡¨
            const worksheet = workbook.addWorksheet('æ¨¡å…·åˆ¶é€ æµç¨‹è·Ÿè¸ª');
            
            // å®šä¹‰åˆ—å®½è®¾ç½® - æ‰€æœ‰æ—¥æœŸåˆ—å®½ä¿æŒä¸€è‡´
            const columnWidths = [10, 15, 15, 15, 10, 15, 15, 10, 10, 20]; // åºå·åˆ—å®½è®¾ç½®ä¸º10ï¼Œå·¥åºåç§°åˆ—å®½è®¾ç½®ä¸º15ï¼Œæ—¥æœŸåˆ—å®½è®¾ç½®ä¸º15ï¼Œå¤‡æ³¨åˆ—å®½è®¾ç½®ä¸º20
            worksheet.columns = columnWidths.map((width, index) => ({
                width,
                key: String.fromCharCode(65 + index)
            }));
            
            // æ·»åŠ æ ‡é¢˜è¡Œ
            const titleText = `æ¨¡å…·åˆ¶é€ æµç¨‹è·Ÿè¸ªè¡¨ - ${document.getElementById('moldName').value || 'æœªå‘½å'}`;
            const titleRow = worksheet.addRow([titleText]);
            titleRow.height = 35;
            titleRow.font = { bold: true, size: 20, color: { argb: 'FF165DFF' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
            worksheet.mergeCells('A1:J1');
            
            // æ¨¡å…·åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
            const basicInfoHeader = worksheet.addRow(['æ¨¡å…·åŸºæœ¬ä¿¡æ¯']);
            formatSectionHeader(worksheet, basicInfoHeader, 1, 10);
            
            // ç¬¬ä¸€è¡Œï¼šæ¨¡å…·ç¼–å·ã€æ¨¡å…·åç§°ã€æ¨¡å…·ç±»å‹ã€ç‰ˆæœ¬å·ã€äº§å“åç§°
            let rowNum = worksheet.rowCount + 1;
            const firstRow = worksheet.getRow(rowNum);
            firstRow.height = 25;
            
            const firstRowItems = [
                { label: 'æ¨¡å…·ç¼–å·', id: 'moldNumber', width: 10 }, // æ¨¡å…·ç¼–å·åˆ—å®½è®¾ç½®ä¸º10
                { label: 'æ¨¡å…·åç§°', id: 'moldName', width: 10 }, // æ¨¡å…·åç§°åˆ—å®½è®¾ç½®ä¸º10
                { label: 'æ¨¡å…·ç±»å‹', id: 'moldType', width: 10 },
                { label: 'ç‰ˆæœ¬å·', id: 'version', width: 10 },
                { label: 'äº§å“åç§°', id: 'productName', width: 20 }
            ];
            
            firstRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // æ ‡é¢˜å•å…ƒæ ¼
                const cell = firstRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // ä¿¡æ¯å•å…ƒæ ¼
                const valueCell = firstRow.getCell(cellIndex + 1);
                valueCell.value = value;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // ç¬¬äºŒè¡Œï¼šäº§å“ææ–™ã€ç©´æ•°ã€å¼€æ¨¡é€šçŸ¥ã€è¯•æ¨¡æ—¥æœŸã€å¤‡æ³¨
            rowNum = worksheet.rowCount + 1;
            const secondRow = worksheet.getRow(rowNum);
            secondRow.height = 25;
            
            const secondRowItems = [
                { label: 'äº§å“ææ–™', id: 'material', width: 10 }, // ææ–™åˆ—å®½è®¾ç½®ä¸º10
                { label: 'ç©´æ•°', id: 'cavityCount', width: 10 }, // ç©´æ•°åˆ—å®½è®¾ç½®ä¸º10
                { label: 'å¼€æ¨¡é€šçŸ¥', id: 'moldOpenNotice', width: 10 },
                { label: 'è¯•æ¨¡æ—¥æœŸ', id: 'testDate', width: 10 },
                { label: 'å¤‡æ³¨', id: 'moldRemark', width: 20 }
            ];
            
            secondRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // æ‰€æœ‰æ—¥æœŸéƒ½ä½¿ç”¨ä¸å¸¦å¹´ä»½çš„æ ¼å¼
                let displayValue;
                if (item.id.includes('Date') || item.id === 'moldOpenNotice') {
                    displayValue = value ? formatDateWithoutYear(value) : '';
                } else {
                    displayValue = value;
                }
                
                // æ ‡é¢˜å•å…ƒæ ¼
                const cell = secondRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // ä¿¡æ¯å•å…ƒæ ¼
                const valueCell = secondRow.getCell(cellIndex + 1);
                valueCell.value = displayValue;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // æ·»åŠ å·¥åºè¡¨å¤´ï¼ˆç§»é™¤å¤šä½™ç©ºç™½è¡Œï¼‰
            const headerRow = worksheet.addRow([
                'åºå·', 'å·¥åºåç§°', 'è®¡åˆ’å¼€å§‹', 'è®¡åˆ’ç»“æŸ', 
                'è®¡åˆ’å¤©æ•°', 'å®é™…å¼€å§‹', 'å®é™…ç»“æŸ', 'å®é™…å¤©æ•°', 'çŠ¶æ€', 'å¤‡æ³¨'
            ]);
            headerRow.height = 30;
            headerRow.eachCell(cell => {
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
                cell.border = {
                    top: { style: 'medium' },
                    left: { style: 'medium' },
                    bottom: { style: 'medium' },
                    right: { style: 'medium' }
                };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
            });
            
            // é‡ç½®æ•°æ®åˆ—å®½ï¼Œç¡®ä¿æ‰€æœ‰æ—¥æœŸåˆ—å®½åº¦ä¸€è‡´
            [3, 4, 6, 7].forEach(colIndex => {
                worksheet.getColumn(colIndex).width = 10;
            });
            
            // è®¡ç®—æ€»è®¡åˆ’å¤©æ•°å’Œæ€»å®é™…å¤©æ•°
            let totalPlanDays = 0;
            let totalActualDays = 0;
            
            // æ·»åŠ å·¥åºæ•°æ®
            processData.forEach((process, index) => {
                // ç´¯åŠ å„å·¥åºçš„è®¡åˆ’å¤©æ•°å’Œå®é™…å¤©æ•°
                const planDays = process.planDays ? parseInt(process.planDays) : 0;
                const actualDays = process.actualDays ? parseInt(process.actualDays) : 0;
                totalPlanDays += planDays;
                totalActualDays += actualDays;
                
                // ç¡®ä¿è®¡åˆ’ç»“æŸæ—¥æœŸæ­£ç¡®æ˜¾ç¤º
                const planEndDate = process.planEnd ? formatDateWithoutYear(process.planEnd) : '';
                
                const row = worksheet.addRow([
                    index + 1,
                    process.name || '',
                    process.planStart ? formatDateWithoutYear(process.planStart) : '',
                    planEndDate,
                    planDays,
                    process.actualStart ? formatDateWithoutYear(process.actualStart) : '',
                    process.actualEnd ? formatDateWithoutYear(process.actualEnd) : '',
                    actualDays,
                    getStatusName(process.status),
                    process.remark || ''
                ]);
                
                row.height = 25;
                
                // è®¾ç½®çŠ¶æ€å•å…ƒæ ¼æ ·å¼
                const statusCell = row.getCell(9);
                const statusInfo = statusOptions.find(s => s.name === statusCell.value) || statusOptions[0];
                if (statusInfo.id === 'completed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F4EA' } };
                } else if (statusInfo.id === 'inProgress') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF3C7' } };
                } else if (statusInfo.id === 'delayed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
                } else if (statusInfo.id === 'pending') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEF2F7' } };
                }
                
                // è®¾ç½®è¾¹æ¡†å’Œå¯¹é½æ–¹å¼
                row.eachCell(cell => {
                    cell.border = getStandardBorder();
                    cell.alignment = { vertical: 'middle' };
                });
                
                // è®¾ç½®æ°´å¹³å±…ä¸­çš„åˆ—
                [1, 3, 4, 5, 6, 7, 8, 9].forEach(colIndex => {
                    row.getCell(colIndex).alignment = { ...row.getCell(colIndex).alignment, horizontal: 'center' };
                });
                
                // ç¡®ä¿å¤‡æ³¨åˆ—å®½ä¸º20
                worksheet.getColumn(10).width = 20;
            });
            
            // ç§»é™¤äº†å·¥è‰ºæµç¨‹è·Ÿè¸ªè¡¨å’Œå‘¨æœŸç»Ÿè®¡ä¹‹é—´çš„ç©ºè¡Œ
            
            // ä¼˜åŒ–çš„å‘¨æœŸç»Ÿè®¡åŒºåŸŸ - åªä¿ç•™æ€»è®¡åˆ’å‘¨æœŸå’Œæ€»å®é™…å‘¨æœŸ
            // åˆ›å»ºå‘¨æœŸç»Ÿè®¡æ ‡é¢˜è¡Œ - é†’ç›®æ ·å¼
            const statsHeaderRow = worksheet.getRow(worksheet.rowCount + 1);
            statsHeaderRow.height = 28;
            statsHeaderRow.values = ['', 'å‘¨æœŸç»Ÿè®¡æ‘˜è¦', '', '', '', '', '', '', '', ''];
            statsHeaderRow.getCell(2).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            statsHeaderRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
            statsHeaderRow.getCell(2).border = getStandardBorder();
            statsHeaderRow.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.mergeCells(statsHeaderRow.number, 2, statsHeaderRow.number, 9);
            
            // è®¡ç®—ä»å¼€å§‹åˆ°ç»“æŸçš„æ€»å‘¨æœŸï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼Œä¸å†æ’é™¤å‘¨æœ«ï¼‰
            const firstPlanStart = processData[0]?.planStart ? new Date(processData[0].planStart) : null;
            const lastPlanEnd = processData.length > 0 ? 
                new Date(processData[processData.length - 1].planEnd) : null;
            const totalPlanDuration = firstPlanStart && lastPlanEnd ? 
                calculateDaysBetween(firstPlanStart, lastPlanEnd) : 0;
                
            const firstActualStart = processData[0]?.actualStart ? new Date(processData[0].actualStart) : null;
            const lastActualEnd = processData.length > 0 && processData[processData.length - 1].actualEnd ? 
                new Date(processData[processData.length - 1].actualEnd) : null;
            const totalActualDuration = firstActualStart && lastActualEnd ? 
                calculateDaysBetween(firstActualStart, lastActualEnd) : 0;
            
            // åˆ›å»ºå‘¨æœŸç»Ÿè®¡è¯¦æƒ…è¡¨æ ¼ - åªä¿ç•™æ€»è®¡åˆ’å‘¨æœŸå’Œæ€»å®é™…å‘¨æœŸ
            const statsRows = [
                { label: "æ€»è®¡åˆ’å‘¨æœŸ", value: `${totalPlanDuration} å¤©`, color: "FF165DFF" },
                { label: "æ€»å®é™…å‘¨æœŸ", value: `${totalActualDuration} å¤©`, color: "FF27AE60" }
            ];
            
            // æ·»åŠ ç»Ÿè®¡æ•°æ®è¡Œ
            statsRows.forEach((stat, idx) => {
                const statRow = worksheet.getRow(worksheet.rowCount + 1);
                statRow.height = 24;
                
                // æ ‡ç­¾å•å…ƒæ ¼
                const labelCell = statRow.getCell(2);
                labelCell.value = stat.label;
                labelCell.font = { bold: true, size: 11 };
                labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                labelCell.border = getStandardBorder();
                labelCell.alignment = { vertical: 'middle', horizontal: 'right' };
                
                // å€¼å•å…ƒæ ¼
                const valueCell = statRow.getCell(3);
                valueCell.value = stat.value;
                valueCell.font = { bold: true, size: 11, color: { argb: stat.color } };
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                
                // åˆå¹¶å€¼å•å…ƒæ ¼åˆ°ç¬¬9åˆ—ï¼Œä½¿å†…å®¹æ›´çªå‡º
                worksheet.mergeCells(statRow.number, 3, statRow.number, 9);
                
                // ä¸ºäº¤æ›¿è¡Œæ·»åŠ èƒŒæ™¯è‰²ï¼Œå¢å¼ºå¯è¯»æ€§
                if (idx % 2 === 1) {
                    labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                    valueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                }
            });
            
            // ç»Ÿä¸€å‘¨æœŸç»Ÿè®¡æ å’Œå·¥è‰ºæµç¨‹è·Ÿè¸ªè¡¨çš„åˆ—å®½
            const statsStartRow = statsHeaderRow.number;
            const statsEndRow = worksheet.rowCount;
            
            // ä¼˜åŒ–å‘¨æœŸç»Ÿè®¡æ‘˜è¦æ çš„åˆ—å®½
            worksheet.getColumn(1).width = 10;  // åºå·åˆ—ä¿æŒ10
            worksheet.getColumn(2).width = 15;  // å·¥åºåç§°åˆ—ä¿æŒ15
            worksheet.getColumn(3).width = 15;  // å€¼åˆ—åŠ å®½
            for (let i = 4; i <= 9; i++) {
                worksheet.getColumn(i).width = columnWidths[i - 1];  // å…¶ä»–åˆ—ä¿æŒåŸè®¾å®š
            }
            // ç¡®ä¿å¤‡æ³¨åˆ—å®½ä¸º20
            worksheet.getColumn(10).width = 20;
            
            // è®¾ç½®æ‰“å°é€‰é¡¹
            worksheet.pageSetup.printArea = `A1:J${worksheet.rowCount}`;
            worksheet.pageSetup.orientation = 'landscape';
            worksheet.pageSetup.fitToPage = true;
            worksheet.pageSetup.fitToWidth = 1;
            worksheet.pageSetup.fitToHeight = 0;
            
            // æ·»åŠ é¡µè„š
            const exportDate = formatDateWithYear(new Date().toISOString().split('T')[0]);
            worksheet.headerFooter.footerCenter = `å¯¼å‡ºæ—¥æœŸ: ${exportDate} | ç¬¬ &P é¡µ / å…± &N é¡µ`;
            
            // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const fileName = `æ¨¡å…·æµç¨‹è·Ÿè¸ª_${document.getElementById('moldNumber').value || 'æœªçŸ¥ç¼–å·'}_${formatDateWithYear(new Date().toISOString().split('T')[0]).replace(/å¹´|æœˆ|æ—¥/g, '')}.xlsx`;
                saveAs(blob, fileName);
                showNotification('Excelå¯¼å‡ºæˆåŠŸ', 'success');
            }).catch(err => {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                showNotification('Excelå¯¼å‡ºå¤±è´¥', 'error');
            });
            
            } catch (error) {
                console.error('å¯¼å‡ºExcelæ—¶å‘ç”Ÿé”™è¯¯:', error);
                showNotification('å¯¼å‡ºExcelå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®å®Œæ•´æ€§', 'error');
            }
        }
        
        // æ ¼å¼åŒ–åˆ†ç»„æ ‡é¢˜
        function formatSectionHeader(worksheet, row, startCol, endCol) {
            row.height = 25;
            row.font = { bold: true, size: 14, color: { argb: 'FF333333' } };
            row.alignment = { horizontal: 'center', vertical: 'middle' };
            row.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                cell.border = getStandardBorder();
            });
            worksheet.mergeCells(row.number, startCol, row.number, endCol);
        }
        
        // è·å–æ ‡å‡†è¾¹æ¡†æ ·å¼
        function getStandardBorder() {
            return {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                // æ¸…ç©ºæ¨¡å…·åŸºæœ¬ä¿¡æ¯
                document.getElementById('moldNumber').value = '';
                document.getElementById('moldName').value = '';
                document.getElementById('moldType').value = '';
                document.getElementById('version').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('material').value = '';
                document.getElementById('cavityCount').value = '';
                document.getElementById('moldOpenNotice').value = '';
                document.getElementById('testDate').value = '';
                document.getElementById('moldRemark').value = '';
                
                // æ¸…ç©ºå·¥åºæ•°æ®
                processData = [];
                nextProcessId = 1;
                // é‡ç½®æ’æœŸè®¾ç½®ä¸ºé»˜è®¤å€¼
                scheduleSettings = {
                    includeDependencies: true
                };
                
                renderProcessTable();
                updateCycleStatistics();
                
                // æ¸…é™¤localStorage
                localStorage.removeItem('moldTrackingData');
                
                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'info');
            }
        }
        
        // åˆå§‹åŒ–é»˜è®¤å·¥åº - å¢å¼ºç‰ˆ
        function initializeDefaultProcesses() {
            if (processData.length > 0 && !confirm('ç¡®å®šè¦åˆå§‹åŒ–æµç¨‹å—ï¼Ÿå½“å‰æµç¨‹æ•°æ®å°†è¢«è¦†ç›–ã€‚')) {
                return;
            }
            
            // è·å–å¼€æ¨¡é€šçŸ¥æ—¥æœŸä½œä¸ºèµ·å§‹æ—¥æœŸ
            const startDate = document.getElementById('moldOpenNotice').value 
                ? new Date(document.getElementById('moldOpenNotice').value)
                : new Date();
            
            // æ™ºèƒ½é»˜è®¤å·¥åºåˆ—è¡¨ - åŒ…å«é¢„è®¾å¤©æ•°
            const defaultProcesses = [
                { name: 'è®¾è®¡è¯„å®¡', planDays: 2, remark: 'å›¾çº¸å®¡æ ¸ã€å·¥è‰ºè¯„ä¼°' },
                { name: 'ææ–™é‡‡è´­', planDays: 3, remark: 'é’¢æã€æ ‡å‡†ä»¶é‡‡è´­' },
                { name: 'æ·±å­”é’»/é“£åºŠåŠ å·¥', planDays: 4, remark: 'æ¨¡æ¿åŠ å·¥ã€æ·±å­”é’»å‰Š' },
                { name: 'CNCç²—åŠ å·¥', planDays: 5, remark: 'æ¯›å¯CNCç²—åŠ å·¥æˆå‹' },
                { name: 'çƒ­å¤„ç†/ç£¨åºŠåŠ å·¥', planDays: 2, remark: 'æ·¬ç«å›ç«ã€ç²¾å¯†ç£¨å‰Š' },
                { name: 'çº¿å‰²åŠ å·¥', planDays: 3, remark: 'ç²¾å¯†çº¿åˆ‡å‰²åŠ å·¥' },
                { name: 'CNCç²¾åŠ å·¥', planDays: 7, remark: 'ç²¾å¯†é“£å‰Šã€é’»å­”æ”»ä¸' },
                { name: 'EDMåŠ å·¥', planDays: 4, remark: 'ç”µç«èŠ±åŠ å·¥æˆå‹' },
                { name: 'çœæ¨¡/æŠ›å…‰', planDays: 2, remark: 'æ¨¡å…·æŠ›å…‰ã€è¡¨é¢å¤„ç†' },
                { name: 'é…è£…åˆæ¨¡', planDays: 3, remark: 'é›¶ä»¶è£…é…ã€è¯•åˆæ¨¡' },
                { name: 'è¯•æ¨¡', planDays: 1, remark: 'é¦–æ¬¡è¯•æ¨¡éªŒè¯' }
            ];
            
            processData = [];
            let currentDate = new Date(startDate);
            
            defaultProcesses.forEach((process, index) => {
                const planStart = formatDate(currentDate);
                
                // è®¡ç®—ç»“æŸæ—¥æœŸ
                const endDate = new Date(currentDate);
                if (process.planDays > 1) {
                    endDate.setDate(endDate.getDate() + process.planDays - 1);
                }
                const planEnd = formatDate(endDate);
                
                // åˆ›å»ºå·¥åºæ•°æ®
                const newProcess = {
                    id: nextProcessId++,
                    name: process.name,
                    planStart,
                    planEnd,
                    planDays: process.planDays,
                    actualStart: '',
                    actualEnd: '',
                    actualDays: '',
                    status: 'pending',
                    remark: process.remark
                };
                
                processData.push(newProcess);
                
                // æ›´æ–°ä¸‹ä¸€ä¸ªå·¥åºçš„å¼€å§‹æ—¥æœŸ
                currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() + 1);
            });
            
            // ç«‹å³æ¸²æŸ“å’Œä¿å­˜
            renderProcessTable();
            updateCycleStatistics();
            autoSaveWithSync();
            
            showNotification('æ ‡å‡†å·¥è‰ºæµç¨‹å·²åˆå§‹åŒ–ï¼Œæ•°æ®å·²è‡ªåŠ¨ä¿å­˜', 'success');
        }
        
        // æ·»åŠ æ–°å·¥åº - æ™ºèƒ½åŒ–ç‰ˆæœ¬
        function addNewProcess() {
            // æ™ºèƒ½å·¥åºåç§°å»ºè®®
            const commonProcesses = [
                { name: 'è®¾è®¡è¯„å®¡', days: 2, remark: 'å›¾çº¸å®¡æ ¸ã€å·¥è‰ºè¯„ä¼°' },
                { name: 'ææ–™é‡‡è´­', days: 3, remark: 'é’¢æã€æ ‡å‡†ä»¶é‡‡è´­' },
                { name: 'CNCç²—åŠ å·¥', days: 5, remark: 'æ¯›å¯CNCç²—åŠ å·¥æˆå‹' },
                { name: 'CNCç²¾åŠ å·¥', days: 7, remark: 'ç²¾å¯†åŠ å·¥æˆå‹' },
                { name: 'çƒ­å¤„ç†', days: 2, remark: 'æ·¬ç«å›ç«å¤„ç†' },
                { name: 'çº¿å‰²åŠ å·¥', days: 3, remark: 'ç²¾å¯†çº¿åˆ‡å‰²' },
                { name: 'EDMåŠ å·¥', days: 4, remark: 'ç”µç«èŠ±åŠ å·¥' },
                { name: 'æŠ›å…‰', days: 2, remark: 'è¡¨é¢æŠ›å…‰å¤„ç†' },
                { name: 'è£…é…', days: 3, remark: 'é›¶ä»¶è£…é…è°ƒè¯•' },
                { name: 'è¯•æ¨¡', days: 1, remark: 'è¯•æ¨¡éªŒè¯' }
            ];
            
            // æ‰¾åˆ°æœªä½¿ç”¨çš„å·¥åºåç§°
            const usedNames = processData.map(p => p.name);
            const availableProcess = commonProcesses.find(p => !usedNames.includes(p.name));
            
            const newProcess = {
                id: nextProcessId++,
                name: availableProcess ? availableProcess.name : `æ–°å·¥åº${processData.length + 1}`,
                planStart: '',
                planEnd: '',
                planDays: availableProcess ? availableProcess.days : 2,
                actualStart: '',
                actualEnd: '',
                actualDays: '',
                status: 'pending',
                remark: availableProcess ? availableProcess.remark : ''
            };
            
            // æ™ºèƒ½è®¾ç½®å¼€å§‹æ—¥æœŸ
            if (processData.length > 0) {
                const lastProcess = processData[processData.length - 1];
                if (lastProcess.planEnd) {
                    const nextStartDate = new Date(lastProcess.planEnd);
                    nextStartDate.setDate(nextStartDate.getDate() + 1);
                    newProcess.planStart = formatDate(nextStartDate);
                    
                    // è‡ªåŠ¨è®¡ç®—ç»“æŸæ—¥æœŸ
                    const endDate = new Date(nextStartDate);
                    if (newProcess.planDays > 1) {
                        endDate.setDate(endDate.getDate() + newProcess.planDays - 1);
                    }
                    newProcess.planEnd = formatDate(endDate);
                } else if (lastProcess.planStart) {
                    newProcess.planStart = lastProcess.planStart;
                }
            } else {
                // ç¬¬ä¸€ä¸ªå·¥åºï¼Œä½¿ç”¨å¼€æ¨¡é€šçŸ¥æ—¥æœŸæˆ–å½“å‰æ—¥æœŸ
                const startDate = document.getElementById('moldOpenNotice').value 
                    ? new Date(document.getElementById('moldOpenNotice').value)
                    : new Date();
                newProcess.planStart = formatDate(startDate);
                
                // è®¡ç®—ç»“æŸæ—¥æœŸ
                const endDate = new Date(startDate);
                if (newProcess.planDays > 1) {
                    endDate.setDate(endDate.getDate() + newProcess.planDays - 1);
                }
                newProcess.planEnd = formatDate(endDate);
            }
            
            processData.push(newProcess);
            renderProcessTable();
            updateCycleStatistics();
            autoSaveWithSync();
            
            // è‡ªåŠ¨èšç„¦åˆ°æ–°å·¥åºçš„åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                const newInput = document.querySelector(`.process-name[data-id="${newProcess.id}"]`);
                if (newInput) {
                    newInput.focus();
                    newInput.select();
                }
            }, 100);
            
            showNotification(`å·²æ·»åŠ å·¥åº"${newProcess.name}"ï¼Œé¢„è®¡${newProcess.planDays}å¤©`, 'success');
        }
        
        // æ¸²æŸ“å·¥åºè¡¨æ ¼
        function renderProcessTable() {
            processTableBody.innerHTML = '';
            
            if (processData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-folder-open-o text-2xl mb-2"></i>
                        <p>æš‚æ— å·¥åºæ•°æ®ï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æµç¨‹"æˆ–"æ·»åŠ å·¥åº"</p>
                    </td>
                `;
                processTableBody.appendChild(emptyRow);
                return;
            }
            
            processData.forEach((process, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-bg';
                row.dataset.id = process.id;
                
                // è·å–çŠ¶æ€æ ·å¼
                const statusInfo = statusOptions.find(s => s.id === process.status) || statusOptions[0];
                
                row.innerHTML = `
                    <td class="serial-number-col px-2 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900 text-center">${index + 1}</div>
                    </td>
                    <td class="process-name-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.name || ''}" 
                               class="process-name w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               maxlength="15">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.planStart ? formatDate(new Date(process.planStart)) : ''}" 
                               class="plan-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.planEnd ? formatDate(new Date(process.planEnd)) : ''}" 
                               class="plan-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="plan-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="0" value="${process.planDays || ''}" 
                               class="plan-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}"
                               placeholder="0">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.actualStart ? formatDate(new Date(process.actualStart)) : ''}" 
                               class="actual-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.actualEnd ? formatDate(new Date(process.actualEnd)) : ''}" 
                               class="actual-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="actual-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="0" value="${process.actualDays || ''}" 
                               class="actual-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}"
                               placeholder="0">
                    </td>
                    <td class="status-col px-2 py-3 whitespace-nowrap">
                        <span class="status-badge inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.class} cursor-pointer border"
                              data-id="${process.id}" data-current="${process.status}">
                            ${statusInfo.name}
                        </span>
                    </td>
                    <td class="remark-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.remark || ''}" 
                               class="remark w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               placeholder="å¤‡æ³¨">
                    </td>
                    <td class="action-col px-2 py-3 whitespace-nowrap text-sm font-medium text-center">
                        <button class="delete-process text-danger hover:text-danger/80 mr-1 p-1 rounded hover:bg-red-100 transition-colors" data-id="${process.id}" title="åˆ é™¤">
                            <i class="fa fa-trash-o"></i>
                        </button>
                        <button class="move-up text-gray-500 hover:text-primary mr-1 p-1 rounded hover:bg-blue-100 transition-colors" data-id="${process.id}" title="ä¸Šç§»">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                        <button class="move-down text-gray-500 hover:text-primary p-1 rounded hover:bg-blue-100 transition-colors" data-id="${process.id}" title="ä¸‹ç§»">
                            <i class="fa fa-arrow-down"></i>
                        </button>
                    </td>
                `;
                
                processTableBody.appendChild(row);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åˆ°åŠ¨æ€ç”Ÿæˆçš„å…ƒç´ 
            attachProcessEvents();
        }
        
        // ä¸ºå·¥åºè¡¨æ ¼å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - å¢å¼ºç‰ˆ
        function attachProcessEvents() {
            // å·¥åºåç§°è¾“å…¥ - æ™ºèƒ½å»ºè®®å’Œè‡ªåŠ¨ä¿å­˜
            document.querySelectorAll('.process-name').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldName = process.name;
                        process.name = e.target.value.substring(0, 15);
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®å·¥åºåç§°ï¼Œæ™ºèƒ½è®¾ç½®å¤©æ•°å’Œå¤‡æ³¨
                        if (oldName.startsWith('æ–°å·¥åº') && process.name !== oldName) {
                            autoSetProcessDefaults(process);
                        }
                        
                        autoSaveWithSync();
                        showNotification(`å·¥åºåç§°å·²æ›´æ–°ä¸º"${process.name}"`, 'info');
                    }
                });
                
                // æ·»åŠ æ™ºèƒ½æç¤ºåŠŸèƒ½
                input.addEventListener('input', e => {
                    showProcessSuggestions(e.target);
                });
            });
            
            // å¤‡æ³¨è¾“å…¥
            document.querySelectorAll('.remark').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.remark = e.target.value;
                    }
                });
            });
            
            // å¢å¼ºæ—¥æœŸé€‰æ‹©å™¨ä½“éªŒ
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                
                wrapper.addEventListener('click', () => {
                    if (typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                });
            });
            
            // è®¡åˆ’å¼€å§‹æ—¥æœŸ - æ™ºèƒ½åŒ–å¤„ç†
            document.querySelectorAll('.plan-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planStart = e.target.value;
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå·¥åºï¼Œæ™ºèƒ½å¤„ç†
                        if (processIndex === 0) {
                            handleFirstProcessDateChange(process);
                        } else {
                            // å…¶ä»–å·¥åºçš„æ™ºèƒ½å¤„ç†
                            handleSubsequentProcessDateChange(process, processIndex);
                        }
                        
                        autoSaveWithSync();
                    }
                });
            });
            
            // è®¡åˆ’ç»“æŸæ—¥æœŸ - ä¿®æ”¹æ—¶è‡ªåŠ¨è®¡ç®—è®¡åˆ’å¤©æ•°å’Œåç»­å·¥åºï¼Œå¹¶é‡æ–°è®¡ç®—
            document.querySelectorAll('.plan-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planEnd = e.target.value;
                        
                        // ç«‹å³æ›´æ–°ç›¸å…³è®¡ç®—
                        calculateAndUpdatePlanDays(processId);
                        updateSubsequentPlansIntelligent(processIndex);
                        updateCycleStatistics();
                        
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ˜¾ç¤ºæ›´æ–°
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // è®¡åˆ’å¤©æ•° - æ™ºèƒ½åŒ–å¤„ç†
            document.querySelectorAll('.plan-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const days = parseInt(e.target.value) || 0;
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldDays = process.planDays;
                        process.planDays = days;
                        
                        // æ™ºèƒ½å¤„ç†å¤©æ•°å˜æ›´
                        handlePlanDaysChange(process, processIndex, oldDays, days);
                        
                        autoSaveWithSync();
                    }
                });
            });
            
            // å®é™…å¼€å§‹æ—¥æœŸ - ä¿®æ”¹æ—¶è‡ªåŠ¨è®¡ç®—å®é™…ç»“æŸæ—¥æœŸå’Œåç»­å·¥åºï¼Œå¹¶é‡æ–°è®¡ç®—
            document.querySelectorAll('.actual-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualStart = e.target.value;
                        
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ˜¾ç¤ºæ›´æ–°
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // å®é™…ç»“æŸæ—¥æœŸ - ä¿®æ”¹æ—¶è‡ªåŠ¨è®¡ç®—å®é™…å¤©æ•°å’Œåç»­å·¥åºï¼Œå¹¶é‡æ–°è®¡ç®—
            document.querySelectorAll('.actual-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualEnd = e.target.value;
                        calculateAndUpdateActualDays(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ˜¾ç¤ºæ›´æ–°
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // å®é™…å¤©æ•° - ä¿®æ”¹æ—¶è‡ªåŠ¨è®¡ç®—å®é™…ç»“æŸæ—¥æœŸå’Œåç»­å·¥åºï¼Œå¹¶é‡æ–°è®¡ç®—
            document.querySelectorAll('.actual-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const days = parseInt(e.target.value) || 0;
                        process.actualDays = days;
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ˜¾ç¤ºæ›´æ–°
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // çŠ¶æ€æ ‡ç­¾ç‚¹å‡»åˆ‡æ¢ - æ™ºèƒ½åŒ–å¤„ç†
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const currentStatus = e.target.dataset.current;
                    const currentIndex = statusOptions.findIndex(s => s.id === currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOptions.length;
                    const nextStatus = statusOptions[nextIndex].id;
                    
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldStatus = process.status;
                        process.status = nextStatus;
                        
                        // æ™ºèƒ½å¤„ç†çŠ¶æ€å˜æ›´
                        handleStatusChange(process, oldStatus, nextStatus);
                        
                        // ç«‹å³æ›´æ–°æ˜¾ç¤ºå’Œä¿å­˜
                        renderProcessTable();
                        updateCycleStatistics();
                        autoSaveWithSync();
                        
                        // æ˜¾ç¤ºçŠ¶æ€å˜æ›´æç¤º
                        const statusName = statusOptions.find(s => s.id === nextStatus).name;
                        showNotification(`å·¥åº"${process.name}"çŠ¶æ€å·²æ›´æ–°ä¸º: ${statusName}`, 'success');
                    }
                });
            });
            
            // åˆ é™¤å·¥åº
            document.querySelectorAll('.delete-process').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å·¥åºå—ï¼Ÿåç»­å·¥åºå°†è‡ªåŠ¨è°ƒæ•´ã€‚')) {
                        const processIndex = processData.findIndex(p => p.id === processId);
                        const deletedProcess = processData.find(p => p.id === processId);
                        processData = processData.filter(p => p.id !== processId);
                        
                        // è°ƒæ•´åç»­å·¥åºçš„æ—¥æœŸ
                        if (processIndex < processData.length) {
                            // æ›´æ–°åç»­æ‰€æœ‰å·¥åºçš„æ—¥æœŸ
                            updateSubsequentPlans(processIndex - 1);
                            updateSubsequentActuals(processIndex - 1);
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        
                        // æ£€æŸ¥æ’æœŸå†²çª
                        const conflicts = checkScheduleConflicts();
                        if (conflicts.length > 0) {
                            highlightConflicts(conflicts);
                            showNotification(`æ£€æµ‹åˆ° ${conflicts.length} å¤„æ’æœŸå†²çª`, 'warning');
                        } else {
                            showNotification('å·¥åºå·²åˆ é™¤ï¼Œåç»­å·¥åºå·²è‡ªåŠ¨è°ƒæ•´', 'info');
                        }
                        
                        // è‡ªåŠ¨é‡æ–°è®¡ç®—
                        recalculateSchedule();
                    }
                });
            });
            
            // ä¸Šç§»å·¥åº
            document.querySelectorAll('.move-up').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index > 0) {
                        // äº¤æ¢ä½ç½®
                        [processData[index], processData[index - 1]] = [processData[index - 1], processData[index]];
                        
                        // è°ƒæ•´å—å½±å“çš„å·¥åºæ—¥æœŸ
                        if (index - 1 > 0) {
                            // æ›´æ–°ä¸Šä¸€ä¸ªå·¥åºçš„åç»­
                            updateSubsequentPlans(index - 2);
                            updateSubsequentActuals(index - 2);
                        } else {
                            // å¦‚æœä¸Šç§»åˆ°ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä»ç¬¬ä¸€ä¸ªå·¥åºå¼€å§‹æ›´æ–°åç»­
                            updateSubsequentPlans(index - 1);
                            updateSubsequentActuals(index - 1);
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // è‡ªåŠ¨é‡æ–°è®¡ç®—
                        recalculateSchedule();
                    }
                });
            });
            
            // ä¸‹ç§»å·¥åº
            document.querySelectorAll('.move-down').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index < processData.length - 1) {
                        // äº¤æ¢ä½ç½®
                        [processData[index], processData[index + 1]] = [processData[index + 1], processData[index]];
                        
                        // è°ƒæ•´å—å½±å“çš„å·¥åºæ—¥æœŸ
                        updateSubsequentPlans(index - 1);
                        updateSubsequentActuals(index - 1);
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // è‡ªåŠ¨é‡æ–°è®¡ç®—
                        recalculateSchedule();
                    }
                });
            });
        }
        
        // æ›´æ–°åç»­å·¥åºçš„è®¡åˆ’æ—¥æœŸ
        function updateSubsequentPlans(startIndex) {
            // ä»startIndex + 1å¼€å§‹æ›´æ–°æ‰€æœ‰åç»­å·¥åº
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // å¦‚æœå‰ä¸€å·¥åºæœ‰è®¡åˆ’ç»“æŸæ—¥æœŸï¼Œè®¾ç½®å½“å‰å·¥åºçš„è®¡åˆ’å¼€å§‹æ—¥æœŸ
                if (prevProcess && prevProcess.planEnd) {
                    // è®¡ç®—ä¸‹ä¸€ä¸ªå·¥ä½œæ—¥ä½œä¸ºå¼€å§‹æ—¥æœŸï¼ˆå‰ä¸€å·¥åºç»“æŸæ—¥æœŸçš„ä¸‹ä¸€å¤©ï¼‰
                    const prevEndDate = new Date(prevProcess.planEnd);
                    prevEndDate.setDate(prevEndDate.getDate() + 1);
                    currentProcess.planStart = formatDate(prevEndDate);
                    
                    // å¦‚æœå½“å‰å·¥åºæœ‰è®¡åˆ’å¤©æ•°ï¼Œè‡ªåŠ¨è®¡ç®—è®¡åˆ’ç»“æŸæ—¥æœŸ
                    if (currentProcess.planDays && currentProcess.planDays > 0) {
                        calculateAndUpdatePlanEnd(currentProcess.id);
                    }
                } else if (prevProcess && prevProcess.planStart && !prevProcess.planEnd) {
                    // å¦‚æœå‰ä¸€å·¥åºåªæœ‰å¼€å§‹æ—¥æœŸæ²¡æœ‰ç»“æŸæ—¥æœŸï¼Œä½¿ç”¨å¼€å§‹æ—¥æœŸä½œä¸ºå‚è€ƒ
                    currentProcess.planStart = prevProcess.planStart;
                    
                    if (currentProcess.planDays && currentProcess.planDays > 0) {
                        calculateAndUpdatePlanEnd(currentProcess.id);
                    }
                }
            }
        }

        // æ™ºèƒ½æ¨ç®—åç»­å·¥åºçš„è®¡åˆ’æ—¥æœŸï¼ˆå…¨æ–°è®¾è®¡ï¼‰
        function updateSubsequentPlansIntelligent(startIndex) {
            // ä»startIndexå¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰åç»­å·¥åº
            for (let i = startIndex; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // è·³è¿‡ç¬¬ä¸€ä¸ªå·¥åºï¼ˆé™¤éå®ƒæ˜¯è¢«ä¿®æ”¹çš„å·¥åºï¼‰
                if (i === 0 && startIndex !== 0) continue;
                
                // ä¸ºå½“å‰å·¥åºè®¡ç®—å¼€å§‹æ—¥æœŸ
                if (i > 0 && prevProcess) {
                    calculateProcessStartDate(currentProcess, prevProcess);
                }
                
                // è®¡ç®—å½“å‰å·¥åºçš„ç»“æŸæ—¥æœŸ
                calculateProcessEndDate(currentProcess);
            }
        }

        // è®¡ç®—å·¥åºå¼€å§‹æ—¥æœŸ
        function calculateProcessStartDate(currentProcess, prevProcess) {
            if (prevProcess.planEnd) {
                // å‰ä¸€å·¥åºæœ‰ç»“æŸæ—¥æœŸï¼Œå½“å‰å·¥åºä»ä¸‹ä¸€å¤©å¼€å§‹
                const nextStartDate = new Date(prevProcess.planEnd);
                nextStartDate.setDate(nextStartDate.getDate() + 1);
                currentProcess.planStart = formatDate(nextStartDate);
            } else if (prevProcess.planStart) {
                // å‰ä¸€å·¥åºåªæœ‰å¼€å§‹æ—¥æœŸï¼Œæ™ºèƒ½æ¨ç®—
                const prevStartDate = new Date(prevProcess.planStart);
                
                // å¦‚æœå‰ä¸€å·¥åºæœ‰å¤©æ•°ï¼Œä½¿ç”¨å¤©æ•°è®¡ç®—
                if (prevProcess.planDays && prevProcess.planDays > 0) {
                    prevStartDate.setDate(prevStartDate.getDate() + parseInt(prevProcess.planDays));
                    currentProcess.planStart = formatDate(prevStartDate);
                } else {
                    // æ²¡æœ‰å¤©æ•°ï¼Œå‡è®¾1å¤©å·¥æœŸ
                    prevStartDate.setDate(prevStartDate.getDate() + 1);
                    currentProcess.planStart = formatDate(prevStartDate);
                }
            }
        }

        // è®¡ç®—å·¥åºç»“æŸæ—¥æœŸ
        function calculateProcessEndDate(process) {
            if (process.planStart && process.planDays && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
        }

        // å…¨é‡æ™ºèƒ½é‡æ–°è®¡ç®—ï¼ˆä»ç¬¬ä¸€ä¸ªå·¥åºå¼€å§‹ï¼‰
        function fullIntelligentRecalculation() {
            if (processData.length === 0) return;
            
            // ç¡®ä¿ç¬¬ä¸€ä¸ªå·¥åºæœ‰å¼€å§‹æ—¥æœŸ
            if (!processData[0].planStart) {
                const startDate = getCalculationStartDate();
                processData[0].planStart = startDate;
            }
            
            // è‡ªåŠ¨å¡«å……é»˜è®¤å¤©æ•°ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            autoFillDefaultDays();
            
            // ä»ç¬¬ä¸€ä¸ªå·¥åºå¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰å·¥åº
            updateSubsequentPlansIntelligent(0);
            
            // æ›´æ–°ç•Œé¢å’Œç»Ÿè®¡
            renderProcessTable();
            updateCycleStatistics();
            
            // åŒæ­¥æ•°æ®åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨
            syncToMoldManagement();
            
            saveData();
        }
        
        // è‡ªåŠ¨å¡«å……é»˜è®¤å¤©æ•°
        function autoFillDefaultDays() {
            const defaultDays = [3, 2, 4, 5, 2, 3, 7, 4, 2, 3, 1]; // å¯¹åº”é»˜è®¤å·¥åºçš„å¤©æ•°
            
            processData.forEach((process, index) => {
                if (!process.planDays || process.planDays === 0 || process.planDays === '') {
                    // å¦‚æœæ²¡æœ‰è®¾ç½®å¤©æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    if (index < defaultDays.length) {
                        process.planDays = defaultDays[index];
                    } else {
                        process.planDays = 2; // è¶…å‡ºé»˜è®¤æ•°ç»„çš„å·¥åºä½¿ç”¨2å¤©
                    }
                }
            });
        }
        
        // åŒæ­¥æ•°æ®åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨
        function syncToMoldManagement() {
            // è®¡ç®—æ€»å·¥æœŸå’Œå…³é”®æ—¥æœŸ
            const totalDays = processData.reduce((sum, process) => sum + (parseInt(process.planDays) || 0), 0);
            const startDate = processData.length > 0 ? processData[0].planStart : '';
            const endDate = processData.length > 0 ? processData[processData.length - 1].planEnd : '';
            
            // è®¡ç®—å®Œæˆè¿›åº¦
            const completedProcesses = processData.filter(p => p.status === 'completed').length;
            const progress = processData.length > 0 ? Math.round((completedProcesses / processData.length) * 100) : 0;
            
            // æ›´æ–°å½“å‰æ¨¡å…·çš„ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof moldsData !== 'undefined' && moldsData.length > 0) {
                // è¿™é‡Œå¯ä»¥æ ¹æ®å½“å‰ç¼–è¾‘çš„æ¨¡å…·IDæ›´æ–°å¯¹åº”çš„æ¨¡å…·ä¿¡æ¯
                // æš‚æ—¶æ›´æ–°ç¬¬ä¸€ä¸ªæ¨¡å…·ä½œä¸ºç¤ºä¾‹
                const currentMold = moldsData[0];
                if (currentMold) {
                    currentMold.totalDays = totalDays;
                    currentMold.startDate = startDate;
                    currentMold.endDate = endDate;
                    currentMold.progress = progress;
                    currentMold.updatedAt = new Date().toISOString();
                    
                    // ä¿å­˜æ¨¡å…·æ•°æ®
                    if (typeof saveMoldsData === 'function') {
                        saveMoldsData();
                    }
                }
            }
        }
        
        // æ›´æ–°åç»­å·¥åºçš„å®é™…æ—¥æœŸ
        function updateSubsequentActuals(startIndex) {
            // ä»startIndex + 1å¼€å§‹æ›´æ–°æ‰€æœ‰åç»­å·¥åº
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // è®¾ç½®å½“å‰å·¥åºçš„å®é™…å¼€å§‹æ—¥æœŸä¸ºå‰ä¸€å·¥åºçš„å®é™…ç»“æŸæ—¥æœŸ
                if (prevProcess.actualEnd) {
                    currentProcess.actualStart = prevProcess.actualEnd;
                    
                    // æ ¹æ®å®é™…å¼€å§‹æ—¥æœŸå’Œå®é™…å¤©æ•°è®¡ç®—å®é™…ç»“æŸæ—¥æœŸ
                    calculateAndUpdateActualEnd(currentProcess.id);
                }
            }
        }
        
        // è®¡ç®—å¹¶æ›´æ–°è®¡åˆ’ç»“æŸæ—¥æœŸï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
        function calculateAndUpdatePlanEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planDays || process.planDays <= 0) {
                // å¦‚æœæ²¡æœ‰å¼€å§‹æ—¥æœŸæˆ–å¤©æ•°ä¸º0ï¼Œæ¸…ç©ºç»“æŸæ—¥æœŸ
                if (process) {
                    process.planEnd = '';
                }
                return;
            }
            
            let startDate = new Date(process.planStart);
            if (isNaN(startDate.getTime())) return;
            
            // å¢åŠ è®¡åˆ’å¤©æ•°å‡1ï¼ˆå› ä¸ºåŒ…å«å½“å¤©ï¼‰
            // å¦‚æœè®¡åˆ’å¤©æ•°ä¸º1ï¼Œåˆ™ç»“æŸæ—¥æœŸä¸å¼€å§‹æ—¥æœŸç›¸åŒ
            if (process.planDays > 1) {
                startDate.setDate(startDate.getDate() + process.planDays - 1);
            }
            
            const formattedEndDate = formatDate(startDate);
            process.planEnd = formattedEndDate;
            
            // ç›´æ¥æ›´æ–°è¾“å…¥æ¡†
            const endInput = document.querySelector(`.plan-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // è®¡ç®—å¹¶æ›´æ–°è®¡åˆ’å¤©æ•°ï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
        function calculateAndUpdatePlanDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planEnd) return;
            
            const startDate = new Date(process.planStart);
            const endDate = new Date(process.planEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // è®¡ç®—æ€»å¤©æ•°ï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
            const days = calculateDaysBetween(startDate, endDate);
            
            process.planDays = days;
            
            // ç›´æ¥æ›´æ–°è¾“å…¥æ¡†
            const daysInput = document.querySelector(`.plan-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // è®¡ç®—å¹¶æ›´æ–°å®é™…ç»“æŸæ—¥æœŸï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
        function calculateAndUpdateActualEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || process.actualDays === undefined || process.actualDays <= 0) return;
            
            let startDate = new Date(process.actualStart);
            if (isNaN(startDate.getTime())) return;
            
            // å¢åŠ å®é™…å¤©æ•°å‡1ï¼ˆå› ä¸ºåŒ…å«å½“å¤©ï¼‰
            // å¦‚æœå®é™…å¤©æ•°ä¸º1ï¼Œåˆ™ç»“æŸæ—¥æœŸä¸å¼€å§‹æ—¥æœŸç›¸åŒ
            if (process.actualDays > 1) {
                startDate.setDate(startDate.getDate() + process.actualDays - 1);
            }
            
            const formattedEndDate = formatDate(startDate);
            process.actualEnd = formattedEndDate;
            
            // ç›´æ¥æ›´æ–°è¾“å…¥æ¡†
            const endInput = document.querySelector(`.actual-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // è®¡ç®—å¹¶æ›´æ–°å®é™…å¤©æ•°ï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
        function calculateAndUpdateActualDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || !process.actualEnd) return;
            
            const startDate = new Date(process.actualStart);
            const endDate = new Date(process.actualEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // è®¡ç®—æ€»å¤©æ•°ï¼ˆåŒ…å«æ‰€æœ‰æ—¥æœŸï¼‰
            const days = calculateDaysBetween(startDate, endDate);
            
            process.actualDays = days;
            
            // ç›´æ¥æ›´æ–°è¾“å…¥æ¡†
            const daysInput = document.querySelector(`.actual-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºXæœˆXXæ—¥ï¼ˆä¸å«å¹´ä»½ï¼‰
        function formatDateWithoutYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${month}æœˆ${day}æ—¥`;
            }
            return dateStr;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYYå¹´XæœˆXXæ—¥ï¼ˆåŒ…å«å¹´ä»½ï¼‰
        function formatDateWithYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${year}å¹´${month}æœˆ${day}æ—¥`;
            }
            return dateStr;
        }
        
        // è·å–çŠ¶æ€åç§°
        function getStatusName(statusId) {
            const status = statusOptions.find(s => s.id === statusId);
            return status ? status.name : 'æœªçŸ¥';
        }
        
        // æ•°æ®éªŒè¯å‡½æ•°
        function validateProcessData() {
            const errors = [];
            
            processData.forEach((process, index) => {
                // éªŒè¯å·¥åºåç§°
                if (!process.name || process.name.trim() === '') {
                    errors.push(`å·¥åº ${index + 1}: å·¥åºåç§°ä¸èƒ½ä¸ºç©º`);
                }
                
                // éªŒè¯è®¡åˆ’å¤©æ•°
                if (!process.planDays || process.planDays <= 0) {
                    errors.push(`å·¥åº ${index + 1}: è®¡åˆ’å¤©æ•°å¿…é¡»å¤§äº0`);
                }
                
                // éªŒè¯æ—¥æœŸæ ¼å¼å’Œé€»è¾‘
                if (process.planStart && process.planEnd) {
                    const startDate = new Date(process.planStart);
                    const endDate = new Date(process.planEnd);
                    
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        errors.push(`å·¥åº ${index + 1}: æ—¥æœŸæ ¼å¼æ— æ•ˆ`);
                    } else if (startDate > endDate) {
                        errors.push(`å·¥åº ${index + 1}: è®¡åˆ’å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ`);
                    }
                }
                
                // éªŒè¯å®é™…æ—¥æœŸé€»è¾‘
                if (process.actualStart && process.actualEnd) {
                    const startDate = new Date(process.actualStart);
                    const endDate = new Date(process.actualEnd);
                    
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        errors.push(`å·¥åº ${index + 1}: å®é™…æ—¥æœŸæ ¼å¼æ— æ•ˆ`);
                    } else if (startDate > endDate) {
                        errors.push(`å·¥åº ${index + 1}: å®é™…å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ`);
                    }
                }
                
                // éªŒè¯å®é™…å¤©æ•°
                if (process.actualDays !== '' && process.actualDays < 0) {
                    errors.push(`å·¥åº ${index + 1}: å®é™…å¤©æ•°ä¸èƒ½ä¸ºè´Ÿæ•°`);
                }
            });
            
            return errors;
        }
        
        // å®‰å…¨çš„æ—¥æœŸè§£æå‡½æ•°
        function safeParseDate(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            let bgColor, textColor, icon;
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-success';
                    textColor = 'text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-danger';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-warning';
                    textColor = 'text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-primary';
                    textColor = 'text-white';
                    icon = 'fa-info-circle';
            }
            
            notification.className = `fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 flex items-center z-50 ${bgColor} ${textColor}`;
            notification.innerHTML = `<i class="fa ${icon} mr-2"></i>${message}`;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(calc(100% + 20px))';
            }, 3000);
        }
        
        // ==================== æ¨¡å…·ç®¡ç†åŠŸèƒ½ ====================
        
        // é¡µé¢åˆ‡æ¢åŠŸèƒ½
        function switchPage(page) {
            currentPage = page;
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.sidebar-nav-item').forEach(btn => btn.classList.remove('active'));
            
            if (page === 'management') {
                navManagement.classList.add('active');
                managementPage.classList.add('active');
                trackingPage.classList.remove('active');
                renderMoldsList();
            } else {
                navTracking.classList.add('active');
                trackingPage.classList.add('active');
                managementPage.classList.remove('active');
            }
        }
        
        // è®¾ç½®æ¨¡å…·ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
        function setupMoldManagementListeners() {
            if (createNewMold) createNewMold.addEventListener('click', createNewMoldProject);
            if (refreshMolds) refreshMolds.addEventListener('click', renderMoldsList);
            if (searchMolds) searchMolds.addEventListener('input', debounce(filterMolds, 300));
            if (statusFilter) statusFilter.addEventListener('change', filterMolds);
            
            // å¿«é€Ÿç­›é€‰æŒ‰é’®
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-filter')) {
                    handleQuickFilter(e.target.dataset.filter);
                }
                
                // ç©ºçŠ¶æ€æŒ‰é’®
                if (e.target.classList.contains('create-first-mold')) {
                    createNewMoldProject();
                }
            });
        }
        
        // æ›´æ–°æ¨¡å…·ç»Ÿè®¡æ•°æ®
        function updateMoldsStatistics() {
            const totalCount = moldsData.length;
            const activeCount = moldsData.filter(m => m.status === 'active').length;
            const completedCount = moldsData.filter(m => m.status === 'completed').length;
            const pendingCount = moldsData.filter(m => m.status === 'pending').length;
            
            // è®¡ç®—å³å°†è¯•æ¨¡çš„æ•°é‡ï¼ˆè¯•æ¨¡æ—¥æœŸåœ¨æœªæ¥7å¤©å†…ï¼‰
            const now = new Date();
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const upcomingTestCount = moldsData.filter(mold => {
                if (!mold.testDate) return false;
                const testDate = new Date(mold.testDate);
                return testDate >= now && testDate <= nextWeek;
            }).length;
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            const totalElement = document.getElementById('totalMoldsCount');
            const activeElement = document.getElementById('activeMoldsCount');
            const completedElement = document.getElementById('completedMoldsCount');
            const pendingElement = document.getElementById('pendingMoldsCount');
            const upcomingTestElement = document.getElementById('upcomingTestCount');
            
            if (totalElement) totalElement.textContent = totalCount;
            if (activeElement) activeElement.textContent = activeCount;
            if (completedElement) completedElement.textContent = completedCount;
            if (pendingElement) pendingElement.textContent = pendingCount;
            if (upcomingTestElement) upcomingTestElement.textContent = upcomingTestCount;
        }
        
        // è·å–çŠ¶æ€å¾½ç« æ ·å¼ç±»
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending':
                    return 'bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg px-2 py-1';
                case 'active':
                    return 'bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1';
                case 'completed':
                    return 'bg-green-50 text-green-700 border border-green-200 rounded-lg px-2 py-1';
                default:
                    return 'bg-gray-50 text-gray-700 border border-gray-200 rounded-lg px-2 py-1';
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
        function formatDisplayDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // å¤„ç†å¿«é€Ÿç­›é€‰
        function handleQuickFilter(filterType) {
            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.quick-filter').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            
            // æ¿€æ´»å½“å‰æŒ‰é’®
            event.target.classList.remove('bg-gray-100', 'text-gray-600');
            event.target.classList.add('bg-primary', 'text-white');
            
            const now = new Date();
            let filteredMolds = [...moldsData];
            
            switch (filterType) {
                case 'today':
                    // ä»Šæ—¥æ›´æ–°çš„æ¨¡å…·
                    const today = now.toISOString().split('T')[0];
                    filteredMolds = moldsData.filter(mold => {
                        const updatedDate = new Date(mold.updatedAt).toISOString().split('T')[0];
                        return updatedDate === today;
                    });
                    break;
                    
                case 'week':
                    // æœ¬å‘¨åˆ›å»ºçš„æ¨¡å…·
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredMolds = moldsData.filter(mold => {
                        const createdDate = new Date(mold.createdAt);
                        return createdDate >= weekAgo;
                    });
                    break;
                    
                case 'completed':
                    // å…¨éƒ¨å®Œæˆçš„æ¨¡å…·
                    filteredMolds = moldsData.filter(mold => {
                        return mold.status === 'completed';
                    });
                    break;
                    
                case 'urgent':
                    // å³å°†è¯•æ¨¡çš„æ¨¡å…·ï¼ˆè¯•æ¨¡æ—¥æœŸåœ¨æœªæ¥7å¤©å†…ï¼‰
                    const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                    filteredMolds = moldsData.filter(mold => {
                        if (!mold.testDate) return false;
                        const testDate = new Date(mold.testDate);
                        return testDate >= now && testDate <= nextWeek;
                    });
                    break;
                    
                default:
                    // é‡ç½®ç­›é€‰
                    document.querySelectorAll('.quick-filter').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('bg-gray-100', 'text-gray-600');
                    });
                    break;
            }
            
            // ä¸´æ—¶è®¾ç½®ç­›é€‰ç»“æœå¹¶æ¸²æŸ“
            const originalData = moldsData;
            moldsData = filteredMolds;
            renderMoldsList();
            moldsData = originalData;
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœæç¤º
            if (filteredMolds.length === 0) {
                showNotification(`æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆ"${getFilterName(filterType)}"æ¡ä»¶çš„æ¨¡å…·`, 'info');
            } else {
                showNotification(`æ‰¾åˆ° ${filteredMolds.length} ä¸ªç¬¦åˆ"${getFilterName(filterType)}"æ¡ä»¶çš„æ¨¡å…·`, 'success');
            }
        }
        
        // è·å–ç­›é€‰åç§°
        function getFilterName(filterType) {
            switch (filterType) {
                case 'today': return 'ä»Šæ—¥æ›´æ–°';
                case 'week': return 'æœ¬å‘¨åˆ›å»º';
                case 'completed': return 'å…¨éƒ¨å®Œæˆ';
                case 'urgent': return 'å³å°†è¯•æ¨¡';
                default: return 'å…¨éƒ¨';
            }
        }
        
        // åŠ è½½æ¨¡å…·æ•°æ®
        function loadMoldsData() {
            const savedMolds = localStorage.getItem('moldsManagementData');
            if (savedMolds) {
                try {
                    const data = JSON.parse(savedMolds);
                    moldsData = data.molds || [];
                    nextMoldId = data.nextId || 1;
                } catch (error) {
                    console.error('åŠ è½½æ¨¡å…·æ•°æ®å¤±è´¥:', error);
                    moldsData = [];
                    nextMoldId = 1;
                }
            }
        }
        
        // ä¿å­˜æ¨¡å…·æ•°æ®
        function saveMoldsData() {
            try {
                const dataToSave = {
                    molds: moldsData,
                    nextId: nextMoldId,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('moldsManagementData', JSON.stringify(dataToSave));
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ¨¡å…·æ•°æ®å¤±è´¥:', error);
                showNotification('ä¿å­˜æ¨¡å…·æ•°æ®å¤±è´¥', 'error');
                return false;
            }
        }
        
        // åˆ›å»ºæ–°æ¨¡å…·é¡¹ç›® - ä¼˜åŒ–ç‰ˆæœ¬
        function createNewMoldProject() {
            showCreateMoldModal();
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæ¨¡å…·çš„æ¨¡æ€æ¡† - ç°ä»£åŒ–è®¾è®¡
        function showCreateMoldModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden border border-gray-100">
                    <!-- ç°ä»£åŒ–æ ‡é¢˜æ  -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-8 py-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-1">åˆ›å»ºæ–°æ¨¡å…·é¡¹ç›®</h3>
                                <p class="text-sm text-gray-600">å¡«å†™åŸºæœ¬ä¿¡æ¯å¼€å§‹æ‚¨çš„æ¨¡å…·åˆ¶é€ é¡¹ç›®</p>
                            </div>
                            <button class="close-modal text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-50 rounded-full transition-all duration-200">
                                <i class="fa fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç°ä»£åŒ–è¡¨å•å†…å®¹ -->
                    <div class="overflow-y-auto max-h-[60vh]">
                        <form id="createMoldForm" class="px-8 py-6">
                            <div class="space-y-6">
                                <!-- åŸºç¡€ä¿¡æ¯ -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            æ¨¡å…·ç¼–å·
                                        </label>
                                        <input type="text" id="newMoldNumber" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="è¾“å…¥å”¯ä¸€ç¼–å·">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            æ¨¡å…·åç§°
                                        </label>
                                        <input type="text" id="newMoldName"
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="è¾“å…¥æ¨¡å…·åç§°">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">æ¨¡å…·ç±»å‹</label>
                                        <select id="newMoldType" 
                                                class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white">
                                            <option value="">é€‰æ‹©ç±»å‹</option>
                                            <option value="æ³¨å¡‘æ¨¡">æ³¨å¡‘æ¨¡</option>
                                            <option value="å‹é“¸æ¨¡">å‹é“¸æ¨¡</option>
                                            <option value="å†²å‹æ¨¡">å†²å‹æ¨¡</option>
                                            <option value="å¹å¡‘æ¨¡">å¹å¡‘æ¨¡</option>
                                            <option value="å…¶ä»–">å…¶ä»–</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">äº§å“åç§°</label>
                                        <input type="text" id="newProductName" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="è¾“å…¥äº§å“åç§°">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">äº§å“ææ–™</label>
                                        <input type="text" id="newMaterial" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="å¦‚: ABSã€PCã€PP">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç©´æ•°</label>
                                        <input type="number" id="newCavityCount" min="1"
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="è¾“å…¥ç©´æ•°">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">å¼€æ¨¡é€šçŸ¥æ—¥æœŸ <span class="text-red-500">*</span></label>
                                        <input type="date" id="newMoldOpenNotice" 
                                               style="width: 100%; padding: 8px 40px 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
                                               required>
                                        <small class="text-gray-500 text-xs mt-1 block">å®¢æˆ·ä¸‹è¾¾å¼€æ¨¡é€šçŸ¥çš„æ—¥æœŸï¼Œç‚¹å‡»å³ä¾§æ—¥å†å›¾æ ‡é€‰æ‹©</small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç‰ˆæœ¬å·</label>
                                        <input type="text" id="newVersion" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="å¦‚: V1.0">
                                    </div>
                                </div>
                                
                                <!-- å¤‡æ³¨ -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">å¤‡æ³¨è¯´æ˜</label>
                                    <textarea id="newMoldRemark" rows="3" 
                                              class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white resize-none"
                                              placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                                </div>
                                
                                <!-- é€‰é¡¹ -->
                                <div class="bg-blue-50 rounded-xl p-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">åˆ›å»ºé€‰é¡¹</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="initWithDefaultProcesses" checked 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 rounded">
                                            <span class="ml-3 text-sm text-gray-700">è‡ªåŠ¨åˆ›å»ºæ ‡å‡†å·¥è‰ºæµç¨‹</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="autoSwitchToEdit" checked 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 rounded">
                                            <span class="ml-3 text-sm text-gray-700">åˆ›å»ºåç«‹å³è¿›å…¥ç¼–è¾‘æ¨¡å¼</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- ç°ä»£åŒ–åº•éƒ¨æŒ‰é’®æ  -->
                    <div class="bg-white border-t border-gray-100 px-8 py-6">
                        <div class="flex gap-4 justify-end">
                            <button type="button" class="cancel-create px-6 py-3 bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all duration-200 font-medium rounded-xl flex items-center">
                                <i class="fa fa-times mr-2"></i>å–æ¶ˆ
                            </button>
                            <button type="submit" form="createMoldForm" class="px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-semibold rounded-xl shadow-lg hover:shadow-xl flex items-center">
                                <i class="fa fa-plus mr-2"></i>åˆ›å»ºé¡¹ç›®
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            

            
            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
            setTimeout(() => {
                document.getElementById('newMoldNumber').focus();
                
                // è®¾ç½®å¼€æ¨¡é€šçŸ¥æ—¥æœŸçš„é»˜è®¤å€¼ä¸ºå½“å‰æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('newMoldOpenNotice').value = today;
            }, 100);
            
            // äº‹ä»¶ç›‘å¬
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.cancel-create').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // è¡¨å•æäº¤
            document.getElementById('createMoldForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateMold(modal);
            });
            
            // å®æ—¶éªŒè¯æ¨¡å…·ç¼–å·
            document.getElementById('newMoldNumber').addEventListener('input', (e) => {
                const value = e.target.value.trim();
                const exists = moldsData.some(mold => mold.moldNumber === value);
                const input = e.target;
                
                if (exists && value) {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-gray-300');
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    let errorMsg = input.parentNode.querySelector('.error-msg');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'error-msg text-xs text-red-500 mt-1';
                        input.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = 'è¯¥ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç¼–å·';
                } else {
                    input.classList.remove('border-red-500', 'bg-red-50');
                    input.classList.add('border-gray-300');
                    
                    const errorMsg = input.parentNode.querySelector('.error-msg');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });
        }
        
        // å¤„ç†åˆ›å»ºæ¨¡å…·
        function handleCreateMold(modal) {
            const formData = {
                moldNumber: document.getElementById('newMoldNumber').value.trim(),
                moldName: document.getElementById('newMoldName').value.trim(),
                moldType: document.getElementById('newMoldType').value,
                version: document.getElementById('newVersion').value.trim(),
                productName: document.getElementById('newProductName').value.trim(),
                material: document.getElementById('newMaterial').value.trim(),
                cavityCount: document.getElementById('newCavityCount').value,
                moldOpenNotice: document.getElementById('newMoldOpenNotice').value,
                moldRemark: document.getElementById('newMoldRemark').value.trim(),
                initWithDefaultProcesses: document.getElementById('initWithDefaultProcesses').checked,
                autoSwitchToEdit: document.getElementById('autoSwitchToEdit').checked
            };
            
            // æ£€æŸ¥ç¼–å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆä»…å½“æä¾›äº†ç¼–å·æ—¶æ£€æŸ¥ï¼‰
            if (formData.moldNumber && moldsData.some(mold => mold.moldNumber === formData.moldNumber)) {
                showNotification('æ¨¡å…·ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç¼–å·', 'warning');
                document.getElementById('newMoldNumber').focus();
                return;
            }
            
            // åˆ›å»ºæ–°æ¨¡å…·ï¼ˆå³ä½¿æ²¡æœ‰æä¾›ç¼–å·å’Œåç§°ä¹Ÿå…è®¸åˆ›å»ºï¼‰
            const newMold = {
                id: nextMoldId++,
                moldNumber: formData.moldNumber || `MD${nextMoldId}`, // å¦‚æœæ²¡æœ‰æä¾›ç¼–å·ï¼Œä½¿ç”¨é»˜è®¤ç¼–å·
                moldName: formData.moldName || 'æœªå‘½åæ¨¡å…·', // å¦‚æœæ²¡æœ‰æä¾›åç§°ï¼Œä½¿ç”¨é»˜è®¤åç§°
                moldType: formData.moldType,
                version: formData.version,
                productName: formData.productName,
                material: formData.material,
                cavityCount: formData.cavityCount,
                moldOpenNotice: formData.moldOpenNotice,
                testDate: '',
                moldRemark: formData.moldRemark,
                processes: [],
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // å¦‚æœé€‰æ‹©åˆå§‹åŒ–é»˜è®¤å·¥åº
            if (formData.initWithDefaultProcesses) {
                newMold.processes = createDefaultProcesses(formData.moldOpenNotice);
            }
            
            moldsData.push(newMold);
            saveMoldsData();
            
            // å…³é—­æ¨¡æ€æ¡†
            document.body.removeChild(modal);
            
            // åˆ·æ–°åˆ—è¡¨
            renderMoldsList();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`æ¨¡å…·é¡¹ç›® "${newMold.moldNumber}" åˆ›å»ºæˆåŠŸ`, 'success');
            
            // å¦‚æœé€‰æ‹©è‡ªåŠ¨åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            if (formData.autoSwitchToEdit) {
                setTimeout(() => {
                    editMold(newMold.id);
                }, 500);
            }
        }
        
        // åˆ›å»ºé»˜è®¤å·¥åºæµç¨‹
        function createDefaultProcesses(startDate) {
            const defaultProcesses = [
                { name: 'è®¾è®¡è¯„å®¡', planDays: '', remark: '' },
                { name: 'ææ–™é‡‡è´­', planDays: '', remark: '' },
                { name: 'æ·±å­”é’»/é“£åºŠåŠ å·¥', planDays: '', remark: '' },
                { name: 'CNCç²—åŠ å·¥', planDays: '', remark: '' },
                { name: 'çƒ­å¤„ç†/ç£¨åºŠåŠ å·¥', planDays: '', remark: '' },
                { name: 'çº¿å‰²åŠ å·¥', planDays: '', remark: '' },
                { name: 'CNCç²¾åŠ å·¥', planDays: '', remark: '' },
                { name: 'EDMåŠ å·¥', planDays: '', remark: '' },
                { name: 'çœæ¨¡/æŠ›å…‰', planDays: '', remark: '' },
                { name: 'é…è£…åˆæ¨¡', planDays: '', remark: '' },
                { name: 'è¯•æ¨¡', planDays: '', remark: '' }
            ];
            
            const processes = [];
            let currentDate = startDate ? new Date(startDate) : new Date();
            let processId = 1;
            
            defaultProcesses.forEach((process) => {
                const planStart = formatDate(currentDate);
                
                const endDate = new Date(currentDate);
                if (process.planDays > 1) {
                    endDate.setDate(endDate.getDate() + process.planDays - 1);
                }
                const planEnd = formatDate(endDate);
                
                processes.push({
                    id: processId++,
                    name: process.name,
                    planStart,
                    planEnd,
                    planDays: process.planDays,
                    actualStart: '',
                    actualEnd: '',
                    actualDays: '',
                    status: 'pending',
                    remark: process.remark
                });
                
                currentDate = new Date(endDate);
            });
            
            return processes;
        }
        
        // æ¸²æŸ“æ¨¡å…·åˆ—è¡¨ - ç°ä»£åŒ–å¡ç‰‡å¸ƒå±€ï¼ˆå¢å¼ºç‰ˆï¼‰
        function renderMoldsList() {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateMoldsStatistics();
            
            const filteredMolds = getFilteredMolds();
            const moldsGridElement = document.getElementById('moldsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // æ›´æ–°ç­›é€‰è®¡æ•°
            const filteredCountElement = document.getElementById('filteredCount');
            if (filteredCountElement) {
                filteredCountElement.textContent = filteredMolds.length;
            }
            
            if (filteredMolds.length === 0) {
                moldsGridElement.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            moldsGridElement.innerHTML = filteredMolds.map(mold => {
                // ä½¿ç”¨å¢å¼ºçš„è¿›åº¦è®¡ç®—
                const progress = mold.progress || calculateMoldProgress(mold.processes);
                const totalDays = mold.totalDays || calculateTotalPlanDays(mold.processes);
                const completedDays = mold.completedDays || calculateCompletedDays(mold.processes);
                
                // è·å–å½“å‰å·¥åºå’Œä¸‹ä¸€ä¸ªå·¥åºä¿¡æ¯
                const processInfo = getCurrentAndNextProcessInfo(mold);
                
                // è®¡ç®—å‰©ä½™å¤©æ•°
                const remainingDays = Math.max(0, totalDays - completedDays);
                
                // è·å–è¿›åº¦æ¡é¢œè‰²
                const progressColor = progress >= 100 ? 'from-green-500 to-green-600' : 
                                    progress >= 50 ? 'from-blue-500 to-blue-600' : 
                                    'from-orange-500 to-orange-600';
                
                return `
                    <div class="mold-card mold-card-details bg-white rounded-lg border border-gray-200 hover:shadow-md hover:border-blue-400 transition-all duration-200 group overflow-hidden" 
                         data-id="${mold.id}">
                        
                        <!-- ä¼˜åŒ–å¡ç‰‡å¤´éƒ¨ -->
                        <div class="p-3 border-b border-gray-200">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex items-start gap-2 flex-1 min-w-0">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-semibold text-gray-900 text-sm mb-0.5 truncate">${mold.moldNumber}</h3>
                                        <p class="text-gray-600 text-xs truncate">${mold.moldName || 'æœªå‘½åæ¨¡å…·'}</p>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(mold.status)}">
                                        ${getStatusText(mold.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¼˜åŒ–å¡ç‰‡å†…å®¹ -->
                        <div class="p-3 space-y-3">
                            <!-- åŸºæœ¬ä¿¡æ¯ç½‘æ ¼ -->
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex items-center">
                                    <span class="detail-label">äº§å“åç§°:</span>
                                    <span class="detail-value truncate">${mold.productName || 'æœªè®¾ç½®'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">æ¨¡å…·ç±»å‹:</span>
                                    <span class="detail-value truncate">${mold.moldType || 'æœªè®¾ç½®'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">äº§å“ææ–™:</span>
                                    <span class="detail-value truncate">${mold.material || 'æœªè®¾ç½®'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">æ€»å·¥æœŸ:</span>
                                    <span class="detail-value font-semibold">${totalDays}å¤©</span>
                                </div>
                            </div>
                            
                            <!-- å·¥åºè¿›åº¦çŠ¶æ€ -->
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="card-section-title">å·¥åºçŠ¶æ€</div>
                                <div class="space-y-2">
                                    <div class="flex items-center text-xs">
                                        <span class="detail-label">å½“å‰å·¥åº:</span>
                                        <span class="detail-value truncate">
                                            <span class="process-status-indicator ${processInfo.current.color.includes('blue') ? 'process-status-progress' : processInfo.current.color.includes('green') ? 'process-status-completed' : 'process-status-pending'}"></span>
                                            ${processInfo.current.text.replace('ğŸ”„ ', '').replace('â³ ', '').replace('âœ… ', '')}
                                        </span>
                                    </div>
                                    <div class="flex items-center text-xs">
                                        <span class="detail-label">ä¸‹ä¸€å·¥åº:</span>
                                        <span class="detail-value truncate">
                                            <span class="process-status-indicator ${processInfo.next.color.includes('blue') ? 'process-status-progress' : processInfo.next.color.includes('green') ? 'process-status-completed' : 'process-status-pending'}"></span>
                                            ${processInfo.next.text.replace('ğŸ”„ ', '').replace('â³ ', '').replace('âœ… ', '')}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è¿›åº¦æ¡ -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600">å®Œæˆè¿›åº¦</span>
                                    <span class="text-xs font-semibold text-gray-900">${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div class="bg-gradient-to-r ${progressColor} h-2 rounded-full transition-all duration-500 ease-out" 
                                         style="width: ${progress}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 text-center">
                                    ${mold.processes ? mold.processes.filter(p => p.status === 'completed').length : 0}/${mold.processes ? mold.processes.length : 0} å·¥åºå®Œæˆ
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¼˜åŒ–æ“ä½œæŒ‰é’® -->
                        <div class="px-3 py-2 bg-gray-50 border-t border-gray-200">
                            <div class="flex gap-2">
                                <button class="edit-mold flex-1 px-2 py-1.5 text-xs font-medium bg-white text-blue-600 border border-blue-300 hover:bg-blue-50 active:bg-blue-100 transition-all duration-200 rounded-lg" data-id="${mold.id}">
                                    ç¼–è¾‘
                                </button>
                                <button class="export-mold px-2 py-1.5 text-xs font-medium bg-white text-green-600 border border-green-300 hover:bg-green-50 active:bg-green-100 transition-all duration-200 rounded-lg" data-id="${mold.id}" title="å¯¼å‡ºExcel">
                                    å¯¼å‡º
                                </button>
                                <button class="delete-mold px-2 py-1.5 text-xs font-medium bg-white text-red-600 border border-red-300 hover:bg-red-50 active:bg-red-100 transition-all duration-200 rounded-lg" data-id="${mold.id}" title="åˆ é™¤æ¨¡å…·">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            attachMoldCardListeners();
        }
        
        // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
        function formatRelativeTime(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;
            
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }
        
        // è·å–å½“å‰è¿›è¡Œä¸­çš„å·¥åºä¿¡æ¯ - ä¿®å¤ç‰ˆ
        function getCurrentProcessInfo(mold) {
            if (!mold.processes || mold.processes.length === 0) {
                return {
                    text: 'æš‚æ— å·¥åº',
                    color: 'text-gray-500',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">å½“å‰å·¥åº:</span>
                        <span class="text-gray-400">æš‚æ— å·¥åº</span>
                    </div>`
                };
            }
            
            // æŸ¥æ‰¾è¿›è¡Œä¸­çš„å·¥åº
            const inProgressProcess = mold.processes.find(p => p.status === 'inProgress');
            if (inProgressProcess) {
                return {
                    text: `ğŸ”„ ${inProgressProcess.name}`,
                    color: 'text-blue-600',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">å½“å‰å·¥åº:</span>
                        <span class="text-blue-600 font-medium">ğŸ”„ ${inProgressProcess.name}</span>
                    </div>`
                };
            }
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¾…å¼€å§‹çš„å·¥åº
            const nextProcess = mold.processes.find(p => p.status === 'pending');
            if (nextProcess) {
                return {
                    text: `â³ ${nextProcess.name}`,
                    color: 'text-orange-600',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">ä¸‹ä¸€å·¥åº:</span>
                        <span class="text-orange-600">â³ ${nextProcess.name}</span>
                    </div>`
                };
            }
            
            // æŸ¥æ‰¾æœ€åå®Œæˆçš„å·¥åº
            const completedProcesses = mold.processes.filter(p => p.status === 'completed');
            if (completedProcesses.length > 0) {
                const lastCompleted = completedProcesses[completedProcesses.length - 1];
                if (completedProcesses.length === mold.processes.length) {
                    return {
                        text: `âœ… å…¨éƒ¨å®Œæˆ`,
                        color: 'text-green-600',
                        html: `<div class="flex justify-between text-sm">
                            <span class="text-gray-500">çŠ¶æ€:</span>
                            <span class="text-green-600 font-medium">âœ… å…¨éƒ¨å®Œæˆ</span>
                        </div>`
                    };
                } else {
                    return {
                        text: `âœ… ${lastCompleted.name}`,
                        color: 'text-green-600',
                        html: `<div class="flex justify-between text-sm">
                            <span class="text-gray-500">æœ€åå®Œæˆ:</span>
                            <span class="text-green-600">âœ… ${lastCompleted.name}</span>
                        </div>`
                    };
                }
            }
            
            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå·¥åºï¼ˆå¦‚æœéƒ½æ˜¯å¾…å¼€å§‹çŠ¶æ€ï¼‰
            const firstProcess = mold.processes[0];
            return {
                text: `é¦–ä¸ª: ${firstProcess.name}`,
                color: 'text-blue-600',
                html: `<div class="flex justify-between text-sm">
                    <span class="text-gray-500">é¦–ä¸ªå·¥åº:</span>
                    <span class="text-blue-600">${firstProcess.name}</span>
                </div>`
            };
        }
        
        // è·å–å½“å‰å·¥åºå’Œä¸‹ä¸€ä¸ªå·¥åºä¿¡æ¯
        function getCurrentAndNextProcessInfo(mold) {
            if (!mold.processes || mold.processes.length === 0) {
                return {
                    current: { text: 'æš‚æ— å·¥åº', color: 'text-gray-500' },
                    next: { text: 'æš‚æ— å·¥åº', color: 'text-gray-500' }
                };
            }
            
            // æŸ¥æ‰¾è¿›è¡Œä¸­çš„å·¥åº
            const inProgressProcess = mold.processes.find(p => p.status === 'inProgress');
            if (inProgressProcess) {
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¾…å¼€å§‹çš„å·¥åº
                const currentIndex = mold.processes.indexOf(inProgressProcess);
                const nextProcess = mold.processes.find((p, index) => index > currentIndex && p.status === 'pending');
                
                return {
                    current: { 
                        text: `ğŸ”„ ${inProgressProcess.name}`, 
                        color: 'text-blue-600' 
                    },
                    next: nextProcess ? { 
                        text: `â³ ${nextProcess.name}`, 
                        color: 'text-orange-600' 
                    } : { 
                        text: 'æ— ä¸‹ä¸€å·¥åº', 
                        color: 'text-gray-500' 
                    }
                };
            }
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¾…å¼€å§‹çš„å·¥åºï¼ˆå¦‚æœæ²¡æœ‰è¿›è¡Œä¸­çš„å·¥åºï¼‰
            const nextProcess = mold.processes.find(p => p.status === 'pending');
            if (nextProcess) {
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¾…å¼€å§‹çš„å·¥åºä¹‹åçš„å·¥åº
                const currentIndex = mold.processes.indexOf(nextProcess);
                const followingProcess = mold.processes.find((p, index) => index > currentIndex && p.status === 'pending');
                
                return {
                    current: { 
                        text: `â³ ${nextProcess.name}`, 
                        color: 'text-orange-600' 
                    },
                    next: followingProcess ? { 
                        text: `â³ ${followingProcess.name}`, 
                        color: 'text-orange-600' 
                    } : { 
                        text: 'æ— ä¸‹ä¸€å·¥åº', 
                        color: 'text-gray-500' 
                    }
                };
            }
            
            // æŸ¥æ‰¾æœ€åå®Œæˆçš„å·¥åº
            const completedProcesses = mold.processes.filter(p => p.status === 'completed');
            if (completedProcesses.length > 0) {
                const lastCompleted = completedProcesses[completedProcesses.length - 1];
                if (completedProcesses.length === mold.processes.length) {
                    return {
                        current: { 
                            text: `âœ… å…¨éƒ¨å®Œæˆ`, 
                            color: 'text-green-600' 
                        },
                        next: { 
                            text: 'å·²å®Œæˆ', 
                            color: 'text-green-600' 
                        }
                    };
                } else {
                    return {
                        current: { 
                            text: `âœ… ${lastCompleted.name}`, 
                            color: 'text-green-600' 
                        },
                        next: { 
                            text: 'æ— ä¸‹ä¸€å·¥åº', 
                            color: 'text-gray-500' 
                        }
                    };
                }
            }
            
            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå·¥åºï¼ˆå¦‚æœéƒ½æ˜¯å¾…å¼€å§‹çŠ¶æ€ï¼‰
            const firstProcess = mold.processes[0];
            const secondProcess = mold.processes.length > 1 ? mold.processes[1] : null;
            
            return {
                current: { 
                    text: `â³ ${firstProcess.name}`, 
                    color: 'text-orange-600' 
                },
                next: secondProcess ? { 
                    text: `â³ ${secondProcess.name}`, 
                    color: 'text-orange-600' 
                } : { 
                    text: 'æ— ä¸‹ä¸€å·¥åº', 
                    color: 'text-gray-500' 
                }
            };
        }
        
        // è·å–è¿‡æ»¤åçš„æ¨¡å…·åˆ—è¡¨
        function getFilteredMolds() {
            let filtered = [...moldsData];
            
            // æœç´¢è¿‡æ»¤
            const searchTerm = searchMolds.value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(mold => 
                    mold.moldNumber.toLowerCase().includes(searchTerm) ||
                    mold.moldName.toLowerCase().includes(searchTerm) ||
                    mold.productName.toLowerCase().includes(searchTerm)
                );
            }
            
            // çŠ¶æ€è¿‡æ»¤
            const statusValue = statusFilter.value;
            if (statusValue) {
                filtered = filtered.filter(mold => mold.status === statusValue);
            }
            
            // æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
            return filtered.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }
        
        // è¿‡æ»¤æ¨¡å…·
        function filterMolds() {
            renderMoldsList();
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'status-active';
                case 'completed': return 'status-completed';
                case 'pending': return 'status-pending';
                default: return 'status-pending';
            }
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch (status) {
                case 'active': return 'è¿›è¡Œä¸­';
                case 'completed': return 'å·²å®Œæˆ';
                case 'pending': return 'å¾…å¼€å§‹';
                default: return 'å¾…å¼€å§‹';
            }
        }
        
        // ä¸ºæ¨¡å…·å¡ç‰‡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function attachMoldCardListeners() {
            console.log('ç»‘å®šæ¨¡å…·å¡ç‰‡äº‹ä»¶ç›‘å¬å™¨'); // è°ƒè¯•ä¿¡æ¯
            console.log('å½“å‰æ¨¡å…·æ•°æ®:', moldsData); // è°ƒè¯•ä¿¡æ¯
            
            // ç¼–è¾‘æ¨¡å…·
            document.querySelectorAll('.edit-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    editMold(moldId);
                });
            });
            
            // é¢„è§ˆæ¨¡å…·
            document.querySelectorAll('.preview-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    previewMold(moldId);
                });
            });
            
            // å¯¼å‡ºæ¨¡å…·
            document.querySelectorAll('.export-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    exportMoldToExcel(moldId);
                });
            });
            
            // åˆ é™¤æ¨¡å…·
            document.querySelectorAll('.delete-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    deleteMold(moldId);
                });
            });
            
            // ç‚¹å‡»æ¨¡å…·å¡ç‰‡è¿›å…¥ç¼–è¾‘ï¼ˆæ’é™¤æŒ‰é’®ï¼‰
            document.querySelectorAll('.mold-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                    if (e.target.closest('button')) return;
                    
                    const moldId = parseInt(card.dataset.id);
                    editMold(moldId);
                });
            });
        }
        
        // ç¼–è¾‘æ¨¡å…·
        function editMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('æ¨¡å…·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // åŠ è½½æ¨¡å…·æ•°æ®åˆ°å½“å‰ç¼–è¾‘ç•Œé¢
            currentMoldId = moldId;
            loadMoldToEditor(mold);
            switchPage('tracking');
            showNotification(`æ­£åœ¨ç¼–è¾‘æ¨¡å…·: ${mold.moldNumber}`, 'info');
        }
        
        // é¢„è§ˆæ¨¡å…·
        function previewMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('æ¨¡å…·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // åŠ è½½æ¨¡å…·æ•°æ®åˆ°é¢„è§ˆç•Œé¢ï¼ˆåªè¯»æ¨¡å¼ï¼‰
            loadMoldToEditor(mold, true);
            switchPage('tracking');
            showNotification(`æ­£åœ¨é¢„è§ˆæ¨¡å…·: ${mold.moldNumber}`, 'info');
        }
        
        // å¯¼å‡ºå•ä¸ªæ¨¡å…·åˆ°Excel
        function exportMoldToExcel(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('æ¨¡å…·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // ä¸´æ—¶åŠ è½½æ¨¡å…·æ•°æ®å¹¶å¯¼å‡º
            const originalData = { ...getCurrentMoldData() };
            const originalProcessData = [...processData];
            
            loadMoldToEditor(mold);
            
            // æ‰§è¡Œå¯¼å‡º
            setTimeout(() => {
                exportToExcel();
                
                // æ¢å¤åŸå§‹æ•°æ®
                loadMoldToEditor(originalData);
                processData = originalProcessData;
                renderProcessTable();
                updateCycleStatistics();
            }, 100);
        }
        
        // åˆ é™¤æ¨¡å…·
        function deleteMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('æ¨¡å…·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å…· "${mold.moldNumber}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                moldsData = moldsData.filter(m => m.id !== moldId);
                saveMoldsData();
                renderMoldsList();
                showNotification('æ¨¡å…·å·²åˆ é™¤', 'success');
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç¼–è¾‘çš„æ¨¡å…·ï¼Œæ¸…ç©ºç¼–è¾‘å™¨
                if (currentMoldId === moldId) {
                    currentMoldId = null;
                    clearEditor();
                }
            }
        }
        
        
        
        // åŠ è½½æ¨¡å…·æ•°æ®åˆ°ç¼–è¾‘å™¨
        function loadMoldToEditor(mold, readOnly = false) {
            // åŠ è½½åŸºæœ¬ä¿¡æ¯
            document.getElementById('moldNumber').value = mold.moldNumber || '';
            document.getElementById('moldName').value = mold.moldName || '';
            document.getElementById('moldType').value = mold.moldType || '';
            document.getElementById('version').value = mold.version || '';
            document.getElementById('productName').value = mold.productName || '';
            document.getElementById('material').value = mold.material || '';
            document.getElementById('cavityCount').value = mold.cavityCount || '';
            document.getElementById('moldOpenNotice').value = mold.moldOpenNotice || '';
            document.getElementById('testDate').value = mold.testDate || '';
            document.getElementById('moldRemark').value = mold.moldRemark || '';
            
            // åŠ è½½å·¥åºæ•°æ®
            processData = mold.processes || [];
            nextProcessId = Math.max(...processData.map(p => p.id), 0) + 1;
            
            // è®¾ç½®åªè¯»æ¨¡å¼
            if (readOnly) {
                setEditorReadOnly(true);
            } else {
                setEditorReadOnly(false);
            }
            
            renderProcessTable();
            updateCycleStatistics();
        }
        
        // è·å–å½“å‰æ¨¡å…·æ•°æ®
        function getCurrentMoldData() {
            return {
                moldNumber: document.getElementById('moldNumber').value.trim(),
                moldName: document.getElementById('moldName').value.trim(),
                moldType: document.getElementById('moldType').value.trim(),
                version: document.getElementById('version').value.trim(),
                productName: document.getElementById('productName').value.trim(),
                material: document.getElementById('material').value.trim(),
                cavityCount: document.getElementById('cavityCount').value.trim(),
                moldOpenNotice: document.getElementById('moldOpenNotice').value,
                testDate: document.getElementById('testDate').value,
                moldRemark: document.getElementById('moldRemark').value.trim(),
                processes: [...processData]
            };
        }
        
        // è®¾ç½®ç¼–è¾‘å™¨åªè¯»æ¨¡å¼
        function setEditorReadOnly(readOnly) {
            const inputs = document.querySelectorAll('#trackingPage input, #trackingPage textarea, #trackingPage select');
            const buttons = document.querySelectorAll('#trackingPage button');
            
            inputs.forEach(input => {
                input.disabled = readOnly;
            });
            
            buttons.forEach(button => {
                if (readOnly && !button.id.includes('export')) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            document.getElementById('moldNumber').value = '';
            document.getElementById('moldName').value = '';
            document.getElementById('moldType').value = '';
            document.getElementById('version').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('material').value = '';
            document.getElementById('cavityCount').value = '';
            document.getElementById('moldOpenNotice').value = '';
            document.getElementById('testDate').value = '';
            document.getElementById('moldRemark').value = '';
            
            processData = [];
            nextProcessId = 1;
            currentMoldId = null;
            
            renderProcessTable();
            updateCycleStatistics();
            setEditorReadOnly(false);
        }
        
        // æ–°å¢æ™ºèƒ½åŒ–è¾…åŠ©å‡½æ•°
        
        // è‡ªåŠ¨ä¿å­˜å¹¶åŒæ­¥æ•°æ®
        function autoSaveWithSync() {
            try {
                // ä¿å­˜å½“å‰æ•°æ®
                const result = saveData();
                
                if (result) {
                    // æ”¶é›†æ¨¡å…·åŸºæœ¬ä¿¡æ¯
                    const moldInfo = {
                        moldNumber: document.getElementById('moldNumber').value.trim(),
                        moldName: document.getElementById('moldName').value.trim(),
                        moldType: document.getElementById('moldType').value.trim(),
                        version: document.getElementById('version').value.trim(),
                        productName: document.getElementById('productName').value.trim(),
                        material: document.getElementById('material').value.trim(),
                        cavityCount: document.getElementById('cavityCount').value.trim(),
                        moldOpenNotice: document.getElementById('moldOpenNotice').value,
                        testDate: document.getElementById('testDate').value,
                        moldRemark: document.getElementById('moldRemark').value.trim()
                    };
                    
                    // åŒæ­¥åˆ°æ¨¡å…·ç®¡ç†åˆ—è¡¨
                    syncToMoldManagement(moldInfo, processData);
                }
                
                return result;
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜åŒæ­¥å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ™ºèƒ½è®¾ç½®å·¥åºé»˜è®¤å€¼
        function autoSetProcessDefaults(process) {
            const processDefaults = {
                'è®¾è®¡è¯„å®¡': { days: 2, remark: 'å›¾çº¸å®¡æ ¸ã€å·¥è‰ºè¯„ä¼°' },
                'ææ–™é‡‡è´­': { days: 3, remark: 'é’¢æã€æ ‡å‡†ä»¶é‡‡è´­' },
                'æ·±å­”é’»': { days: 4, remark: 'æ¨¡æ¿åŠ å·¥ã€æ·±å­”é’»å‰Š' },
                'é“£åºŠåŠ å·¥': { days: 4, remark: 'æ¨¡æ¿åŠ å·¥ã€æ·±å­”é’»å‰Š' },
                'CNCç²—åŠ å·¥': { days: 5, remark: 'æ¯›å¯CNCç²—åŠ å·¥æˆå‹' },
                'çƒ­å¤„ç†': { days: 2, remark: 'æ·¬ç«å›ç«å¤„ç†' },
                'ç£¨åºŠåŠ å·¥': { days: 2, remark: 'æ·¬ç«å›ç«ã€ç²¾å¯†ç£¨å‰Š' },
                'çº¿å‰²': { days: 3, remark: 'ç²¾å¯†çº¿åˆ‡å‰²åŠ å·¥' },
                'çº¿å‰²åŠ å·¥': { days: 3, remark: 'ç²¾å¯†çº¿åˆ‡å‰²åŠ å·¥' },
                'CNCç²¾åŠ å·¥': { days: 7, remark: 'ç²¾å¯†é“£å‰Šã€é’»å­”æ”»ä¸' },
                'EDM': { days: 4, remark: 'ç”µç«èŠ±åŠ å·¥æˆå‹' },
                'EDMåŠ å·¥': { days: 4, remark: 'ç”µç«èŠ±åŠ å·¥æˆå‹' },
                'çœæ¨¡': { days: 2, remark: 'æ¨¡å…·æŠ›å…‰ã€è¡¨é¢å¤„ç†' },
                'æŠ›å…‰': { days: 2, remark: 'æ¨¡å…·æŠ›å…‰ã€è¡¨é¢å¤„ç†' },
                'é…è£…': { days: 3, remark: 'é›¶ä»¶è£…é…ã€è¯•åˆæ¨¡' },
                'åˆæ¨¡': { days: 3, remark: 'é›¶ä»¶è£…é…ã€è¯•åˆæ¨¡' },
                'è¯•æ¨¡': { days: 1, remark: 'é¦–æ¬¡è¯•æ¨¡éªŒè¯' }
            };
            
            // æŸ¥æ‰¾åŒ¹é…çš„é»˜è®¤è®¾ç½®
            for (const [key, defaults] of Object.entries(processDefaults)) {
                if (process.name.includes(key)) {
                    if (!process.planDays || process.planDays === 0) {
                        process.planDays = defaults.days;
                    }
                    if (!process.remark) {
                        process.remark = defaults.remark;
                    }
                    
                    // å¦‚æœæœ‰å¼€å§‹æ—¥æœŸï¼Œè‡ªåŠ¨è®¡ç®—ç»“æŸæ—¥æœŸ
                    if (process.planStart && process.planDays > 0) {
                        calculateAndUpdatePlanEnd(process.id);
                    }
                    break;
                }
            }
        }
        
        // å¤„ç†ç¬¬ä¸€é“å·¥åºæ—¥æœŸå˜æ›´
        function handleFirstProcessDateChange(process) {
            // è‡ªåŠ¨è®¾ç½®å¤©æ•°ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            if (!process.planDays || process.planDays === 0) {
                autoSetProcessDefaults(process);
            }
            
            // è®¡ç®—ç»“æŸæ—¥æœŸ
            if (process.planStart && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
            
            // é‡æ–°è®¡ç®—æ‰€æœ‰åç»­å·¥åº
            fullIntelligentRecalculation();
            
            // æ›´æ–°ç•Œé¢
            renderProcessTable();
            updateCycleStatistics();
            
            showNotification('ç¬¬ä¸€é“å·¥åºæ—¥æœŸå·²æ›´æ–°ï¼Œæ‰€æœ‰åç»­å·¥åºå·²è‡ªåŠ¨æ¨ç®—', 'success');
        }
        
        // å¤„ç†åç»­å·¥åºæ—¥æœŸå˜æ›´
        function handleSubsequentProcessDateChange(process, processIndex) {
            // è®¡ç®—ç»“æŸæ—¥æœŸ
            if (process.planStart && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
            
            // æ›´æ–°åç»­å·¥åº
            updateSubsequentPlansIntelligent(processIndex);
            
            // æ›´æ–°ç•Œé¢
            renderProcessTable();
            updateCycleStatistics();
            
            showNotification('è®¡åˆ’æ—¥æœŸå·²æ›´æ–°ï¼Œåç»­å·¥åºå·²è‡ªåŠ¨è°ƒæ•´', 'success');
        }
        
        // å¤„ç†è®¡åˆ’å¤©æ•°å˜æ›´
        function handlePlanDaysChange(process, processIndex, oldDays, newDays) {
            if (newDays > 0) {
                // å¦‚æœæœ‰å¼€å§‹æ—¥æœŸï¼Œé‡æ–°è®¡ç®—ç»“æŸæ—¥æœŸ
                if (process.planStart) {
                    calculateAndUpdatePlanEnd(process.id);
                }
                
                // æ›´æ–°åç»­å·¥åº
                updateSubsequentPlansIntelligent(processIndex);
                
                // æ›´æ–°ç•Œé¢
                renderProcessTable();
                updateCycleStatistics();
                
                showNotification(`å·¥åº"${process.name}"å¤©æ•°å·²æ›´æ–°ä¸º${newDays}å¤©ï¼Œæ—¥æœŸå·²è‡ªåŠ¨è®¡ç®—`, 'success');
            } else {
                // å¤©æ•°ä¸º0æˆ–ç©ºï¼Œæ¸…ç©ºç»“æŸæ—¥æœŸ
                process.planEnd = '';
                renderProcessTable();
                updateCycleStatistics();
            }
        }
        
        // å¤„ç†çŠ¶æ€å˜æ›´
        function handleStatusChange(process, oldStatus, newStatus) {
            const now = new Date();
            const today = formatDate(now);
            
            // æ ¹æ®çŠ¶æ€å˜æ›´è‡ªåŠ¨è®¾ç½®å®é™…æ—¥æœŸ
            if (newStatus === 'inProgress' && oldStatus === 'pending') {
                // å¼€å§‹å·¥åº
                if (!process.actualStart) {
                    process.actualStart = today;
                    showNotification(`å·¥åº"${process.name}"å·²å¼€å§‹ï¼Œå®é™…å¼€å§‹æ—¥æœŸè®¾ä¸ºä»Šå¤©`, 'info');
                }
            } else if (newStatus === 'completed' && oldStatus === 'inProgress') {
                // å®Œæˆå·¥åº
                if (!process.actualEnd) {
                    process.actualEnd = today;
                }
                
                // è‡ªåŠ¨è®¡ç®—å®é™…å¤©æ•°
                if (process.actualStart && process.actualEnd) {
                    calculateAndUpdateActualDays(process.id);
                }
                
                showNotification(`å·¥åº"${process.name}"å·²å®Œæˆï¼Œå®é™…ç»“æŸæ—¥æœŸè®¾ä¸ºä»Šå¤©`, 'success');
            }
        }
        
        // æ˜¾ç¤ºå·¥åºå»ºè®®
        function showProcessSuggestions(input) {
            // è¿™é‡Œå¯ä»¥å®ç°å·¥åºåç§°çš„æ™ºèƒ½æç¤ºåŠŸèƒ½
            // æš‚æ—¶ç®€åŒ–å¤„ç†
        }
        
        // è®¡ç®—æ¨¡å…·è¿›åº¦ç™¾åˆ†æ¯”
        function calculateMoldProgress(processes) {
            if (!processes || processes.length === 0) return 0;
            const completedCount = processes.filter(p => p.status === 'completed').length;
            return Math.round((completedCount / processes.length) * 100);
        }
        
        // è·å–å½“å‰å·¥åºåç§°
        function getCurrentProcessName(processes) {
            if (!processes || processes.length === 0) return 'æš‚æ— å·¥åº';
            
            const inProgress = processes.find(p => p.status === 'inProgress');
            if (inProgress) return inProgress.name;
            
            const nextPending = processes.find(p => p.status === 'pending');
            if (nextPending) return `å¾…å¼€å§‹: ${nextPending.name}`;
            
            const lastCompleted = processes.filter(p => p.status === 'completed').pop();
            if (lastCompleted) return `å·²å®Œæˆ: ${lastCompleted.name}`;
            
            return processes[0].name;
        }
        
        // è®¡ç®—æ€»è®¡åˆ’å¤©æ•°
        function calculateTotalPlanDays(processes) {
            if (!processes || processes.length === 0) return 0;
            return processes.reduce((sum, p) => sum + (parseInt(p.planDays) || 0), 0);
        }
        
        // è®¡ç®—å·²å®Œæˆå¤©æ•°
        function calculateCompletedDays(processes) {
            if (!processes || processes.length === 0) return 0;
            return processes
                .filter(p => p.status === 'completed')
                .reduce((sum, p) => sum + (parseInt(p.actualDays) || parseInt(p.planDays) || 0), 0);
        }
        
        // é‡å†™ä¿å­˜æ•°æ®å‡½æ•°ä»¥æ”¯æŒæ¨¡å…·ç®¡ç†
        const originalSaveData = saveData;
        saveData = function() {
            const result = originalSaveData();
            
            if (result && currentMoldId) {
                // æ›´æ–°æ¨¡å…·ç®¡ç†ä¸­çš„æ•°æ®
                const moldIndex = moldsData.findIndex(m => m.id === currentMoldId);
                if (moldIndex !== -1) {
                    const currentData = getCurrentMoldData();
                    moldsData[moldIndex] = {
                        ...moldsData[moldIndex],
                        ...currentData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // æ›´æ–°çŠ¶æ€å’Œè¿›åº¦ä¿¡æ¯
                    moldsData[moldIndex].status = calculateMoldStatus(processData);
                    moldsData[moldIndex].progress = calculateMoldProgress(processData);
                    moldsData[moldIndex].currentProcess = getCurrentProcessName(processData);
                    moldsData[moldIndex].totalDays = calculateTotalPlanDays(processData);
                    moldsData[moldIndex].completedDays = calculateCompletedDays(processData);
                    
                    saveMoldsData();
                }
            }
            
            return result;
        };
        
        // ==================== åˆ—å®½è°ƒæ•´åŠŸèƒ½ ====================
        
        // åˆå§‹åŒ–åˆ—å®½è°ƒæ•´åŠŸèƒ½
        function initColumnResizer() {
            const tables = document.querySelectorAll('.resizable-table');
            
            tables.forEach(table => {
                const resizers = table.querySelectorAll('.column-resizer');
                
                resizers.forEach(resizer => {
                    let isResizing = false;
                    let startX = 0;
                    let startWidth = 0;
                    let currentTh = null;
                    
                    resizer.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        startX = e.clientX;
                        currentTh = resizer.parentElement;
                        startWidth = parseInt(window.getComputedStyle(currentTh).width, 10);
                        
                        resizer.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        
                        e.preventDefault();
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        
                        const width = startWidth + e.clientX - startX;
                        const minWidth = 50; // æœ€å°åˆ—å®½
                        const maxWidth = 500; // æœ€å¤§åˆ—å®½
                        
                        if (width >= minWidth && width <= maxWidth) {
                            currentTh.style.width = width + 'px';
                            
                            // åŒæ­¥æ›´æ–°å¯¹åº”çš„tbodyä¸­çš„å•å…ƒæ ¼å®½åº¦
                            const columnIndex = Array.from(currentTh.parentElement.children).indexOf(currentTh);
                            const tbody = table.querySelector('tbody');
                            if (tbody) {
                                const rows = tbody.querySelectorAll('tr');
                                rows.forEach(row => {
                                    const cell = row.children[columnIndex];
                                    if (cell) {
                                        cell.style.width = width + 'px';
                                    }
                                });
                            }
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        if (isResizing) {
                            isResizing = false;
                            resizer.classList.remove('resizing');
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            currentTh = null;
                        }
                    });
                });
            });
        }
        
        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åˆ—å®½è°ƒæ•´åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿è¡¨æ ¼å·²ç»æ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                initColumnResizer();
            }, 500);
        });
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼åé‡æ–°åˆå§‹åŒ–åˆ—å®½è°ƒæ•´åŠŸèƒ½
        const originalRenderProcessTable = renderProcessTable;
        renderProcessTable = function() {
            originalRenderProcessTable();
            setTimeout(() => {
                initColumnResizer();
            }, 100);
        };
        
        const originalRenderMoldsList = renderMoldsList;
        renderMoldsList = function() {
            originalRenderMoldsList();
            setTimeout(() => {
                initColumnResizer();
            }, 100);
        };
    </script>


</body>
</html>
</html>
