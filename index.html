<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模具制造工艺流程跟踪系统</title>
    <!-- 生产环境使用独立的Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        pending: '#94a3b8',
                        neutral: '#64748b',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-bg {
                transition: background-color 0.3s ease;
            }
            .transition-transform {
                transition: transform 0.2s ease;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
            }
            .process-name-col {
                width: 150px;
                min-width: 150px;
            }
            .date-col {
                width: 75px;
                min-width: 75px;
            }
            .plan-days-col, .actual-days-col {
                width: 80px;
                min-width: 80px;
            }
            .remark-col {
                min-width: 140px;
            }
            .serial-number-col {
                width: 50px;
                min-width: 50px;
            }
            .status-col {
                width: 85px;
                min-width: 85px;
            }
            .action-col {
                width: 90px;
                min-width: 90px;
            }
            .status-badge {
                transition: all 0.2s ease;
            }
            .status-badge:hover {
                transform: scale(1.05);
            }
            input[type="date"] {
                position: relative;
            }
            input[type="date"]::-webkit-calendar-picker-indicator {
                background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat center;
                background-size: 16px 16px;
                padding: 8px;
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                opacity: 0.7;
            }
            
            input[type="date"]::-webkit-calendar-picker-indicator:hover {
                opacity: 1;
            }
            
            /* 确保日期输入框完全可用 */
            input[type="date"] {
                -webkit-appearance: none;
                -moz-appearance: textfield;
                appearance: none;
                background: white;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                padding: 8px 40px 8px 12px;
                font-size: 14px;
                line-height: 1.5;
                color: #374151;
            }
            
            input[type="date"]:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            /* 修复Firefox日期选择器 */
            input[type="date"]::-moz-focus-inner {
                border: 0;
                padding: 0;
            }
            .date-picker-wrapper {
                position: relative;
            }
            /* 优化的统计卡片样式 */
            .stat-card {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                border: 1px solid #e2e8f0;
            }
            .stat-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                opacity: 0.8;
                transition: opacity 0.3s ease;
            }
            .stat-card.primary::before {
                background: linear-gradient(to bottom, #3b82f6, #2563eb);
            }
            .stat-card.success::before {
                background: linear-gradient(to bottom, #10b981, #059669);
            }
            .stat-card.warning::before {
                background: linear-gradient(to bottom, #f59e0b, #d97706);
            }
            .stat-card.danger::before {
                background: linear-gradient(to bottom, #ef4444, #dc2626);
            }
            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            }
            .stat-card:hover::before {
                opacity: 1;
            }
            .stat-value {
                transition: all 0.5s ease-out;
                display: inline-block;
                letter-spacing: -0.5px;
            }
            .stat-card:hover .stat-value {
                transform: scale(1.05);
            }
            .stat-container {
                position: relative;
                z-index: 10;
            }
            .floating-bg {
                position: absolute;
                width: 150px;
                height: 150px;
                border-radius: 50%;
                background-color: rgba(22, 93, 255, 0.08);
                top: -75px;
                right: -75px;
                transition: all 0.5s ease;
            }
            .stat-card:hover .floating-bg {
                transform: scale(1.8);
            }
            .stat-card.success .floating-bg {
                background-color: rgba(39, 174, 96, 0.08);
            }
            .stat-card.warning .floating-bg {
                background-color: rgba(245, 158, 11, 0.08);
            }
            .stat-card.danger .floating-bg {
                background-color: rgba(229, 62, 62, 0.08);
            }

            /* 排期冲突提示样式 - 简化版 */
            .conflict-highlight {
                background-color: rgba(229, 62, 62, 0.15);
            }
            /* 导航样式 - 简化版 */
            .nav-btn.active {
                background-color: #3b82f6;
                color: white;
                font-weight: 500;
            }
            
            .nav-btn.active:hover {
                background-color: #2563eb;
                color: white;
            }
            
            .bg-gradient-to-r {
                background-image: linear-gradient(to right, var(--tw-gradient-stops));
            }
            
            .from-blue-500 {
                --tw-gradient-from: #3b82f6;
                --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0));
            }
            
            .to-purple-600 {
                --tw-gradient-to: #9333ea;
            }
            
            .from-blue-50 {
                --tw-gradient-from: #eff6ff;
                --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0));
            }
            
            .to-purple-50 {
                --tw-gradient-to: #faf5ff;
            }
            
            /* Logo动画效果 */
            .logo-animation {
                animation: logoFloat 3s ease-in-out infinite;
            }
            
            @keyframes logoFloat {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-3px); }
            }
            
            /* 导航按钮悬停效果 */
            .nav-btn {
                position: relative;
                overflow: hidden;
                border-radius: 12px;
            }
            
            .nav-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
                transition: left 0.4s ease;
            }
            
            .nav-btn:hover::before {
                left: 100%;
            }
            /* 页面切换样式 */
            .page-content {
                display: none;
            }
            .page-content.active {
                display: block;
            }
            /* 模具卡片样式 */
            .mold-card {
                transition: all 0.3s ease;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                overflow: hidden;
            }
            .mold-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }
            .mold-status {
                display: inline-flex;
                align-items: center;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
            }
            .status-active {
                background-color: #dcfce7;
                color: #166534;
            }
            .status-completed {
                background-color: #dbeafe;
                color: #1e40af;
            }
            .status-pending {
                background-color: #fef3c7;
                color: #92400e;
            }
            
            /* 文本对齐方式 */
            .text-left { text-align: left; }
            .text-center { text-align: center; }
            .text-right { text-align: right; }
            .text-justify { text-align: justify; }
            
            /* 模具卡片细节优化 */
            .mold-card-details {
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            
            .mold-card-details:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                transform: translateY(-1px);
            }
            
            .detail-label {
                font-weight: 500;
                color: #64748b;
                width: 60px;
                flex-shrink: 0;
            }
            
            .detail-value {
                color: #1e293b;
                font-weight: 500;
                flex: 1;
                min-width: 0;
            }
            
            .process-status-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-right: 6px;
            }
            
            .process-status-pending { background-color: #f59e0b; }
            .process-status-progress { background-color: #3b82f6; }
            .process-status-completed { background-color: #10b981; }
            
            /* 卡片排版优化 */
            .card-section {
                background-color: #f8fafc;
                border-radius: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .card-section-title {
                font-size: 0.75rem;
                font-weight: 600;
                color: #475569;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }
            
            /* 页面布局优化 */
            body {
                min-height: 100vh;
                display: flex;
                background: linear-gradient(135deg, #f1f5f9 0%, #f8fafc 100%);
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            }
            
            /* 侧边栏样式 - 简洁实用版 */
            .sidebar {
                width: 240px;
                min-width: 240px;
                background: #ffffff;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
            }
            
            .sidebar-header {
                padding: 20px 16px;
                border-bottom: 1px solid #e5e7eb;
                background: #f9fafb;
            }
            
            .sidebar-title {
                font-size: 16px;
                font-weight: 600;
                color: #111827;
                margin: 0;
                line-height: 1.4;
            }
            
            .sidebar-subtitle {
                font-size: 12px;
                color: #6b7280;
                margin-top: 4px;
                font-weight: 400;
            }
            
            .sidebar-nav {
                flex: 1;
                padding: 16px 0;
                overflow-y: auto;
            }
            
            .nav-section {
                margin-bottom: 24px;
            }
            
            .nav-section-title {
                padding: 0 16px 8px;
                font-size: 10px;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .sidebar-nav-item {
                display: flex;
                align-items: center;
                width: 100%;
                padding: 10px 16px;
                text-align: left;
                color: #4b5563;
                font-size: 14px;
                font-weight: 500;
                border: none;
                background: none;
                cursor: pointer;
                transition: all 0.15s ease;
                border-left: 3px solid transparent;
                position: relative;
            }
            
            .sidebar-nav-item .nav-icon {
                width: 18px;
                height: 18px;
                margin-right: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                background: #f3f4f6;
                color: #6b7280;
                font-size: 12px;
                flex-shrink: 0;
            }
            
            .sidebar-nav-item .nav-text {
                flex: 1;
            }
            
            .sidebar-nav-item:hover {
                background-color: #f3f4f6;
                color: #374151;
            }
            
            .sidebar-nav-item:hover .nav-icon {
                background: #e5e7eb;
                color: #374151;
            }
            
            .sidebar-nav-item.active {
                background: #eff6ff;
                color: #1d4ed8;
                border-left-color: #3b82f6;
                font-weight: 600;
            }
            
            .sidebar-nav-item.active .nav-icon {
                background: #3b82f6;
                color: white;
            }
            
            /* 功能分组样式 - 简化版 */
            .nav-section.core-functions .nav-section-title {
                color: #1d4ed8;
            }
            
            .nav-section.project-operations .nav-section-title {
                color: #059669;
            }
            
            .nav-section.edit-tools .nav-section-title {
                color: #d97706;
            }
            
            .nav-section.data-management .nav-section-title {
                color: #7c3aed;
            }
            
            /* 徽章和状态指示器 - 简化版 */
            .nav-badge {
                position: absolute;
                top: 8px;
                right: 12px;
                background: #3b82f6;
                color: white;
                font-size: 10px;
                font-weight: 600;
                padding: 2px 6px;
                border-radius: 10px;
                min-width: 18px;
                text-align: center;
                line-height: 1.2;
            }
            
            .nav-status-dot {
                position: absolute;
                top: 12px;
                right: 12px;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #10b981;
            }
            
            .nav-status-dot.inactive {
                background: #9ca3af;
            }
            
            .nav-shortcut {
                position: absolute;
                top: 50%;
                right: 12px;
                transform: translateY(-50%);
                font-size: 10px;
                color: #9ca3af;
                background: #f3f4f6;
                padding: 2px 4px;
                border-radius: 3px;
                opacity: 0;
                transition: opacity 0.2s ease;
            }
            
            .sidebar-nav-item:hover .nav-shortcut {
                opacity: 1;
            }
            
            /* 统计区域样式 - 简化版 */
            .sidebar-stats-enhanced {
                padding: 0 16px;
            }
            
            .stat-item-enhanced {
                display: flex;
                align-items: center;
                padding: 12px;
                background: #f9fafb;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                margin-bottom: 8px;
                transition: all 0.2s ease;
            }
            
            .stat-item-enhanced:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }
            
            .stat-icon-enhanced {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 12px;
                font-size: 14px;
                flex-shrink: 0;
            }
            
            .stat-icon-enhanced.plan-stat {
                background: #dbeafe;
                color: #1d4ed8;
            }
            
            .stat-icon-enhanced.actual-stat {
                background: #d1fae5;
                color: #059669;
            }
            
            .stat-icon-enhanced.progress-stat {
                background: #e0e7ff;
                color: #5b21b6;
            }
            
            .stat-content-enhanced {
                flex: 1;
                min-width: 0;
            }
            
            .stat-label-enhanced {
                font-size: 11px;
                color: #6b7280;
                font-weight: 500;
                margin-bottom: 2px;
                line-height: 1.2;
            }
            
            .stat-value-enhanced {
                font-size: 16px;
                font-weight: 600;
                color: #111827;
                display: flex;
                align-items: baseline;
                gap: 4px;
            }
            
            .stat-unit {
                font-size: 11px;
                font-weight: 500;
                color: #6b7280;
            }
            

            

            
            /* 快速筛选按钮动画效果 */
            .pulse-animation {
                animation: pulse-orange 2s infinite;
            }
            
            .urgent-pulse {
                animation: pulse-red 1.5s infinite;
            }
            
            @keyframes pulse-orange {
                0%, 100% {
                    box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
                }
                50% {
                    box-shadow: 0 0 0 8px rgba(249, 115, 22, 0);
                }
            }
            
            @keyframes pulse-red {
                0%, 100% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
                }
                50% {
                    box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
                }
            }
            
            /* 搜索结果提示样式 */
            #searchResultsInfo .text-sm {
                animation: slideInDown 0.3s ease-out;
            }
            
            @keyframes slideInDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* 快速筛选按钮增强样式 */
            .quick-filter {
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .quick-filter:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            
            .quick-filter::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }
            
            .quick-filter:hover::before {
                left: 100%;
            }
            
            /* 筛选计数徽章样式 */
            .quick-filter span[id$="Count"] {
                transition: all 0.3s ease;
                display: inline-block;
            }
            
            .quick-filter span[id$="Count"]:hover {
                transform: scale(1.1);
            }
            
            /* 空状态优化 */
            #emptyState {
                animation: fadeIn 0.5s ease-out;
            }
            
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* 模具卡片悬停效果增强 */
            .mold-card {
                transition: all 0.3s ease;
            }
            
            .mold-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }
            
            /* 搜索框增强效果 */
            #searchMolds:focus {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                border-color: #3b82f6;
            }
            
            #searchMolds:focus + .fa-search {
                color: #3b82f6;
            }
            
            /* 响应式优化 */
            @media (max-width: 1024px) {
                .nav-shortcut {
                    display: none;
                }
                
                .sidebar-nav-item {
                    padding: 0.75rem 1rem;
                }
                
                .stat-item-enhanced {
                    padding: 0.75rem;
                }
                
                .stat-icon-enhanced {
                    width: 2rem;
                    height: 2rem;
                    margin-right: 0.75rem;
                    font-size: 0.875rem;
                }
                
                /* 移动端快速筛选优化 */
                .quick-filter {
                    font-size: 0.75rem;
                    padding: 0.5rem 0.75rem;
                }
                
                .quick-filter i {
                    display: none;
                }
                
                /* 移动端搜索结果信息 */
                #searchResultsInfo {
                    font-size: 0.75rem;
                }
            }
            
            @media (max-width: 768px) {
                /* 移动端筛选工具栏垂直布局 */
                .px-6.py-3 .flex.flex-wrap {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 0.75rem;
                }
                
                .px-6.py-3 .flex.flex-wrap > div {
                    justify-content: center;
                }
                
                .px-6.py-3 .ml-auto {
                    margin-left: 0;
                    margin-top: 0.5rem;
                }
            }
            

            
            /* 主内容区域 */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                background: #f8fafc;
            }
            
            .content-header {
                background: white;
                border-bottom: 1px solid #e2e8f0;
                padding: 1.25rem 2rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            
            .content-header-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1e293b;
                margin: 0;
                display: flex;
                align-items: center;
            }
            
            .content-header-icon {
                width: 24px;
                height: 20px;
                margin-right: 0.75rem;
                background: #3b82f6;
                color: white;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.875rem;
            }
            
            .content-body {
                flex: 1;
                padding: 2rem;
                overflow-x: auto;
            }
            
            /* 面包屑导航 */
            .breadcrumb {
                display: flex;
                align-items: center;
                margin-top: 0.5rem;
                font-size: 0.875rem;
                color: #64748b;
            }
            
            .breadcrumb-item {
                display: flex;
                align-items: center;
            }
            
            .breadcrumb-item:not(:last-child)::after {
                content: '›';
                margin: 0 0.5rem;
                color: #cbd5e1;
            }
            
            .breadcrumb-home {
                color: #3b82f6;
                text-decoration: none;
            }
            
            .breadcrumb-home:hover {
                text-decoration: underline;
            }
            

            
            .stat-content {
                flex: 1;
                min-width: 0;
            }
            
            .stat-label {
                font-size: 0.75rem;
                color: #64748b;
                font-weight: 500;
                margin-bottom: 0.125rem;
            }
            
            .stat-value {
                font-size: 0.875rem;
                font-weight: 600;
                color: #1e293b;
            }
            
            /* 确保页面内容区域有最小高度 */
            .page-content {
                min-height: calc(100vh - 200px);
            }
            
            /* 现代化卡片效果 */
            .modern-card {
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
                border: 1px solid #e2e8f0;
                transition: all 0.3s ease;
            }
            
            .modern-card:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                transform: translateY(-2px);
            }
            
            /* 现代化分隔线 */
            .modern-divider {
                height: 1px;
                background: linear-gradient(to right, transparent, #e2e8f0, transparent);
                margin: 16px 0;
            }
            
            /* 现代化标签 */
            .modern-tag {
                display: inline-flex;
                align-items: center;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                gap: 6px;
            }
            
            .tag-success {
                background: rgba(16, 185, 129, 0.15);
                color: #059669;
            }
            
            .tag-warning {
                background: rgba(245, 158, 11, 0.15);
                color: #d97706;
            }
            
            .tag-danger {
                background: rgba(239, 68, 68, 0.15);
                color: #dc2626;
            }
            
            .tag-info {
                background: rgba(59, 130, 246, 0.15);
                color: #2563eb;
            }
            
            /* 可调整列宽的表格样式 */
            .resizable-table {
                table-layout: fixed;
                width: 100%;
            }
            
            .resizable-table th {
                position: relative;
                user-select: none;
            }
            
            .resizable-table th:not(:last-child) {
                border-right: 1px solid #e2e8f0;
            }
            
            .column-resizer {
                position: absolute;
                top: 0;
                right: 0;
                width: 4px;
                height: 100%;
                cursor: col-resize;
                background: transparent;
                z-index: 10;
            }
            
            .column-resizer:hover {
                background: #3b82f6;
            }
            
            .column-resizer.resizing {
                background: #3b82f6;
            }
            
            /* 水印样式 */
            .watermark {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 48px;
                color: rgba(0, 0, 0, 0.05);
                font-weight: bold;
                pointer-events: none;
                z-index: 1;
                user-select: none;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen">
    <!-- 左侧边栏 -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">模具制造跟踪系统</h1>
            <p class="sidebar-subtitle">Mold Manufacturing Tracking</p>
        </div>
        <nav class="sidebar-nav">
            <!-- 核心功能区 -->
            <div class="nav-section core-functions">
                <div class="nav-section-title">
                    <i class="fa fa-star text-blue-500"></i>
                    核心功能
                </div>
                <button id="navManagement" class="sidebar-nav-item active">
                    <div class="nav-icon">
                        <i class="fa fa-th-large"></i>
                    </div>
                    <span class="nav-text">模具管理</span>
                    <div class="nav-badge" id="moldCountBadge">0</div>
                </button>
                <button id="navTracking" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-tasks"></i>
                    </div>
                    <span class="nav-text">流程跟踪</span>
                    <div class="nav-status-dot" id="trackingStatusDot"></div>
                </button>
                
                
            </div>
            
            <!-- 项目操作区 -->
            <div class="nav-section project-operations">
                <div class="nav-section-title">
                    <i class="fa fa-folder-open text-green-500"></i>
                    项目操作
                </div>
                <button id="createNewMoldSidebar" class="sidebar-nav-item create-action">
                    <div class="nav-icon">
                        <i class="fa fa-plus-circle"></i>
                    </div>
                    <span class="nav-text">新建项目</span>
                    <div class="nav-shortcut">Ctrl+N</div>
                </button>
                <button id="initBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-cogs"></i>
                    </div>
                    <span class="nav-text">初始化流程</span>
                    <div class="nav-shortcut">Ctrl+I</div>
                </button>
            </div>
            
            <!-- 编辑工具区 -->
            <div class="nav-section edit-tools">
                <div class="nav-section-title">
                    <i class="fa fa-edit text-orange-500"></i>
                    编辑工具
                </div>
                <button id="addBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-plus"></i>
                    </div>
                    <span class="nav-text">添加工序</span>
                    <div class="nav-shortcut">Ctrl+A</div>
                </button>
                <button id="recalculateBtn" class="sidebar-nav-item">
                    <div class="nav-icon">
                        <i class="fa fa-refresh"></i>
                    </div>
                    <span class="nav-text">重新计算</span>
                    <div class="nav-shortcut">F5</div>
                </button>
                <button id="saveBtn" class="sidebar-nav-item save-action">
                    <div class="nav-icon">
                        <i class="fa fa-save"></i>
                    </div>
                    <span class="nav-text">保存数据</span>
                    <div class="nav-shortcut">Ctrl+S</div>
                </button>
            </div>
            
            <!-- 数据管理区 -->
            <div class="nav-section data-management">
                <div class="nav-section-title">
                    <i class="fa fa-database text-purple-500"></i>
                    数据管理
                </div>
                <button id="exportBtn" class="sidebar-nav-item export-action">
                    <div class="nav-icon">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                    <span class="nav-text">导出Excel</span>
                    <div class="nav-shortcut">Ctrl+E</div>
                </button>
                <button id="clearBtn" class="sidebar-nav-item danger-action">
                    <div class="nav-icon">
                        <i class="fa fa-trash"></i>
                    </div>
                    <span class="nav-text">清空数据</span>
                    <div class="nav-warning-icon">
                        <i class="fa fa-exclamation-triangle"></i>
                    </div>
                </button>
            </div>
            
            <!-- 实时统计区 -->
            <div class="nav-section real-time-stats">
                <div class="nav-section-title">
                    <i class="fa fa-chart-line text-indigo-500"></i>
                    实时统计
                </div>
                <div class="sidebar-stats-enhanced">
                    <div class="stat-item-enhanced">
                        <div class="stat-icon-enhanced plan-stat">
                            <i class="fa fa-clock-o"></i>
                        </div>
                        <div class="stat-content-enhanced">
                            <div class="stat-label-enhanced">计划周期</div>
                            <div class="stat-value-enhanced">
                                <span id="sidebarPlanDays">0</span>
                                <span class="stat-unit">天</span>
                            </div>
                        </div>

                    </div>
                    
                    <div class="stat-item-enhanced">
                        <div class="stat-icon-enhanced actual-stat">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="stat-content-enhanced">
                            <div class="stat-label-enhanced">实际周期</div>
                            <div class="stat-value-enhanced">
                                <span id="sidebarActualDays">0</span>
                                <span class="stat-unit">天</span>
                            </div>
                        </div>

                    </div>
                    

                </div>
            </div>
        </nav>
        <div class="sidebar-footer mt-auto">
            <div class="sidebar-footer-text p-4 border-t border-gray-200 bg-gray-50">
                <div class="footer-main-text flex items-center text-sm font-medium text-gray-700 mb-1">
                    <i class="fa fa-shield text-blue-500 mr-2"></i>
                    <strong>仅供内部使用</strong>
                </div>
                <div class="footer-sub-text text-xs text-gray-500">
                    模具制造工艺流程跟踪系统<br>
                    智能化管理 · 精准化控制 · 高效化协作
                </div>
            </div>
        </div>
    </aside>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 水印 -->
        <div class="watermark">内部使用 INTERNAL USE</div>
        <main class="content-body">
        <!-- 模具管理页面 -->
        <div id="managementPage" class="page-content active">
            <!-- 优化的搜索筛选区域（集成统计信息） -->
            <section class="mb-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- 搜索栏和统计信息 -->
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex flex-row flex-wrap items-center justify-between gap-4">
                            <!-- 搜索输入框 -->
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="text" id="searchMolds" placeholder="搜索模具编号、名称、产品、材料、类型或版本..." 
                                           class="w-full px-4 py-2 border border-gray-300 text-sm focus:border-blue-500 focus:outline-none bg-white rounded-lg pl-10">
                                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            


                            <!-- 顶部右侧筛选功能（并入与搜索同一行） -->
                            <div class="flex items-center gap-3 flex-wrap justify-end w-full lg:w-auto">
                                <span class="text-sm text-gray-600 font-medium flex items-center">
                                    <i class="fa fa-filter mr-1"></i>快速筛选:
                                </span>
                                <!-- 时间筛选 -->
                                <div class="flex items-center gap-2">
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition-colors rounded-lg" data-filter="today">
                                        <i class="fa fa-calendar-day mr-1"></i>今日更新
                                    </button>
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-green-100 hover:text-green-700 transition-colors rounded-lg" data-filter="recent">
                                        <i class="fa fa-clock-o mr-1"></i>最近3天
                                    </button>
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-purple-100 hover:text-purple-700 transition-colors rounded-lg" data-filter="week">
                                        <i class="fa fa-calendar-week mr-1"></i>本周创建
                                    </button>
                                </div>
                                <!-- 状态筛选 -->
                                <div class="flex items-center gap-2 border-l border-gray-300 pl-3">
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-orange-100 hover:text-orange-700 transition-colors rounded-lg" data-filter="active">
                                        <i class="fa fa-play-circle mr-1"></i>进行中
                                    </button>
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-green-100 hover:text-green-700 transition-colors rounded-lg" data-filter="completed">
                                        <i class="fa fa-check-circle mr-1"></i>已完成
                                    </button>
                                </div>
                                <!-- 紧急筛选 -->
                                <div class="flex items-center gap-2 border-l border-gray-300 pl-3">
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-yellow-100 hover:text-yellow-700 transition-colors rounded-lg" data-filter="urgent">
                                        <i class="fa fa-exclamation-triangle mr-1"></i>即将试模 
                                        <span id="upcomingTestCount" class="ml-1 px-1.5 py-0.5 text-xs bg-orange-100 text-orange-600 rounded-full font-semibold">0</span>
                                    </button>
                                    <button class="quick-filter px-3 py-1.5 text-sm bg-gray-100 text-gray-700 hover:bg-red-100 hover:text-red-700 transition-colors rounded-lg" data-filter="overdue">
                                        <i class="fa fa-exclamation-circle mr-1"></i>已逾期
                                        <span id="overdueCount" class="ml-1 px-1.5 py-0.5 text-xs bg-red-100 text-red-600 rounded-full font-semibold">0</span>
                                    </button>
                                </div>
                                <!-- 重置与计数 -->
                                <div class="flex items-center gap-3 border-l border-gray-300 pl-3">
                                    <button id="resetFilters" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 hover:bg-red-200 hover:text-red-800 transition-colors rounded-lg">
                                        <i class="fa fa-times mr-1"></i>重置筛选
                                    </button>
                                    <div class="text-sm text-gray-500 bg-gray-50 px-3 py-1.5 rounded-lg">
                                        共 <span id="filteredCount" class="font-semibold text-gray-700">0</span> 条记录
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </div>
            </section>

            <!-- 紧凑的模具卡片列表 -->
            <section class="mb-6">
                <!-- 模具卡片网格 - 职场标准布局 -->
                <div id="moldsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3">
                    <!-- 模具卡片将通过JavaScript动态生成 -->
                </div>
                
                <!-- 空状态 -->
                <div id="emptyState" class="text-center py-12 hidden">
                    <h3 class="text-lg font-medium text-gray-600 mb-2">还没有模具项目</h3>
                    <p class="text-gray-500 text-sm">使用侧栏的"新建模具项目"开始创建</p>
                </div>
            </section>
        </div>

        <!-- 流程跟踪页面 -->
        <div id="trackingPage" class="page-content">
        <!-- 优化的模具基本信息卡片 -->
        <section class="mb-6 bg-white rounded-2xl p-6 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md">
            <div class="mb-4 pb-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    模具基本信息
                </h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- 第一行：5个输入项 -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具编号</label>
                    <input type="text" id="moldNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具名称</label>
                    <input type="text" id="moldName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具类型</label>
                    <input type="text" id="moldType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">版本号</label>
                    <input type="text" id="version" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">产品名称</label>
                    <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <!-- 第二行：5个输入项 -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">产品材料</label>
                    <input type="text" id="material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">穴数</label>
                    <input type="number" id="cavityCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">开模通知</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="moldOpenNotice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">试模日期</label>
                    <div class="date-picker-wrapper">
                        <input type="date" id="testDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="moldRemark" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="输入其他信息..."></textarea>
                </div>
            </div>
        </section>
        

        
        <!-- 优化的工艺流程跟踪表 -->
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md">
            <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">
                    工艺流程跟踪表
                </h2>
                <div class="ml-auto flex items-center text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span>可拖拽调整列宽</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="processTable" class="resizable-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="serial-number-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 60px;">
                                序号
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="process-name-col px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase" style="width: 150px;">
                                工序名称
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                计划开始
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                计划结束
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="plan-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 80px;">
                                计划天数
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                实际开始
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="date-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 100px;">
                                实际结束
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="actual-days-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 80px;">
                                实际天数
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="status-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 85px;">
                                状态
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="remark-col px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 140px;">
                                备注
                                <div class="column-resizer"></div>
                            </th>
                            <th scope="col" class="action-col px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" style="width: 120px;">
                                操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 表格内容将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-500">
                操作提示：点击状态标签可切换工序状态，修改日期或天数会自动计算关联值
            </div>
        </section>
        </div> <!-- 结束流程跟踪页面 -->
        


        
        
        </main>
    </div>
    
    <!-- 通知提示组件 -->
    <div id="notification" class="fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center z-50"></div>

    <script>
        // ==================== 全局变量和状态管理 ====================
        
        // 事件管理器 - 解决内存泄漏问题
        class EventManager {
            constructor() {
                this.listeners = new Map();
                this.timers = new Set();
            }
            
            addListener(element, event, handler, options = {}) {
                if (!element) return;
                
                const key = `${element.id || 'anonymous'}-${event}-${Date.now()}`;
                
                // 移除可能存在的旧监听器
                this.removeListener(element, event, handler);
                
                // 添加新监听器
                element.addEventListener(event, handler, options);
                
                // 记录监听器
                if (!this.listeners.has(element)) {
                    this.listeners.set(element, []);
                }
                this.listeners.get(element).push({ event, handler, key, options });
                
                return key;
            }
            
            removeListener(element, event, handler) {
                if (!element || !this.listeners.has(element)) return;
                
                const elementListeners = this.listeners.get(element);
                const index = elementListeners.findIndex(l => l.event === event && l.handler === handler);
                
                if (index !== -1) {
                    element.removeEventListener(event, handler, elementListeners[index].options);
                    elementListeners.splice(index, 1);
                    
                    if (elementListeners.length === 0) {
                        this.listeners.delete(element);
                    }
                }
            }
            
            removeAllListeners(element) {
                if (!element || !this.listeners.has(element)) return;
                
                const elementListeners = this.listeners.get(element);
                elementListeners.forEach(({ event, handler, options }) => {
                    element.removeEventListener(event, handler, options);
                });
                
                this.listeners.delete(element);
            }
            
            addTimer(timerId) {
                this.timers.add(timerId);
                return timerId;
            }
            
            clearTimer(timerId) {
                if (this.timers.has(timerId)) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            }
            
            cleanup() {
                // 清理所有事件监听器
                this.listeners.forEach((listeners, element) => {
                    listeners.forEach(({ event, handler, options }) => {
                        element.removeEventListener(event, handler, options);
                    });
                });
                this.listeners.clear();
                
                // 清理所有定时器
                this.timers.forEach(timerId => clearTimeout(timerId));
                this.timers.clear();
            }
        }
        
        // 工具函数类 - 统一重复代码
        class Utils {
            static formatDate(date, format = 'YYYY-MM-DD') {
                if (!date) return '';
                const d = new Date(date);
                if (isNaN(d.getTime())) return '';
                
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            static formatDateForDisplay(date) {
                if (!date) return '';
                const d = new Date(date);
                if (isNaN(d.getTime())) return '';
                
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                
                return `${month}/${day}`;
            }
            
            static safeParseDate(dateStr) {
                if (!dateStr) return null;
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            
            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            static normalizeStatus(status) {
                if (!status) return 'pending';
                const statusMapping = {
                    'pending': 'pending',
                    'inProgress': 'inProgress', 
                    'completed': 'completed',
                    'delayed': 'delayed',
                    'active': 'inProgress',
                    'finished': 'completed',
                    'waiting': 'pending'
                };
                return statusMapping[status] || status;
            }
            
            static validateInput(value, type) {
                switch (type) {
                    case 'required':
                        return value && value.trim() !== '';
                    case 'number':
                        return !isNaN(parseFloat(value)) && isFinite(value);
                    case 'positiveNumber':
                        return !isNaN(parseFloat(value)) && isFinite(value) && parseFloat(value) > 0;
                    case 'date':
                        return Utils.safeParseDate(value) !== null;
                    default:
                        return true;
                }
            }
        }
        
        // 通知管理器 - 统一通知显示
        class NotificationManager {
            constructor() {
                this.notification = document.getElementById('notification');
            }
            
            show(message, type = 'info', duration = 3000) {
                if (!this.notification) return;
                
                const config = {
                    success: { bg: 'bg-success', text: 'text-white', icon: 'fa-check-circle' },
                    error: { bg: 'bg-danger', text: 'text-white', icon: 'fa-exclamation-circle' },
                    warning: { bg: 'bg-warning', text: 'text-white', icon: 'fa-exclamation-triangle' },
                    info: { bg: 'bg-primary', text: 'text-white', icon: 'fa-info-circle' }
                };
                
                const { bg, text, icon } = config[type] || config.info;
                
                this.notification.className = `fixed top-20 right-5 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 flex items-center z-50 ${bg} ${text}`;
                this.notification.innerHTML = `<i class="fa ${icon} mr-2"></i>${message}`;
                this.notification.style.transform = 'translateX(0)';
                
                const timerId = setTimeout(() => {
                    this.notification.style.transform = 'translateX(calc(100% + 20px))';
                }, duration);
                
                eventManager.addTimer(timerId);
            }
        }
        
        // 全局实例
        const eventManager = new EventManager();
        const notificationManager = new NotificationManager();
        
        // 全局变量
        let processData = [];
        let nextProcessId = 1;
        let scheduleSettings = {
            includeDependencies: true
        };
        let autoSaveTimer = null;
        let isCalculating = false;
        
        // 模具管理相关变量
        let moldsData = [];
        let currentMoldId = null;
        let currentQuickFilter = null;
        let currentFilteredMolds = null;
        let nextMoldId = 1;
        let currentPage = 'management';
        
        // DOM元素
        const processTableBody = document.getElementById('processTableBody');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const initBtn = document.getElementById('initBtn');
        const addBtn = document.getElementById('addBtn');
        const recalculateBtn = document.getElementById('recalculateBtn'); // 重新计算按钮
        const notification = document.getElementById('notification');

        
        // 模具管理DOM元素
        const navManagement = document.getElementById('navManagement');
        const navTracking = document.getElementById('navTracking');
        const managementPage = document.getElementById('managementPage');
        const trackingPage = document.getElementById('trackingPage');
        const moldsListElement = document.getElementById('moldsList');
        const emptyState = document.getElementById('emptyState');
        const createNewMold = document.getElementById('createNewMold');
        const searchMolds = document.getElementById('searchMolds');
        // const statusFilter = document.getElementById('statusFilter'); // 已移除下拉状态筛选
        // const refreshMolds = document.getElementById('refreshMolds'); // 已移除刷新按钮
        
        // 状态选项
        const statusOptions = [
            { id: 'pending', name: '未开始', class: 'bg-pending/20 text-pending border border-pending/30' },
            { id: 'inProgress', name: '进行中', class: 'bg-warning/20 text-warning border border-warning/30' },
            { id: 'completed', name: '已完成', class: 'bg-success/20 text-success border border-success/30' },
            { id: 'delayed', name: '已延迟', class: 'bg-danger/20 text-danger border border-danger/30' }
        ];
        
        // 状态映射表 - 统一不同地方使用的状态值
        const statusMapping = {
            // 工序状态
            'pending': 'pending',
            'inProgress': 'inProgress', 
            'completed': 'completed',
            'delayed': 'delayed',
            // 模具状态映射
            'active': 'inProgress', // 将active统一映射为inProgress
            'finished': 'completed', // 将finished统一映射为completed
            'waiting': 'pending' // 将waiting统一映射为pending
        };
        
        // 状态标准化函数
        function normalizeStatus(status) {
            if (!status) return 'pending';
            return statusMapping[status] || status;
        }
        
        // 初始化 - 增强版
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadMoldsData();
            
            // 如果没有模具数据，创建一些演示数据
            if (moldsData.length === 0) {
                createDemoMoldsData();
            }
            
            setupEventListeners();
            setupMoldManagementListeners();
            setupKeyboardShortcuts(); // 添加快捷键支持
            updateCycleStatistics();
            updateMoldCountBadge(); // 更新模具数量徽章
            
            // 根据currentPage显示对应的页面
            if (currentPage === 'management') {
                switchPage('management');
            } else {
                switchPage('tracking');
            }
            
            // 自动同步当前编辑的数据到模具管理
            if (processData.length > 0) {
                setTimeout(() => {
                    autoSaveWithSync();
                }, 500);
            }
            
            // 检查初始数据中的排期冲突
            setTimeout(() => {
                const conflicts = checkScheduleConflicts();
                if (conflicts.length > 0) {
                    highlightConflicts(conflicts);
                    showNotification(`检测到 ${conflicts.length} 处排期冲突，请检查数据`, 'warning');
                }
            }, 1000);
            
            // 显示欢迎提示
            setTimeout(() => {
                if (processData.length === 0) {
                    showNotification('欢迎使用模具制造跟踪系统！点击"初始化流程"开始', 'info');
                }
            }, 2000);
            
            // 定期更新统计信息
            setInterval(() => {
                updateCycleStatistics();
                updateMoldCountBadge();
            }, 30000); // 每30秒更新一次
            
            // 确保模具管理页面正确初始化
            if (document.getElementById('managementPage').classList.contains('active')) {
                renderMoldsList();
            }
        });
        
        // 设置键盘快捷键
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // 检查是否在输入框中，如果是则不处理快捷键
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // 只处理特定的快捷键
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        saveData();
                        showNotification('数据已保存 (Ctrl+S)', 'success');
                    }
                    return;
                }
                
                // 处理快捷键
                if (e.ctrlKey) {
                    switch (e.key.toLowerCase()) {
                        case 'n':
                            e.preventDefault();
                            createNewMoldProject();
                            showNotification('创建新项目 (Ctrl+N)', 'info');
                            break;
                        case 's':
                            e.preventDefault();
                            saveData();
                            showNotification('数据已保存 (Ctrl+S)', 'success');
                            break;
                        case 'e':
                            e.preventDefault();
                            exportToExcel();
                            showNotification('导出Excel (Ctrl+E)', 'info');
                            break;
                        case 'a':
                            e.preventDefault();
                            if (currentPage === 'tracking') {
                                addNewProcess();
                                showNotification('添加工序 (Ctrl+A)', 'info');
                            }
                            break;
                        case 'i':
                            e.preventDefault();
                            if (currentPage === 'tracking') {
                                initializeDefaultProcesses();
                                showNotification('初始化流程 (Ctrl+I)', 'info');
                            }
                            break;
                    }
                } else {
                    switch (e.key) {
                        case 'F5':
                            if (currentPage === 'tracking') {
                                e.preventDefault();
                                recalculateSchedule();
                                showNotification('重新计算 (F5)', 'info');
                            }
                            break;
                        case 'F1':
                            e.preventDefault();
                            showHelpModal();
                            break;
                        case 'Escape':
                            // 关闭模态框或取消操作
                            const modals = document.querySelectorAll('.fixed.inset-0');
                            modals.forEach(modal => {
                                if (modal.style.display !== 'none') {
                                    modal.remove();
                                }
                            });
                            break;
                    }
                }
            });
        }
        
        // 显示帮助模态框
        function showHelpModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden border border-gray-100">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-8 py-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-1">快捷键帮助</h3>
                                <p class="text-sm text-gray-600">提高操作效率的键盘快捷键</p>
                            </div>
                            <button class="close-help text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-50 rounded-full transition-all duration-200">
                                <i class="fa fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-y-auto max-h-[60vh] p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fa fa-keyboard-o mr-2 text-blue-500"></i>
                                    通用快捷键
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center py-1">
                                        <span>保存数据</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+S</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>导出Excel</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+E</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>新建项目</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+N</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>帮助</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">F1</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>关闭弹窗</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Esc</kbd>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                    <i class="fa fa-tasks mr-2 text-green-500"></i>
                                    流程跟踪快捷键
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center py-1">
                                        <span>添加工序</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+A</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>初始化流程</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+I</kbd>
                                    </div>
                                    <div class="flex justify-between items-center py-1">
                                        <span>重新计算</span>
                                        <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">F5</kbd>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">使用提示</h5>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• 在输入框中时，只有 Ctrl+S 快捷键有效</li>
                                <li>• 快捷键操作会显示确认提示</li>
                                <li>• 部分快捷键仅在对应页面中有效</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 关闭按钮事件
            modal.querySelector('.close-help').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 创建演示模具数据
        function createDemoMoldsData() {
            const demoProcesses1 = [
                { id: 1, name: '设计评审', planStart: '2024-01-01', planEnd: '2024-01-02', planDays: 2, actualStart: '2024-01-01', actualEnd: '2024-01-02', actualDays: 2, status: 'completed', remark: '图纸审核完成' },
                { id: 2, name: '材料采购', planStart: '2024-01-03', planEnd: '2024-01-05', planDays: 3, actualStart: '2024-01-03', actualEnd: '', actualDays: '', status: 'inProgress', remark: '钢材采购中' },
                { id: 3, name: 'CNC粗加工', planStart: '2024-01-06', planEnd: '2024-01-10', planDays: 5, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' }
            ];
            
            const demoProcesses2 = [
                { id: 1, name: '设计评审', planStart: '2024-01-15', planEnd: '2024-01-16', planDays: 2, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' },
                { id: 2, name: '材料采购', planStart: '2024-01-17', planEnd: '2024-01-19', planDays: 3, actualStart: '', actualEnd: '', actualDays: '', status: 'pending', remark: '' }
            ];
            
            moldsData = [
                {
                    id: 1,
                    moldNumber: 'MD001',
                    moldName: '手机外壳模具',
                    moldType: '注塑模',
                    productName: '手机外壳',
                    material: 'ABS',
                    status: 'active',
                    progress: 50,
                    currentProcess: '材料采购',
                    totalDays: 10,
                    completedDays: 2,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    processes: demoProcesses1
                },
                {
                    id: 2,
                    moldNumber: 'MD002',
                    moldName: '汽车配件模具',
                    moldType: '压铸模',
                    productName: '汽车配件',
                    material: '铝合金',
                    status: 'pending',
                    progress: 0,
                    currentProcess: '待开始: 设计评审',
                    totalDays: 5,
                    completedDays: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    processes: demoProcesses2
                }
            ];
            nextMoldId = 3;
            saveMoldsData();
        }
        
        // 设置事件监听器 - 使用事件管理器
        function setupEventListeners() {
            // 侧边栏按钮事件监听器
            const sidebarSaveBtn = document.getElementById('saveBtn');
            const sidebarExportBtn = document.getElementById('exportBtn');
            const sidebarClearBtn = document.getElementById('clearBtn');
            const sidebarInitBtn = document.getElementById('initBtn');
            const sidebarAddBtn = document.getElementById('addBtn');
            const sidebarRecalculateBtn = document.getElementById('recalculateBtn');
            
            if (sidebarSaveBtn) eventManager.addListener(sidebarSaveBtn, 'click', saveData);
            if (sidebarExportBtn) eventManager.addListener(sidebarExportBtn, 'click', exportToExcel);
            if (sidebarClearBtn) eventManager.addListener(sidebarClearBtn, 'click', clearAllData);
            if (sidebarInitBtn) eventManager.addListener(sidebarInitBtn, 'click', initializeDefaultProcesses);
            if (sidebarAddBtn) eventManager.addListener(sidebarAddBtn, 'click', addNewProcess);
            if (sidebarRecalculateBtn) eventManager.addListener(sidebarRecalculateBtn, 'click', recalculateSchedule);
            
            // 导航切换事件
            if (navManagement) eventManager.addListener(navManagement, 'click', () => switchPage('management'));
            if (navTracking) eventManager.addListener(navTracking, 'click', () => switchPage('tracking'));
            
            // 侧边栏新建模具项目按钮
            const createNewMoldSidebar = document.getElementById('createNewMoldSidebar');
            if (createNewMoldSidebar) {
                eventManager.addListener(createNewMoldSidebar, 'click', createNewMoldProject);
            }
            
            // 为日期选择器添加点击事件
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                if (input) {
                    eventManager.addListener(wrapper, 'click', () => {
                        if (typeof input.showPicker === 'function') {
                            input.showPicker();
                        }
                    });
                }
            });
        }
        
        // 使用统一的防抖函数
        function debounce(func, wait) {
            return Utils.debounce(func, wait);
        }
        
        // 重新计算排期 - 智能计算所有工序的日期和天数
        function recalculateSchedule() {
            if (processData.length === 0) {
                showNotification('请先添加工序再进行计算', 'warning');
                return;
            }
            
            try {
                // 执行智能全量重新计算
                performIntelligentRecalculation();
                
                // 检查排期冲突
                const conflicts = checkScheduleConflicts();
                if (conflicts.length > 0) {
                    highlightConflicts(conflicts);
                    showNotification(`排期已重新计算，检测到 ${conflicts.length} 处需要注意的问题`, 'warning');
                } else {
                    showNotification('排期已重新计算完成', 'success');
                }
                
                // 更新界面
                renderProcessTable();
                updateCycleStatistics();
                
                // 保存当前数据
                saveData();
                
            } catch (error) {
                console.error('重新计算排期时出错:', error);
                showNotification('重新计算排期失败，请检查数据', 'error');
            }
        }

        // 执行智能全量重新计算
        function performIntelligentRecalculation() {
            if (processData.length === 0) return;
            
            // 1. 确定起始日期
            let startDate = getCalculationStartDate();
            
            // 2. 为第一个工序设置开始日期
            processData[0].planStart = startDate;
            
            // 3. 自动填充合理的默认天数（如果为空）
            autoFillDefaultDays();
            
            // 4. 智能计算所有工序的日期
            calculateAllProcessDates();
            
            // 5. 重新计算所有结束日期
            recalculateAllEndDates();
            
            // 6. 同步数据到模具管理列表
            syncToMoldManagement();
        }

        // 获取计算起始日期
        function getCalculationStartDate() {
            // 优先级：第一个工序的计划开始日期 > 开模通知日期 > 当前日期
            if (processData.length > 0 && processData[0].planStart) {
                return processData[0].planStart;
            }
            
            const moldOpenNotice = document.getElementById('moldOpenNotice').value;
            if (moldOpenNotice) {
                return moldOpenNotice;
            }
            
            return formatDate(new Date());
        }

        // 计算所有工序的日期
        function calculateAllProcessDates() {
            for (let i = 0; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // 如果不是第一个工序，根据前一工序计算开始日期
                if (i > 0 && prevProcess) {
                    if (prevProcess.planEnd) {
                        // 前一工序有结束日期，下一工序从结束日期的下一天开始
                        const nextStartDate = new Date(prevProcess.planEnd);
                        nextStartDate.setDate(nextStartDate.getDate() + 1);
                        currentProcess.planStart = formatDate(nextStartDate);
                    } else if (prevProcess.planStart) {
                        // 前一工序只有开始日期，假设1天工期
                        const nextStartDate = new Date(prevProcess.planStart);
                        nextStartDate.setDate(nextStartDate.getDate() + 1);
                        currentProcess.planStart = formatDate(nextStartDate);
                    }
                }
                
                // 如果当前工序有计划天数，计算结束日期
                if (currentProcess.planStart && currentProcess.planDays && currentProcess.planDays > 0) {
                    calculateAndUpdatePlanEnd(currentProcess.id);
                }
            }
        }

        // 自动填充合理的默认天数
        function autoFillDefaultDays() {
            const defaultDaysMap = {
                '设计评审': 2,
                '材料采购': 3,
                '深孔钻/铣床加工': 4,
                'CNC粗加工': 5,
                '热处理/磨床加工': 2,
                '线割加工': 3,
                'CNC精加工': 7,
                'EDM加工': 4,
                '省模/抛光': 2,
                '配装合模': 3,
                '试模': 1
            };
            
            processData.forEach(process => {
                // 只为没有天数或天数为0的工序自动填充
                if (!process.planDays || process.planDays === '' || process.planDays === 0) {
                    const defaultDays = defaultDaysMap[process.name] || 2; // 默认2天
                    process.planDays = defaultDays;
                }
            });
        }

        // 重新计算所有结束日期
        function recalculateAllEndDates() {
            processData.forEach(process => {
                if (process.planStart && process.planDays && process.planDays > 0) {
                    calculateAndUpdatePlanEnd(process.id);
                }
            });
        }
        
        // 创建防抖版本的重新计算函数
        const debouncedRecalculate = debounce(recalculateSchedule, 300);
        
        // 自动保存功能
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
                saveData();
            }, 2000); // 2秒后自动保存
        }
        
        // 优化的数据更新函数，避免重复计算
        function updateProcessData(processId, field, value, skipRecalculate = false) {
            const process = processData.find(p => p.id === processId);
            if (!process) return;
            
            process[field] = value;
            
            if (!skipRecalculate && !isCalculating) {
                isCalculating = true;
                setTimeout(() => {
                    debouncedRecalculate();
                    isCalculating = false;
                }, 100);
            }
            
            scheduleAutoSave();
        }
        
        // 检查排期冲突
        function checkScheduleConflicts() {
            const conflicts = [];
            
            // 检查工序间的日期冲突
            for (let i = 1; i < processData.length; i++) {
                const current = processData[i];
                const prev = processData[i - 1];
                
                // 检查计划日期冲突
                if (current.planStart && prev.planEnd && 
                    new Date(current.planStart) < new Date(prev.planEnd)) {
                    conflicts.push({
                        type: 'plan',
                        index: i,
                        message: `工序 ${i+1} 的计划开始日期早于工序 ${i} 的计划结束日期`
                    });
                }
                
                // 检查实际日期冲突
                if (current.actualStart && prev.actualEnd && 
                    new Date(current.actualStart) < new Date(prev.actualEnd)) {
                    conflicts.push({
                        type: 'actual',
                        index: i,
                        message: `工序 ${i+1} 的实际开始日期早于工序 ${i} 的实际结束日期`
                    });
                }
                
                // 检查实际日期是否超过计划日期
                if (current.actualEnd && current.planEnd && 
                    new Date(current.actualEnd) > new Date(current.planEnd) &&
                    current.status === 'completed') {
                    conflicts.push({
                        type: 'delay',
                        index: i,
                        message: `工序 ${i+1} 实际完成日期超过计划日期`
                    });
                }
                
                // 检查计划天数是否为有效值
                if (current.planDays && current.planDays <= 0) {
                    conflicts.push({
                        type: 'invalid',
                        index: i,
                        message: `工序 ${i+1} 的计划天数必须大于0`
                    });
                }
                
                // 检查实际天数是否超过计划天数（仅对已完成工序）
                if (current.actualDays && current.planDays && 
                    current.actualDays > current.planDays &&
                    current.status === 'completed') {
                    conflicts.push({
                        type: 'overrun',
                        index: i,
                        message: `工序 ${i+1} 实际天数超过计划天数`
                    });
                }
            }
            
            // 检查第一个工序是否有计划开始日期
            if (processData.length > 0 && !processData[0].planStart) {
                conflicts.push({
                    type: 'missing',
                    index: 0,
                    message: '第一个工序缺少计划开始日期'
                });
            }
            
            return conflicts;
        }
        
        // 高亮显示冲突
        function highlightConflicts(conflicts) {
            conflicts.forEach(conflict => {
                const row = document.querySelector(`tr[data-id="${processData[conflict.index].id}"]`);
                if (row) {
                    row.classList.add('conflict-highlight');
                    
                    // 5秒后移除高亮
                    setTimeout(() => {
                        row.classList.remove('conflict-highlight');
                    }, 5000);
                }
            });
        }
        
        // 排期算法 - 不再排除周末
        function scheduleProcesses(startDate, settings) {
            let currentDate = new Date(startDate);
            
            for (let i = 0; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // 处理已完成工序
                if (currentProcess.status === 'completed') {
                    // 跳过已完成工序
                    if (currentProcess.actualEnd) {
                        currentDate = new Date(currentProcess.actualEnd);
                    } else if (currentProcess.planEnd) {
                        currentDate = new Date(currentProcess.planEnd);
                    }
                    continue;
                }
                
                // 如果考虑依赖关系，当前工序的计划开始日期应为前序工序的计划结束日期
                if (settings.includeDependencies && prevProcess && prevProcess.planEnd) {
                    currentDate = new Date(prevProcess.planEnd);
                }
                
                currentProcess.planStart = formatDate(currentDate);
                
                // 计算计划结束日期（包含所有日期，不再排除周末）
                if (currentProcess.planDays && currentProcess.planDays > 0) {
                    // 增加计划天数减1（因为包含当天）
                    // 如果计划天数为1，则结束日期与开始日期相同
                    if (currentProcess.planDays > 1) {
                        currentDate.setDate(currentDate.getDate() + currentProcess.planDays - 1);
                    }
                    currentProcess.planEnd = formatDate(currentDate);
                }
            }
        }
        
        // 更新周期统计 - 增强版
        function updateCycleStatistics() {
            // 计算计划总周期
            const planStarts = processData.map(p => p.planStart).filter(d => d);
            const planEnds = processData.map(p => p.planEnd).filter(d => d);
            
            let totalPlanDays = 0;
            if (planStarts.length > 0 && planEnds.length > 0) {
                const firstPlanStart = new Date(Math.min(...planStarts.map(d => new Date(d).getTime())));
                const lastPlanEndDate = new Date(Math.max(...planEnds.map(d => new Date(d).getTime())));
                totalPlanDays = calculateDaysBetween(firstPlanStart, lastPlanEndDate);
            }
            
            // 计算实际总周期 - 修复计算逻辑
            let totalActualDays = 0;
            
            // 获取所有有实际开始日期的工序（包括进行中和已完成的）
            const startedProcesses = processData.filter(p => p.actualStart && 
                (p.status === 'inProgress' || p.status === 'completed'));
            
            if (startedProcesses.length > 0) {
                // 获取最早的开始日期
                const firstActualStart = new Date(Math.min(...startedProcesses.map(p => new Date(p.actualStart).getTime())));
                
                // 获取最晚的结束日期（已完成的工序）
                const completedProcesses = startedProcesses.filter(p => p.actualEnd && p.status === 'completed');
                let lastActualEndDate;
                
                if (completedProcesses.length > 0) {
                    // 有已完成的工序，取最晚的实际结束日期
                    lastActualEndDate = new Date(Math.max(...completedProcesses.map(p => new Date(p.actualEnd).getTime())));
                } else {
                    // 没有已完成的工序，使用当前日期作为结束日期
                    lastActualEndDate = new Date();
                }
                
                // 计算实际周期
                totalActualDays = calculateDaysBetween(firstActualStart, lastActualEndDate);
            }
            
            // 计算完成进度
            const completedCount = processData.filter(p => p.status === 'completed').length;
            const totalProcesses = processData.length;
            const progress = totalProcesses > 0 ? Math.round((completedCount / totalProcesses) * 100) : 0;
            
            // 更新侧边栏统计数据
            const sidebarPlanDays = document.getElementById('sidebarPlanDays');
            const sidebarActualDays = document.getElementById('sidebarActualDays');
            const sidebarProgress = document.getElementById('sidebarProgress');
            const progressFillMini = document.getElementById('progressFillMini');
            
            if (sidebarPlanDays) {
                animateValue(sidebarPlanDays, parseInt(sidebarPlanDays.textContent) || 0, totalPlanDays, 500);
            }
            if (sidebarActualDays) {
                animateValue(sidebarActualDays, parseInt(sidebarActualDays.textContent) || 0, totalActualDays, 500);
            }
            if (sidebarProgress) {
                animateValue(sidebarProgress, parseInt(sidebarProgress.textContent) || 0, progress, 500);
            }
            if (progressFillMini) {
                progressFillMini.style.width = progress + '%';
            }
            
            // 更新趋势指示器
            updateTrendIndicators(totalPlanDays, totalActualDays);
            
            // 更新跟踪状态指示器
            updateTrackingStatusIndicator();
        }
        
        // 更新趋势指示器
        function updateTrendIndicators(planDays, actualDays) {
            const planTrend = document.getElementById('planTrend');
            const actualTrend = document.getElementById('actualTrend');
            
            if (planTrend) {
                if (actualDays > planDays) {
                    planTrend.innerHTML = '<i class="fa fa-arrow-up trend-up"></i>';
                    planTrend.title = '实际周期超过计划';
                } else if (actualDays < planDays && actualDays > 0) {
                    planTrend.innerHTML = '<i class="fa fa-arrow-down trend-down"></i>';
                    planTrend.title = '实际周期少于计划';
                } else {
                    planTrend.innerHTML = '<i class="fa fa-minus" style="color: #64748b;"></i>';
                    planTrend.title = '计划与实际相符';
                }
            }
            
            if (actualTrend) {
                const efficiency = planDays > 0 ? ((planDays - actualDays) / planDays * 100) : 0;
                if (efficiency > 0) {
                    actualTrend.innerHTML = '<i class="fa fa-arrow-down trend-down"></i>';
                    actualTrend.title = `效率提升 ${efficiency.toFixed(1)}%`;
                } else if (efficiency < 0) {
                    actualTrend.innerHTML = '<i class="fa fa-arrow-up trend-up"></i>';
                    actualTrend.title = `超期 ${Math.abs(efficiency).toFixed(1)}%`;
                } else {
                    actualTrend.innerHTML = '<i class="fa fa-minus" style="color: #64748b;"></i>';
                    actualTrend.title = '按计划执行';
                }
            }
        }
        
        // 更新跟踪状态指示器
        function updateTrackingStatusIndicator() {
            const statusDot = document.getElementById('trackingStatusDot');
            if (!statusDot) return;
            
            const hasActiveProcess = processData.some(p => p.status === 'inProgress');
            const hasData = processData.length > 0;
            
            if (hasActiveProcess) {
                statusDot.className = 'nav-status-dot';
                statusDot.style.background = '#10b981'; // 绿色 - 有进行中的工序
                statusDot.title = '有工序正在进行中';
            } else if (hasData) {
                statusDot.className = 'nav-status-dot';
                statusDot.style.background = '#f59e0b'; // 橙色 - 有数据但无进行中工序
                statusDot.title = '有数据但无进行中工序';
            } else {
                statusDot.className = 'nav-status-dot inactive';
                statusDot.style.background = '#94a3b8'; // 灰色 - 无数据
                statusDot.title = '暂无跟踪数据';
            }
        }
        
        // 更新模具数量徽章
        function updateMoldCountBadge() {
            const moldCountBadge = document.getElementById('moldCountBadge');
            if (moldCountBadge && typeof moldsData !== 'undefined') {
                const count = moldsData.length;
                moldCountBadge.textContent = count;
                
                // 根据数量调整徽章样式
                if (count === 0) {
                    moldCountBadge.style.display = 'none';
                } else {
                    moldCountBadge.style.display = 'block';
                    if (count > 99) {
                        moldCountBadge.textContent = '99+';
                    }
                }
            }
        }
        
        // 精确计算两个日期之间的天数（包含开始和结束日期）
        function calculateDaysBetween(startDate, endDate) {
            // 参数验证和类型转换
            let start, end;
            
            if (typeof startDate === 'string') {
                start = new Date(startDate);
            } else if (startDate instanceof Date) {
                start = new Date(startDate);
            } else {
                console.warn('calculateDaysBetween: 无效的开始日期', startDate);
                return 0;
            }
            
            if (typeof endDate === 'string') {
                end = new Date(endDate);
            } else if (endDate instanceof Date) {
                end = new Date(endDate);
            } else {
                console.warn('calculateDaysBetween: 无效的结束日期', endDate);
                return 0;
            }
            
            // 验证日期有效性
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.warn('calculateDaysBetween: 日期解析失败', { startDate, endDate });
                return 0;
            }
            
            // 如果开始日期晚于结束日期，返回0
            if (start > end) {
                return 0;
            }
            
            // 标准化日期到UTC时间的当天开始，避免时区问题
            const normalizedStart = new Date(Date.UTC(start.getFullYear(), start.getMonth(), start.getDate()));
            const normalizedEnd = new Date(Date.UTC(end.getFullYear(), end.getMonth(), end.getDate()));
            
            // 计算时间差（毫秒）
            const timeDiffMs = normalizedEnd.getTime() - normalizedStart.getTime();
            
            // 转换为天数（使用UTC时间确保跨年计算准确）
            const daysDiff = Math.floor(timeDiffMs / (1000 * 60 * 60 * 24));
            
            // 包含开始和结束日期，所以加1
            const totalDays = daysDiff + 1;
            
            // 调试日志（生产环境可移除）
            if (totalDays < 0) {
                console.warn('calculateDaysBetween: 计算结果为负数', {
                    startDate,
                    endDate,
                    normalizedStart,
                    normalizedEnd,
                    timeDiffMs,
                    daysDiff,
                    totalDays
                });
                return 0;
            }
            
            return totalDays;
        }
        
        // 数字变化动画
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // 使用缓动函数使动画更自然
                const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                element.textContent = Math.floor(easeProgress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // 加载数据
        function loadData() {
            const savedData = localStorage.getItem('moldTrackingData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    processData = data.processes || [];
                    nextProcessId = data.nextId || 1;
                    
                    // 加载模具基本信息
                    if (data.moldInfo) {
                        Object.keys(data.moldInfo).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data.moldInfo[key];
                            }
                        });
                    }
                    
                    // 加载排期设置（移除周末排除相关）
                    if (data.scheduleSettings) {
                        scheduleSettings.includeDependencies = data.scheduleSettings.includeDependencies !== undefined 
                            ? data.scheduleSettings.includeDependencies 
                            : true;
                    }
                    
                    renderProcessTable();
                    updateCycleStatistics();
                } catch (error) {
                    console.error('加载数据失败:', error);
                    showNotification('加载数据失败，将初始化新数据', 'error');
                    initializeDefaultProcesses();
                }
            } else {
                initializeDefaultProcesses();
            }
        }
        
        // 保存数据
        function saveData() {
            try {
                // 验证数据
                const validationErrors = validateProcessData();
                if (validationErrors.length > 0) {
                    showNotification(`数据验证失败：${validationErrors[0]}`, 'warning');
                    return false;
                }
                
                // 收集模具基本信息
                const moldInfo = {
                    moldNumber: document.getElementById('moldNumber').value.trim(),
                    moldName: document.getElementById('moldName').value.trim(),
                    moldType: document.getElementById('moldType').value.trim(),
                    version: document.getElementById('version').value.trim(),
                    productName: document.getElementById('productName').value.trim(),
                    material: document.getElementById('material').value.trim(),
                    cavityCount: document.getElementById('cavityCount').value.trim(),
                    moldOpenNotice: document.getElementById('moldOpenNotice').value,
                    testDate: document.getElementById('testDate').value,
                    moldRemark: document.getElementById('moldRemark').value.trim()
                };
                
                // 保存到localStorage
                const dataToSave = {
                    moldInfo,
                    processes: processData,
                    nextId: nextProcessId,
                    scheduleSettings: scheduleSettings,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('moldTrackingData', JSON.stringify(dataToSave));
                
                // 同步数据到模具管理列表
                syncToMoldManagement(moldInfo, processData);
                
                showNotification('数据保存成功', 'success');
                return true;
            } catch (error) {
                console.error('保存数据时出错:', error);
                showNotification('保存数据失败，请重试', 'error');
                return false;
            }
        }

        // 同步数据到模具管理列表（修复版 - 防止重复记录）
        function syncToMoldManagement(moldInfo, processes) {
            try {
                // 验证输入参数
                if (!moldInfo || typeof moldInfo !== 'object') {
                    console.warn('syncToMoldManagement: 无效的moldInfo参数');
                    return false;
                }
                
                const moldNumber = moldInfo.moldNumber?.trim();
                const moldName = moldInfo.moldName?.trim();
                
                // 如果没有模具编号，不进行同步（避免创建无效记录）
                if (!moldNumber) {
                    console.warn('syncToMoldManagement: 模具编号为空，跳过同步');
                    return false;
                }
                
                // 查找现有模具 - 优先使用currentMoldId，其次使用moldNumber
                let existingMold = null;
                if (currentMoldId) {
                    existingMold = moldsData.find(m => m.id === currentMoldId);
                }
                
                // 如果通过ID没找到，再通过编号查找
                if (!existingMold) {
                    existingMold = moldsData.find(m => m.moldNumber === moldNumber);
                }
                
                if (existingMold) {
                    // 更新现有模具信息
                    existingMold.moldNumber = moldNumber;
                    existingMold.moldName = moldName || '未命名模具';
                    existingMold.moldType = moldInfo.moldType || '';
                    existingMold.version = moldInfo.version || '';
                    existingMold.productName = moldInfo.productName || '';
                    existingMold.material = moldInfo.material || '';
                    existingMold.cavityCount = moldInfo.cavityCount || '';
                    existingMold.moldOpenNotice = moldInfo.moldOpenNotice || '';
                    existingMold.testDate = moldInfo.testDate || '';
                    existingMold.moldRemark = moldInfo.moldRemark || '';
                    existingMold.processes = JSON.parse(JSON.stringify(processes || [])); // 深拷贝
                    existingMold.updatedAt = new Date().toISOString();
                    
                    // 根据工序状态更新模具状态和进度信息
                    existingMold.status = calculateMoldStatus(processes);
                    existingMold.progress = calculateMoldProgress(processes);
                    existingMold.currentProcess = getCurrentProcessName(processes);
                    existingMold.totalDays = calculateTotalPlanDays(processes);
                    existingMold.completedDays = calculateCompletedDays(processes);
                    
                    console.log('更新现有模具:', existingMold.moldNumber);
                } else {
                    // 检查是否存在相同编号的模具（防止重复创建）
                    const duplicateMold = moldsData.find(m => m.moldNumber === moldNumber);
                    if (duplicateMold) {
                        console.warn(`模具编号 ${moldNumber} 已存在，跳过创建`);
                        return false;
                    }
                    
                    // 创建新模具记录
                    const newMold = {
                        id: nextMoldId++,
                        moldNumber: moldNumber,
                        moldName: moldName || '未命名模具',
                        moldType: moldInfo.moldType || '',
                        version: moldInfo.version || '',
                        productName: moldInfo.productName || '',
                        material: moldInfo.material || '',
                        cavityCount: moldInfo.cavityCount || '',
                        moldOpenNotice: moldInfo.moldOpenNotice || '',
                        testDate: moldInfo.testDate || '',
                        moldRemark: moldInfo.moldRemark || '',
                        status: calculateMoldStatus(processes),
                        progress: calculateMoldProgress(processes),
                        currentProcess: getCurrentProcessName(processes),
                        totalDays: calculateTotalPlanDays(processes),
                        completedDays: calculateCompletedDays(processes),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        processes: JSON.parse(JSON.stringify(processes || [])) // 深拷贝
                    };
                    
                    moldsData.push(newMold);
                    currentMoldId = newMold.id; // 设置当前编辑的模具ID
                    console.log('创建新模具:', newMold.moldNumber);
                }
                
                // 保存模具数据
                saveMoldsData();
                
                // 实时更新模具管理列表显示
                updateMoldManagementDisplay();
                
                return true;
            } catch (error) {
                console.error('同步到模具管理列表失败:', error);
                return false;
            }
        }

        // 更新模具管理显示
        function updateMoldManagementDisplay() {
            // 如果当前在模具管理页面，重新渲染列表
            if (managementPage && managementPage.style.display !== 'none') {
                renderMoldsList();
            }
            
            // 更新侧边栏统计信息
            updateSidebarStats();
        }

        // 更新侧边栏统计信息
        function updateSidebarStats() {
            const totalMolds = moldsData.length;
            const activeMolds = moldsData.filter(m => normalizeStatus(m.status) === 'inProgress').length;
            const completedMolds = moldsData.filter(m => m.status === 'completed').length;
            
            // 更新侧边栏显示的统计数据
            const statsElement = document.querySelector('.sidebar-stats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <div class="text-xs text-gray-500 mt-2">
                        总模具: ${totalMolds} | 进行中: ${activeMolds} | 已完成: ${completedMolds}
                    </div>
                `;
            }
        }

        // 根据工序状态计算模具状态
        function calculateMoldStatus(processes) {
            if (!processes || processes.length === 0) {
                return 'pending';
            }
            
            // 标准化所有工序状态
            const normalizedProcesses = processes.map(p => ({
                ...p,
                status: normalizeStatus(p.status)
            }));
            
            const completedCount = normalizedProcesses.filter(p => p.status === 'completed').length;
            const inProgressCount = normalizedProcesses.filter(p => p.status === 'inProgress').length;
            const delayedCount = normalizedProcesses.filter(p => p.status === 'delayed').length;
            
            if (completedCount === normalizedProcesses.length) {
                return 'completed';
            } else if (delayedCount > 0) {
                return 'delayed';
            } else if (inProgressCount > 0 || completedCount > 0) {
                return 'inProgress'; // 统一使用inProgress而不是active
            } else {
                return 'pending';
            }
        }
        
        // 导出到Excel
        function exportToExcel() {
            if (processData.length === 0) {
                showNotification('没有工序数据可导出', 'warning');
                return;
            }
            
            // 验证数据完整性
            const validationErrors = validateProcessData();
            if (validationErrors.length > 0) {
                if (!confirm(`发现数据问题：${validationErrors[0]}\n\n是否仍要继续导出？`)) {
                    return;
                }
            }
            
            try {
                showNotification('正在生成Excel文件...', 'info');
                
                // 创建工作簿
                const workbook = new ExcelJS.Workbook();
            workbook.creator = '模具制造系统';
            workbook.lastModifiedBy = '系统用户';
            workbook.created = new Date();
            workbook.modified = new Date();
            
            // 添加工作表
            const worksheet = workbook.addWorksheet('模具制造流程跟踪');
            
            // 定义列宽设置 - 所有日期列宽保持一致
            const columnWidths = [10, 15, 15, 15, 10, 15, 15, 10, 10, 20]; // 序号列宽设置为10，工序名称列宽设置为15，日期列宽设置为15，备注列宽设置为20
            worksheet.columns = columnWidths.map((width, index) => ({
                width,
                key: String.fromCharCode(65 + index)
            }));
            
            // 添加标题行
            const titleText = `模具制造流程跟踪表 - ${document.getElementById('moldName').value || '未命名'}`;
            const titleRow = worksheet.addRow([titleText]);
            titleRow.height = 35;
            titleRow.font = { bold: true, size: 20, color: { argb: 'FF165DFF' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
            worksheet.mergeCells('A1:J1');
            
            // 模具基本信息区域
            const basicInfoHeader = worksheet.addRow(['模具基本信息']);
            formatSectionHeader(worksheet, basicInfoHeader, 1, 10);
            
            // 第一行：模具编号、模具名称、模具类型、版本号、产品名称
            let rowNum = worksheet.rowCount + 1;
            const firstRow = worksheet.getRow(rowNum);
            firstRow.height = 25;
            
            const firstRowItems = [
                { label: '模具编号', id: 'moldNumber', width: 10 }, // 模具编号列宽设置为10
                { label: '模具名称', id: 'moldName', width: 10 }, // 模具名称列宽设置为10
                { label: '模具类型', id: 'moldType', width: 10 },
                { label: '版本号', id: 'version', width: 10 },
                { label: '产品名称', id: 'productName', width: 20 }
            ];
            
            firstRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // 标题单元格
                const cell = firstRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // 信息单元格
                const valueCell = firstRow.getCell(cellIndex + 1);
                valueCell.value = value;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // 第二行：产品材料、穴数、开模通知、试模日期、备注
            rowNum = worksheet.rowCount + 1;
            const secondRow = worksheet.getRow(rowNum);
            secondRow.height = 25;
            
            const secondRowItems = [
                { label: '产品材料', id: 'material', width: 10 }, // 材料列宽设置为10
                { label: '穴数', id: 'cavityCount', width: 10 }, // 穴数列宽设置为10
                { label: '开模通知', id: 'moldOpenNotice', width: 10 },
                { label: '试模日期', id: 'testDate', width: 10 },
                { label: '备注', id: 'moldRemark', width: 20 }
            ];
            
            secondRowItems.forEach((item, idx) => {
                const cellIndex = idx * 2 + 1;
                const value = document.getElementById(item.id).value || '';
                
                // 所有日期都使用不带年份的格式
                let displayValue;
                if (item.id.includes('Date') || item.id === 'moldOpenNotice') {
                    displayValue = value ? formatDateWithoutYear(value) : '';
                } else {
                    displayValue = value;
                }
                
                // 标题单元格
                const cell = secondRow.getCell(cellIndex);
                cell.value = `${item.label}:`;
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                cell.border = getStandardBorder();
                cell.alignment = { vertical: 'middle', horizontal: 'right' };
                worksheet.getColumn(cellIndex).width = 10;
                
                // 信息单元格
                const valueCell = secondRow.getCell(cellIndex + 1);
                valueCell.value = displayValue;
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                worksheet.getColumn(cellIndex + 1).width = item.width;
            });
            
            // 添加工序表头（移除多余空白行）
            const headerRow = worksheet.addRow([
                '序号', '工序名称', '计划开始', '计划结束', 
                '计划天数', '实际开始', '实际结束', '实际天数', '状态', '备注'
            ]);
            headerRow.height = 30;
            headerRow.eachCell(cell => {
                cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
                cell.border = {
                    top: { style: 'medium' },
                    left: { style: 'medium' },
                    bottom: { style: 'medium' },
                    right: { style: 'medium' }
                };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
            });
            
            // 重置数据列宽，确保所有日期列宽度一致
            [3, 4, 6, 7].forEach(colIndex => {
                worksheet.getColumn(colIndex).width = 10;
            });
            
            // 计算总计划天数和总实际天数
            let totalPlanDays = 0;
            let totalActualDays = 0;
            
            // 添加工序数据
            processData.forEach((process, index) => {
                // 累加各工序的计划天数和实际天数
                const planDays = process.planDays ? parseInt(process.planDays) : 0;
                const actualDays = process.actualDays ? parseInt(process.actualDays) : 0;
                totalPlanDays += planDays;
                totalActualDays += actualDays;
                
                // 确保计划结束日期正确显示
                const planEndDate = process.planEnd ? formatDateWithoutYear(process.planEnd) : '';
                
                const row = worksheet.addRow([
                    index + 1,
                    process.name || '',
                    process.planStart ? formatDateWithoutYear(process.planStart) : '',
                    planEndDate,
                    planDays,
                    process.actualStart ? formatDateWithoutYear(process.actualStart) : '',
                    process.actualEnd ? formatDateWithoutYear(process.actualEnd) : '',
                    actualDays,
                    getStatusName(process.status),
                    process.remark || ''
                ]);
                
                row.height = 25;
                
                // 设置状态单元格样式
                const statusCell = row.getCell(9);
                const statusInfo = statusOptions.find(s => s.name === statusCell.value) || statusOptions[0];
                if (statusInfo.id === 'completed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F4EA' } };
                } else if (statusInfo.id === 'inProgress') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEF3C7' } };
                } else if (statusInfo.id === 'delayed') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
                } else if (statusInfo.id === 'pending') {
                    statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEF2F7' } };
                }
                
                // 设置边框和对齐方式
                row.eachCell(cell => {
                    cell.border = getStandardBorder();
                    cell.alignment = { vertical: 'middle' };
                });
                
                // 设置水平居中的列
                [1, 3, 4, 5, 6, 7, 8, 9].forEach(colIndex => {
                    row.getCell(colIndex).alignment = { ...row.getCell(colIndex).alignment, horizontal: 'center' };
                });
                
                // 确保备注列宽为20
                worksheet.getColumn(10).width = 20;
            });
            
            // 移除了工艺流程跟踪表和周期统计之间的空行
            
            // 优化的周期统计区域 - 只保留总计划周期和总实际周期
            // 创建周期统计标题行 - 醒目样式
            const statsHeaderRow = worksheet.getRow(worksheet.rowCount + 1);
            statsHeaderRow.height = 28;
            statsHeaderRow.values = ['', '周期统计摘要', '', '', '', '', '', '', '', ''];
            statsHeaderRow.getCell(2).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            statsHeaderRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF165DFF' } };
            statsHeaderRow.getCell(2).border = getStandardBorder();
            statsHeaderRow.getCell(2).alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.mergeCells(statsHeaderRow.number, 2, statsHeaderRow.number, 9);
            
            // 计算从开始到结束的总周期（包含所有日期，不再排除周末）
            const firstPlanStart = processData[0]?.planStart ? new Date(processData[0].planStart) : null;
            const lastPlanEnd = processData.length > 0 ? 
                new Date(processData[processData.length - 1].planEnd) : null;
            const totalPlanDuration = firstPlanStart && lastPlanEnd ? 
                calculateDaysBetween(firstPlanStart, lastPlanEnd) : 0;
                
            const firstActualStart = processData[0]?.actualStart ? new Date(processData[0].actualStart) : null;
            const lastActualEnd = processData.length > 0 && processData[processData.length - 1].actualEnd ? 
                new Date(processData[processData.length - 1].actualEnd) : null;
            const totalActualDuration = firstActualStart && lastActualEnd ? 
                calculateDaysBetween(firstActualStart, lastActualEnd) : 0;
            
            // 创建周期统计详情表格 - 只保留总计划周期和总实际周期
            const statsRows = [
                { label: "总计划周期", value: `${totalPlanDuration} 天`, color: "FF165DFF" },
                { label: "总实际周期", value: `${totalActualDuration} 天`, color: "FF27AE60" }
            ];
            
            // 添加统计数据行
            statsRows.forEach((stat, idx) => {
                const statRow = worksheet.getRow(worksheet.rowCount + 1);
                statRow.height = 24;
                
                // 标签单元格
                const labelCell = statRow.getCell(2);
                labelCell.value = stat.label;
                labelCell.font = { bold: true, size: 11 };
                labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
                labelCell.border = getStandardBorder();
                labelCell.alignment = { vertical: 'middle', horizontal: 'right' };
                
                // 值单元格
                const valueCell = statRow.getCell(3);
                valueCell.value = stat.value;
                valueCell.font = { bold: true, size: 11, color: { argb: stat.color } };
                valueCell.border = getStandardBorder();
                valueCell.alignment = { vertical: 'middle', horizontal: 'left' };
                
                // 合并值单元格到第9列，使内容更突出
                worksheet.mergeCells(statRow.number, 3, statRow.number, 9);
                
                // 为交替行添加背景色，增强可读性
                if (idx % 2 === 1) {
                    labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                    valueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };
                }
            });
            
            // 统一周期统计栏和工艺流程跟踪表的列宽
            const statsStartRow = statsHeaderRow.number;
            const statsEndRow = worksheet.rowCount;
            
            // 优化周期统计摘要栏的列宽
            worksheet.getColumn(1).width = 10;  // 序号列保持10
            worksheet.getColumn(2).width = 15;  // 工序名称列保持15
            worksheet.getColumn(3).width = 15;  // 值列加宽
            for (let i = 4; i <= 9; i++) {
                worksheet.getColumn(i).width = columnWidths[i - 1];  // 其他列保持原设定
            }
            // 确保备注列宽为20
            worksheet.getColumn(10).width = 20;
            
            // 设置打印选项
            worksheet.pageSetup.printArea = `A1:J${worksheet.rowCount}`;
            worksheet.pageSetup.orientation = 'landscape';
            worksheet.pageSetup.fitToPage = true;
            worksheet.pageSetup.fitToWidth = 1;
            worksheet.pageSetup.fitToHeight = 0;
            
            // 添加页脚
            const exportDate = formatDateWithYear(new Date().toISOString().split('T')[0]);
            worksheet.headerFooter.footerCenter = `导出日期: ${exportDate} | 第 &P 页 / 共 &N 页`;
            
            // 生成Excel文件并下载
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const fileName = `模具流程跟踪_${document.getElementById('moldNumber').value || '未知编号'}_${formatDateWithYear(new Date().toISOString().split('T')[0]).replace(/年|月|日/g, '')}.xlsx`;
                saveAs(blob, fileName);
                showNotification('Excel导出成功', 'success');
            }).catch(err => {
                console.error('导出失败:', err);
                showNotification('Excel导出失败', 'error');
            });
            
            } catch (error) {
                console.error('导出Excel时发生错误:', error);
                showNotification('导出Excel失败，请检查数据完整性', 'error');
            }
        }
        
        // 格式化分组标题
        function formatSectionHeader(worksheet, row, startCol, endCol) {
            row.height = 25;
            row.font = { bold: true, size: 14, color: { argb: 'FF333333' } };
            row.alignment = { horizontal: 'center', vertical: 'middle' };
            row.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                cell.border = getStandardBorder();
            });
            worksheet.mergeCells(row.number, startCol, row.number, endCol);
        }
        
        // 获取标准边框样式
        function getStandardBorder() {
            return {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        }
        
        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复。')) {
                // 清空模具基本信息
                document.getElementById('moldNumber').value = '';
                document.getElementById('moldName').value = '';
                document.getElementById('moldType').value = '';
                document.getElementById('version').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('material').value = '';
                document.getElementById('cavityCount').value = '';
                document.getElementById('moldOpenNotice').value = '';
                document.getElementById('testDate').value = '';
                document.getElementById('moldRemark').value = '';
                
                // 清空工序数据
                processData = [];
                nextProcessId = 1;
                // 重置排期设置为默认值
                scheduleSettings = {
                    includeDependencies: true
                };
                
                renderProcessTable();
                updateCycleStatistics();
                
                // 清除localStorage
                localStorage.removeItem('moldTrackingData');
                
                showNotification('所有数据已清空', 'info');
            }
        }
        
        // 初始化默认工序 - 增强版
        function initializeDefaultProcesses() {
            if (processData.length > 0 && !confirm('确定要初始化流程吗？当前流程数据将被覆盖。')) {
                return;
            }
            
            // 获取开模通知日期作为起始日期
            const startDate = document.getElementById('moldOpenNotice').value 
                ? new Date(document.getElementById('moldOpenNotice').value)
                : new Date();
            
            // 智能默认工序列表 - 包含预设天数
            const defaultProcesses = [
                { name: '设计评审', planDays: 2, remark: '图纸审核、工艺评估' },
                { name: '材料采购', planDays: 3, remark: '钢材、标准件采购' },
                { name: '深孔钻/铣床加工', planDays: 4, remark: '模板加工、深孔钻削' },
                { name: 'CNC粗加工', planDays: 5, remark: '毛坯CNC粗加工成型' },
                { name: '热处理/磨床加工', planDays: 2, remark: '淬火回火、精密磨削' },
                { name: '线割加工', planDays: 3, remark: '精密线切割加工' },
                { name: 'CNC精加工', planDays: 7, remark: '精密铣削、钻孔攻丝' },
                { name: 'EDM加工', planDays: 4, remark: '电火花加工成型' },
                { name: '省模/抛光', planDays: 2, remark: '模具抛光、表面处理' },
                { name: '配装合模', planDays: 3, remark: '零件装配、试合模' },
                { name: '试模', planDays: 1, remark: '首次试模验证' }
            ];
            
            processData = [];
            let currentDate = new Date(startDate);
            
            defaultProcesses.forEach((process, index) => {
                const planStart = formatDate(currentDate);
                
                // 计算结束日期
                const endDate = new Date(currentDate);
                if (process.planDays > 1) {
                    endDate.setDate(endDate.getDate() + process.planDays - 1);
                }
                const planEnd = formatDate(endDate);
                
                // 创建工序数据
                const newProcess = {
                    id: nextProcessId++,
                    name: process.name,
                    planStart,
                    planEnd,
                    planDays: process.planDays,
                    actualStart: '',
                    actualEnd: '',
                    actualDays: '',
                    status: 'pending',
                    remark: process.remark
                };
                
                processData.push(newProcess);
                
                // 更新下一个工序的开始日期
                currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() + 1);
            });
            
            // 立即渲染和保存
            renderProcessTable();
            updateCycleStatistics();
            autoSaveWithSync();
            
            showNotification('标准工艺流程已初始化，数据已自动保存', 'success');
        }
        
        // 添加新工序 - 智能化版本
        function addNewProcess() {
            // 智能工序名称建议
            const commonProcesses = [
                { name: '设计评审', days: 2, remark: '图纸审核、工艺评估' },
                { name: '材料采购', days: 3, remark: '钢材、标准件采购' },
                { name: 'CNC粗加工', days: 5, remark: '毛坯CNC粗加工成型' },
                { name: 'CNC精加工', days: 7, remark: '精密加工成型' },
                { name: '热处理', days: 2, remark: '淬火回火处理' },
                { name: '线割加工', days: 3, remark: '精密线切割' },
                { name: 'EDM加工', days: 4, remark: '电火花加工' },
                { name: '抛光', days: 2, remark: '表面抛光处理' },
                { name: '装配', days: 3, remark: '零件装配调试' },
                { name: '试模', days: 1, remark: '试模验证' }
            ];
            
            // 找到未使用的工序名称
            const usedNames = processData.map(p => p.name);
            const availableProcess = commonProcesses.find(p => !usedNames.includes(p.name));
            
            const newProcess = {
                id: nextProcessId++,
                name: availableProcess ? availableProcess.name : `新工序${processData.length + 1}`,
                planStart: '',
                planEnd: '',
                planDays: availableProcess ? availableProcess.days : 2,
                actualStart: '',
                actualEnd: '',
                actualDays: '',
                status: 'pending',
                remark: availableProcess ? availableProcess.remark : ''
            };
            
            // 智能设置开始日期
            if (processData.length > 0) {
                const lastProcess = processData[processData.length - 1];
                if (lastProcess.planEnd) {
                    const nextStartDate = new Date(lastProcess.planEnd);
                    nextStartDate.setDate(nextStartDate.getDate() + 1);
                    newProcess.planStart = formatDate(nextStartDate);
                    
                    // 自动计算结束日期
                    const endDate = new Date(nextStartDate);
                    if (newProcess.planDays > 1) {
                        endDate.setDate(endDate.getDate() + newProcess.planDays - 1);
                    }
                    newProcess.planEnd = formatDate(endDate);
                } else if (lastProcess.planStart) {
                    newProcess.planStart = lastProcess.planStart;
                }
            } else {
                // 第一个工序，使用开模通知日期或当前日期
                const startDate = document.getElementById('moldOpenNotice').value 
                    ? new Date(document.getElementById('moldOpenNotice').value)
                    : new Date();
                newProcess.planStart = formatDate(startDate);
                
                // 计算结束日期
                const endDate = new Date(startDate);
                if (newProcess.planDays > 1) {
                    endDate.setDate(endDate.getDate() + newProcess.planDays - 1);
                }
                newProcess.planEnd = formatDate(endDate);
            }
            
            processData.push(newProcess);
            renderProcessTable();
            updateCycleStatistics();
            autoSaveWithSync();
            
            // 自动聚焦到新工序的名称输入框
            setTimeout(() => {
                const newInput = document.querySelector(`.process-name[data-id="${newProcess.id}"]`);
                if (newInput) {
                    newInput.focus();
                    newInput.select();
                }
            }, 100);
            
            showNotification(`已添加工序"${newProcess.name}"，预计${newProcess.planDays}天`, 'success');
        }
        
        // 渲染工序表格
        function renderProcessTable() {
            processTableBody.innerHTML = '';
            
            if (processData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-folder-open-o text-2xl mb-2"></i>
                        <p>暂无工序数据，请点击"初始化流程"或"添加工序"</p>
                    </td>
                `;
                processTableBody.appendChild(emptyRow);
                return;
            }
            
            processData.forEach((process, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-bg';
                row.dataset.id = process.id;
                
                // 获取状态样式
                const statusInfo = statusOptions.find(s => s.id === process.status) || statusOptions[0];
                
                row.innerHTML = `
                    <td class="serial-number-col px-2 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900 text-center">${index + 1}</div>
                    </td>
                    <td class="process-name-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.name || ''}" 
                               class="process-name w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               maxlength="15">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.planStart ? formatDate(new Date(process.planStart)) : ''}" 
                               class="plan-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.planEnd ? formatDate(new Date(process.planEnd)) : ''}" 
                               class="plan-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="plan-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="0" value="${process.planDays || ''}" 
                               class="plan-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}"
                               placeholder="0">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.actualStart ? formatDate(new Date(process.actualStart)) : ''}" 
                               class="actual-start w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="date-col px-2 py-3 whitespace-nowrap">
                        <input type="date" value="${process.actualEnd ? formatDate(new Date(process.actualEnd)) : ''}" 
                               class="actual-end w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm bg-white"
                               data-id="${process.id}"
                               data-index="${index}"
                               style="color-scheme: light; cursor: pointer;">
                    </td>
                    <td class="actual-days-col px-2 py-3 whitespace-nowrap">
                        <input type="number" min="0" value="${process.actualDays || ''}" 
                               class="actual-days w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-center text-sm"
                               data-id="${process.id}"
                               data-index="${index}"
                               placeholder="0">
                    </td>
                    <td class="status-col px-2 py-3 whitespace-nowrap">
                        <span class="status-badge inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.class} cursor-pointer border"
                              data-id="${process.id}" data-current="${process.status}">
                            ${statusInfo.name}
                        </span>
                    </td>
                    <td class="remark-col px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${process.remark || ''}" 
                               class="remark w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary outline-none text-sm"
                               data-id="${process.id}"
                               placeholder="备注">
                    </td>
                    <td class="action-col px-2 py-3 whitespace-nowrap text-sm font-medium text-center">
                        <button class="delete-process text-danger hover:text-danger/80 mr-1 p-1 rounded hover:bg-red-100 transition-colors" data-id="${process.id}" title="删除">
                            <i class="fa fa-trash-o"></i>
                        </button>
                        <button class="move-up text-gray-500 hover:text-primary mr-1 p-1 rounded hover:bg-blue-100 transition-colors" data-id="${process.id}" title="上移">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                        <button class="move-down text-gray-500 hover:text-primary p-1 rounded hover:bg-blue-100 transition-colors" data-id="${process.id}" title="下移">
                            <i class="fa fa-arrow-down"></i>
                        </button>
                    </td>
                `;
                
                processTableBody.appendChild(row);
            });
            
            // 添加事件监听器到动态生成的元素
            attachProcessEvents();
        }
        
        // 事件监听器管理器 - 修复内存泄漏问题
        let eventListeners = new Map(); // 存储事件监听器引用
        
        // 清理所有事件监听器
        function cleanupEventListeners() {
            eventListeners.forEach((listeners, element) => {
                listeners.forEach(({ event, handler }) => {
                    element.removeEventListener(event, handler);
                });
            });
            eventListeners.clear();
        }
        
        // 安全添加事件监听器
        function addEventListenerSafe(element, event, handler) {
            if (!eventListeners.has(element)) {
                eventListeners.set(element, []);
            }
            
            // 移除可能存在的旧监听器
            element.removeEventListener(event, handler);
            
            // 添加新监听器
            element.addEventListener(event, handler);
            eventListeners.get(element).push({ event, handler });
        }
        
        // 为工序表格元素添加事件监听器 - 修复版（防止内存泄漏）
        function attachProcessEvents() {
            // 先清理旧的事件监听器
            cleanupEventListeners();
            // 工序名称输入 - 智能建议和自动保存
            document.querySelectorAll('.process-name').forEach(input => {
                const changeHandler = (e) => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldName = process.name;
                        process.name = e.target.value.substring(0, 15);
                        
                        // 如果是第一次设置工序名称，智能设置天数和备注
                        if (oldName.startsWith('新工序') && process.name !== oldName) {
                            autoSetProcessDefaults(process);
                        }
                        
                        autoSaveWithSync();
                        showNotification(`工序名称已更新为"${process.name}"`, 'info');
                    }
                };
                
                const inputHandler = (e) => {
                    showProcessSuggestions(e.target);
                };
                
                addEventListenerSafe(input, 'change', changeHandler);
                addEventListenerSafe(input, 'input', inputHandler);
            });
            
            // 备注输入
            document.querySelectorAll('.remark').forEach(input => {
                const changeHandler = (e) => {
                    const processId = parseInt(e.target.dataset.id);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.remark = e.target.value;
                        autoSaveWithSync();
                    }
                };
                
                addEventListenerSafe(input, 'change', changeHandler);
            });
            
            // 增强日期选择器体验
            document.querySelectorAll('.date-picker-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input[type="date"]');
                
                wrapper.addEventListener('click', () => {
                    if (typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                });
            });
            
            // 计划开始日期 - 智能化处理
            document.querySelectorAll('.plan-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planStart = e.target.value;
                        
                        // 如果是第一个工序，智能处理
                        if (processIndex === 0) {
                            handleFirstProcessDateChange(process);
                        } else {
                            // 其他工序的智能处理
                            handleSubsequentProcessDateChange(process, processIndex);
                        }
                        
                        autoSaveWithSync();
                    }
                });
            });
            
            // 计划结束日期 - 修改时自动计算计划天数和后续工序，并重新计算
            document.querySelectorAll('.plan-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.planEnd = e.target.value;
                        
                        // 立即更新相关计算
                        calculateAndUpdatePlanDays(processId);
                        updateSubsequentPlansIntelligent(processIndex);
                        updateCycleStatistics();
                        
                        // 重新渲染表格以显示更新
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // 计划天数 - 智能化处理
            document.querySelectorAll('.plan-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const days = parseInt(e.target.value) || 0;
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldDays = process.planDays;
                        process.planDays = days;
                        
                        // 智能处理天数变更
                        handlePlanDaysChange(process, processIndex, oldDays, days);
                        
                        autoSaveWithSync();
                    }
                });
            });
            
            // 实际开始日期 - 修改时自动计算实际结束日期和后续工序，并重新计算
            document.querySelectorAll('.actual-start').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualStart = e.target.value;
                        
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 重新渲染表格以显示更新
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // 实际结束日期 - 修改时自动计算实际天数和后续工序，并重新计算
            document.querySelectorAll('.actual-end').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        process.actualEnd = e.target.value;
                        calculateAndUpdateActualDays(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 重新渲染表格以显示更新
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // 实际天数 - 修改时自动计算实际结束日期和后续工序，并重新计算
            document.querySelectorAll('.actual-days').forEach(input => {
                input.addEventListener('change', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const processIndex = parseInt(e.target.dataset.index);
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const days = parseInt(e.target.value) || 0;
                        process.actualDays = days;
                        calculateAndUpdateActualEnd(processId);
                        updateSubsequentActuals(processIndex);
                        updateCycleStatistics();
                        
                        // 重新渲染表格以显示更新
                        renderProcessTable();
                        saveData();
                    }
                });
            });
            
            // 状态标签点击切换 - 智能化处理
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', e => {
                    const processId = parseInt(e.target.dataset.id);
                    const currentStatus = e.target.dataset.current;
                    const currentIndex = statusOptions.findIndex(s => s.id === currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOptions.length;
                    const nextStatus = statusOptions[nextIndex].id;
                    
                    const process = processData.find(p => p.id === processId);
                    if (process) {
                        const oldStatus = process.status;
                        process.status = nextStatus;
                        
                        // 智能处理状态变更
                        handleStatusChange(process, oldStatus, nextStatus);
                        
                        // 立即更新显示和保存
                        renderProcessTable();
                        updateCycleStatistics();
                        autoSaveWithSync();
                        
                        // 显示状态变更提示
                        const statusName = statusOptions.find(s => s.id === nextStatus).name;
                        showNotification(`工序"${process.name}"状态已更新为: ${statusName}`, 'success');
                    }
                });
            });
            
            // 删除工序
            document.querySelectorAll('.delete-process').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    if (confirm('确定要删除此工序吗？后续工序将自动调整。')) {
                        const processIndex = processData.findIndex(p => p.id === processId);
                        const deletedProcess = processData.find(p => p.id === processId);
                        processData = processData.filter(p => p.id !== processId);
                        
                        // 调整后续工序的日期
                        if (processIndex < processData.length) {
                            // 更新后续所有工序的日期
                            updateSubsequentPlans(processIndex - 1);
                            updateSubsequentActuals(processIndex - 1);
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        
                        // 检查排期冲突
                        const conflicts = checkScheduleConflicts();
                        if (conflicts.length > 0) {
                            highlightConflicts(conflicts);
                            showNotification(`检测到 ${conflicts.length} 处排期冲突`, 'warning');
                        } else {
                            showNotification('工序已删除，后续工序已自动调整', 'info');
                        }
                        
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 上移工序
            document.querySelectorAll('.move-up').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index > 0) {
                        // 交换位置
                        [processData[index], processData[index - 1]] = [processData[index - 1], processData[index]];
                        
                        // 调整受影响的工序日期
                        if (index - 1 > 0) {
                            // 更新上一个工序的后续
                            updateSubsequentPlans(index - 2);
                            updateSubsequentActuals(index - 2);
                        } else {
                            // 如果上移到第一个位置，从第一个工序开始更新后续
                            updateSubsequentPlans(index - 1);
                            updateSubsequentActuals(index - 1);
                        }
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
            
            // 下移工序
            document.querySelectorAll('.move-down').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const processId = parseInt(e.currentTarget.dataset.id);
                    const index = processData.findIndex(p => p.id === processId);
                    if (index < processData.length - 1) {
                        // 交换位置
                        [processData[index], processData[index + 1]] = [processData[index + 1], processData[index]];
                        
                        // 调整受影响的工序日期
                        updateSubsequentPlans(index - 1);
                        updateSubsequentActuals(index - 1);
                        
                        renderProcessTable();
                        updateCycleStatistics();
                        // 自动重新计算
                        recalculateSchedule();
                    }
                });
            });
        }
        
        // 更新后续工序的计划日期
        function updateSubsequentPlans(startIndex) {
            // 从startIndex + 1开始更新所有后续工序
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // 如果前一工序有计划结束日期，设置当前工序的计划开始日期
                if (prevProcess && prevProcess.planEnd) {
                    // 计算下一个工作日作为开始日期（前一工序结束日期的下一天）
                    const prevEndDate = new Date(prevProcess.planEnd);
                    prevEndDate.setDate(prevEndDate.getDate() + 1);
                    currentProcess.planStart = formatDate(prevEndDate);
                    
                    // 如果当前工序有计划天数，自动计算计划结束日期
                    if (currentProcess.planDays && currentProcess.planDays > 0) {
                        calculateAndUpdatePlanEnd(currentProcess.id);
                    }
                } else if (prevProcess && prevProcess.planStart && !prevProcess.planEnd) {
                    // 如果前一工序只有开始日期没有结束日期，使用开始日期作为参考
                    currentProcess.planStart = prevProcess.planStart;
                    
                    if (currentProcess.planDays && currentProcess.planDays > 0) {
                        calculateAndUpdatePlanEnd(currentProcess.id);
                    }
                }
            }
        }

        // 智能推算后续工序的计划日期（全新设计）
        function updateSubsequentPlansIntelligent(startIndex) {
            // 从startIndex开始重新计算所有后续工序
            for (let i = startIndex; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = i > 0 ? processData[i - 1] : null;
                
                // 跳过第一个工序（除非它是被修改的工序）
                if (i === 0 && startIndex !== 0) continue;
                
                // 为当前工序计算开始日期
                if (i > 0 && prevProcess) {
                    calculateProcessStartDate(currentProcess, prevProcess);
                }
                
                // 计算当前工序的结束日期
                calculateProcessEndDate(currentProcess);
            }
        }

        // 计算工序开始日期
        function calculateProcessStartDate(currentProcess, prevProcess) {
            if (prevProcess.planEnd) {
                // 前一工序有结束日期，当前工序从下一天开始
                const nextStartDate = new Date(prevProcess.planEnd);
                nextStartDate.setDate(nextStartDate.getDate() + 1);
                currentProcess.planStart = formatDate(nextStartDate);
            } else if (prevProcess.planStart) {
                // 前一工序只有开始日期，智能推算
                const prevStartDate = new Date(prevProcess.planStart);
                
                // 如果前一工序有天数，使用天数计算
                if (prevProcess.planDays && prevProcess.planDays > 0) {
                    prevStartDate.setDate(prevStartDate.getDate() + parseInt(prevProcess.planDays));
                    currentProcess.planStart = formatDate(prevStartDate);
                } else {
                    // 没有天数，假设1天工期
                    prevStartDate.setDate(prevStartDate.getDate() + 1);
                    currentProcess.planStart = formatDate(prevStartDate);
                }
            }
        }

        // 计算工序结束日期
        function calculateProcessEndDate(process) {
            if (process.planStart && process.planDays && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
        }

        // 全量智能重新计算（从第一个工序开始）
        function fullIntelligentRecalculation() {
            if (processData.length === 0) return;
            
            // 确保第一个工序有开始日期
            if (!processData[0].planStart) {
                const startDate = getCalculationStartDate();
                processData[0].planStart = startDate;
            }
            
            // 自动填充默认天数（如果为空）
            autoFillDefaultDays();
            
            // 从第一个工序开始重新计算所有工序
            updateSubsequentPlansIntelligent(0);
            
            // 更新界面和统计
            renderProcessTable();
            updateCycleStatistics();
            
            // 同步数据到模具管理列表
            syncToMoldManagement();
            
            saveData();
        }
        
        // 自动填充默认天数
        function autoFillDefaultDays() {
            const defaultDays = [3, 2, 4, 5, 2, 3, 7, 4, 2, 3, 1]; // 对应默认工序的天数
            
            processData.forEach((process, index) => {
                if (!process.planDays || process.planDays === 0 || process.planDays === '') {
                    // 如果没有设置天数，使用默认值
                    if (index < defaultDays.length) {
                        process.planDays = defaultDays[index];
                    } else {
                        process.planDays = 2; // 超出默认数组的工序使用2天
                    }
                }
            });
        }
        
        // 同步数据到模具管理列表
        function syncToMoldManagement() {
            // 计算总工期和关键日期
            const totalDays = processData.reduce((sum, process) => sum + (parseInt(process.planDays) || 0), 0);
            const startDate = processData.length > 0 ? processData[0].planStart : '';
            const endDate = processData.length > 0 ? processData[processData.length - 1].planEnd : '';
            
            // 计算完成进度
            const completedProcesses = processData.filter(p => p.status === 'completed').length;
            const progress = processData.length > 0 ? Math.round((completedProcesses / processData.length) * 100) : 0;
            
            // 更新当前模具的信息（如果存在）
            if (typeof moldsData !== 'undefined' && moldsData.length > 0) {
                // 这里可以根据当前编辑的模具ID更新对应的模具信息
                // 暂时更新第一个模具作为示例
                const currentMold = moldsData[0];
                if (currentMold) {
                    currentMold.totalDays = totalDays;
                    currentMold.startDate = startDate;
                    currentMold.endDate = endDate;
                    currentMold.progress = progress;
                    currentMold.updatedAt = new Date().toISOString();
                    
                    // 保存模具数据
                    if (typeof saveMoldsData === 'function') {
                        saveMoldsData();
                    }
                }
            }
        }
        
        // 更新后续工序的实际日期
        function updateSubsequentActuals(startIndex) {
            // 从startIndex + 1开始更新所有后续工序
            for (let i = startIndex + 1; i < processData.length; i++) {
                const currentProcess = processData[i];
                const prevProcess = processData[i - 1];
                
                // 设置当前工序的实际开始日期为前一工序的实际结束日期
                if (prevProcess.actualEnd) {
                    currentProcess.actualStart = prevProcess.actualEnd;
                    
                    // 根据实际开始日期和实际天数计算实际结束日期
                    calculateAndUpdateActualEnd(currentProcess.id);
                }
            }
        }
        
        // 计算并更新计划结束日期（包含所有日期）
        function calculateAndUpdatePlanEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planDays || process.planDays <= 0) {
                // 如果没有开始日期或天数为0，清空结束日期
                if (process) {
                    process.planEnd = '';
                }
                return;
            }
            
            let startDate = new Date(process.planStart);
            if (isNaN(startDate.getTime())) return;
            
            // 增加计划天数减1（因为包含当天）
            // 如果计划天数为1，则结束日期与开始日期相同
            if (process.planDays > 1) {
                startDate.setDate(startDate.getDate() + process.planDays - 1);
            }
            
            const formattedEndDate = formatDate(startDate);
            process.planEnd = formattedEndDate;
            
            // 直接更新输入框
            const endInput = document.querySelector(`.plan-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // 计算并更新计划天数（包含所有日期）
        function calculateAndUpdatePlanDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.planStart || !process.planEnd) return;
            
            const startDate = new Date(process.planStart);
            const endDate = new Date(process.planEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // 计算总天数（包含所有日期）
            const days = calculateDaysBetween(startDate, endDate);
            
            process.planDays = days;
            
            // 直接更新输入框
            const daysInput = document.querySelector(`.plan-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // 计算并更新实际结束日期（包含所有日期）
        function calculateAndUpdateActualEnd(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || process.actualDays === undefined || process.actualDays <= 0) return;
            
            let startDate = new Date(process.actualStart);
            if (isNaN(startDate.getTime())) return;
            
            // 增加实际天数减1（因为包含当天）
            // 如果实际天数为1，则结束日期与开始日期相同
            if (process.actualDays > 1) {
                startDate.setDate(startDate.getDate() + process.actualDays - 1);
            }
            
            const formattedEndDate = formatDate(startDate);
            process.actualEnd = formattedEndDate;
            
            // 直接更新输入框
            const endInput = document.querySelector(`.actual-end[data-id="${processId}"]`);
            if (endInput && endInput.value !== formattedEndDate) {
                endInput.value = formattedEndDate;
            }
        }
        
        // 计算并更新实际天数（包含所有日期）
        function calculateAndUpdateActualDays(processId) {
            const process = processData.find(p => p.id === processId);
            if (!process || !process.actualStart || !process.actualEnd) return;
            
            const startDate = new Date(process.actualStart);
            const endDate = new Date(process.actualEnd);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return;
            
            // 计算总天数（包含所有日期）
            const days = calculateDaysBetween(startDate, endDate);
            
            process.actualDays = days;
            
            // 直接更新输入框
            const daysInput = document.querySelector(`.actual-days[data-id="${processId}"]`);
            if (daysInput && parseInt(daysInput.value) !== days) {
                daysInput.value = days;
            }
        }
        
        // 格式化日期为YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 格式化日期为X月XX日（不含年份）
        function formatDateWithoutYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${month}月${day}日`;
            }
            return dateStr;
        }
        
        // 格式化日期为YYYY年X月XX日（包含年份）
        function formatDateWithYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);
                return `${year}年${month}月${day}日`;
            }
            return dateStr;
        }
        
        // 获取状态名称
        function getStatusName(statusId) {
            const status = statusOptions.find(s => s.id === statusId);
            return status ? status.name : '未知';
        }
        
        // 数据验证函数
        function validateProcessData() {
            const errors = [];
            
            processData.forEach((process, index) => {
                // 验证工序名称
                if (!process.name || process.name.trim() === '') {
                    errors.push(`工序 ${index + 1}: 工序名称不能为空`);
                }
                
                // 验证计划天数
                if (!process.planDays || process.planDays <= 0) {
                    errors.push(`工序 ${index + 1}: 计划天数必须大于0`);
                }
                
                // 验证日期格式和逻辑
                if (process.planStart && process.planEnd) {
                    const startDate = new Date(process.planStart);
                    const endDate = new Date(process.planEnd);
                    
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        errors.push(`工序 ${index + 1}: 日期格式无效`);
                    } else if (startDate > endDate) {
                        errors.push(`工序 ${index + 1}: 计划开始日期不能晚于结束日期`);
                    }
                }
                
                // 验证实际日期逻辑
                if (process.actualStart && process.actualEnd) {
                    const startDate = new Date(process.actualStart);
                    const endDate = new Date(process.actualEnd);
                    
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        errors.push(`工序 ${index + 1}: 实际日期格式无效`);
                    } else if (startDate > endDate) {
                        errors.push(`工序 ${index + 1}: 实际开始日期不能晚于结束日期`);
                    }
                }
                
                // 验证实际天数
                if (process.actualDays !== '' && process.actualDays < 0) {
                    errors.push(`工序 ${index + 1}: 实际天数不能为负数`);
                }
            });
            
            return errors;
        }
        
        // 使用统一的工具函数
        function safeParseDate(dateStr) {
            return Utils.safeParseDate(dateStr);
        }
        
        function formatDate(date) {
            return Utils.formatDate(date);
        }
        
        function formatDateForDisplay(date) {
            return Utils.formatDateForDisplay(date);
        }
        
        function normalizeStatus(status) {
            return Utils.normalizeStatus(status);
        }
        
        // 显示通知 - 使用统一的通知管理器
        function showNotification(message, type = 'info', duration = 3000) {
            notificationManager.show(message, type, duration);
        }
        
        // ==================== 模具管理功能 ====================
        
        // 页面切换功能
        function switchPage(page) {
            currentPage = page;
            
            // 更新导航按钮状态
            document.querySelectorAll('.sidebar-nav-item').forEach(btn => btn.classList.remove('active'));
            
            // 隐藏所有页面
            const managementPage = document.getElementById('managementPage');
            const trackingPage = document.getElementById('trackingPage');
            
            if (managementPage) managementPage.classList.remove('active');
            if (trackingPage) trackingPage.classList.remove('active');
            
            if (page === 'management') {
                document.getElementById('navManagement').classList.add('active');
                if (managementPage) managementPage.classList.add('active');
                renderMoldsList();
            } else if (page === 'tracking') {
                document.getElementById('navTracking').classList.add('active');
                if (trackingPage) trackingPage.classList.add('active');
            }
        }
        
        // 设置模具管理事件监听器 - 使用事件管理器
        function setupMoldManagementListeners() {
            if (createNewMold) eventManager.addListener(createNewMold, 'click', createNewMoldProject);
            if (searchMolds) eventManager.addListener(searchMolds, 'input', debounce(filterMolds, 300));
            // if (statusFilter) eventManager.addListener(statusFilter, 'change', filterMolds); // 下拉状态筛选已移除
            
            // 快速筛选按钮 - 使用事件委托
            eventManager.addListener(document, 'click', (e) => {
                if (e.target.classList.contains('quick-filter')) {
                    handleQuickFilter(e.target.dataset.filter);
                }
                
                // 重置筛选按钮
                if (e.target.id === 'resetFilters' || e.target.closest('#resetFilters')) {
                    resetAllFilters();
                }
                
                // 空状态按钮
                if (e.target.classList.contains('create-first-mold')) {
                    createNewMoldProject();
                }
            });
        }
        
        // 更新模具统计数据 - 增强版
        function updateMoldsStatistics() {
            const totalCount = moldsData.length;
            const activeCount = moldsData.filter(m => normalizeStatus(m.status) === 'active').length;
            const completedCount = moldsData.filter(m => normalizeStatus(m.status) === 'completed').length;
            const pendingCount = moldsData.filter(m => normalizeStatus(m.status) === 'pending').length;
            
            // 计算即将试模的数量（优化逻辑）
            const upcomingTestMolds = getUpcomingTestMolds();
            const upcomingTestCount = upcomingTestMolds.length;
            
            // 计算逾期的数量
            const overdueMolds = getOverdueMolds();
            const overdueCount = overdueMolds.length;
            
            // 更新统计显示
            // const totalElement = document.getElementById('totalMoldsCount'); // 已移除“总计”显示
            const activeElement = document.getElementById('activeMoldsCount');
            const completedElement = document.getElementById('completedMoldsCount');
            const pendingElement = document.getElementById('pendingMoldsCount');
            const upcomingTestElement = document.getElementById('upcomingTestCount');
            const overdueElement = document.getElementById('overdueCount');
            
            // if (totalElement) totalElement.textContent = totalCount;
            // 顶部右侧状态展示已移除，不再更新计数
            
            // 更新即将试模数量，带动画效果
            if (upcomingTestElement) {
                const currentCount = parseInt(upcomingTestElement.textContent) || 0;
                if (currentCount !== upcomingTestCount) {
                    animateCountChange(upcomingTestElement, currentCount, upcomingTestCount);
                }
                
                // 根据数量调整样式
                const parentBtn = upcomingTestElement.closest('.quick-filter');
                if (parentBtn) {
                    if (upcomingTestCount > 0) {
                        upcomingTestElement.classList.remove('bg-gray-100', 'text-gray-600');
                        upcomingTestElement.classList.add('bg-orange-100', 'text-orange-600');
                        parentBtn.classList.add('pulse-animation');
                    } else {
                        upcomingTestElement.classList.remove('bg-orange-100', 'text-orange-600');
                        upcomingTestElement.classList.add('bg-gray-100', 'text-gray-600');
                        parentBtn.classList.remove('pulse-animation');
                    }
                }
            }
            
            // 更新逾期数量，带动画效果
            if (overdueElement) {
                const currentCount = parseInt(overdueElement.textContent) || 0;
                if (currentCount !== overdueCount) {
                    animateCountChange(overdueElement, currentCount, overdueCount);
                }
                
                // 根据数量调整样式
                const parentBtn = overdueElement.closest('.quick-filter');
                if (parentBtn) {
                    if (overdueCount > 0) {
                        overdueElement.classList.remove('bg-gray-100', 'text-gray-600');
                        overdueElement.classList.add('bg-red-100', 'text-red-600');
                        parentBtn.classList.add('urgent-pulse');
                    } else {
                        overdueElement.classList.remove('bg-red-100', 'text-red-600');
                        overdueElement.classList.add('bg-gray-100', 'text-gray-600');
                        parentBtn.classList.remove('urgent-pulse');
                    }
                }
            }
            
            // 更新筛选结果计数
            const filteredCountElement = document.getElementById('filteredCount');
            if (filteredCountElement) {
                const currentFiltered = currentFilteredMolds || moldsData;
                filteredCountElement.textContent = currentFiltered.length;
            }
        }
        
        // 数字变化动画
        function animateCountChange(element, fromValue, toValue) {
            const duration = 500;
            const startTime = performance.now();
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用缓动函数
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.round(fromValue + (toValue - fromValue) * easeOutQuart);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    element.textContent = toValue;
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // 获取状态徽章样式类
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending':
                    return 'bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg px-2 py-1';
                case 'active':
                    return 'bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1';
                case 'completed':
                    return 'bg-green-50 text-green-700 border border-green-200 rounded-lg px-2 py-1';
                default:
                    return 'bg-gray-50 text-gray-700 border border-gray-200 rounded-lg px-2 py-1';
            }
        }
        
        // 格式化日期显示（用于UI显示）
        function formatDisplayDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // 处理快速筛选 - 增强版
        function handleQuickFilter(filterType) {
            // 移除其他按钮的激活状态
            document.querySelectorAll('.quick-filter').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-yellow-500', 'bg-red-500');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // 激活当前按钮并设置对应颜色
            const currentBtn = event.target.closest('.quick-filter');
            if (currentBtn) {
                currentBtn.classList.remove('bg-gray-100', 'text-gray-700');
                
                // 根据筛选类型设置不同颜色
                switch (filterType) {
                    case 'today':
                        currentBtn.classList.add('bg-blue-500', 'text-white');
                        break;
                    case 'recent':
                        currentBtn.classList.add('bg-green-500', 'text-white');
                        break;
                    case 'week':
                        currentBtn.classList.add('bg-purple-500', 'text-white');
                        break;
                    case 'active':
                        currentBtn.classList.add('bg-orange-500', 'text-white');
                        break;
                    case 'completed':
                        currentBtn.classList.add('bg-green-500', 'text-white');
                        break;
                    case 'urgent':
                        currentBtn.classList.add('bg-yellow-500', 'text-white');
                        break;
                    case 'overdue':
                        currentBtn.classList.add('bg-red-500', 'text-white');
                        break;
                    default:
                        currentBtn.classList.add('bg-blue-500', 'text-white');
                }
            }
            
            // 设置全局筛选状态
            currentQuickFilter = filterType;
            
            // 重新筛选和渲染
            filterMolds();
            
            // 显示筛选结果提示
            const filteredCount = currentFilteredMolds ? currentFilteredMolds.length : 0;
            const filterName = getFilterName(filterType);
            
            if (filteredCount === 0) {
                showNotification(`没有找到符合"${filterName}"条件的模具`, 'info');
            } else {
                showNotification(`找到 ${filteredCount} 个符合"${filterName}"条件的模具`, 'success');
            }
        }
        
        // 获取筛选名称 - 增强版
        function getFilterName(filterType) {
            switch (filterType) {
                case 'today': return '今日更新';
                case 'recent': return '最近3天';
                case 'week': return '本周创建';
                case 'active': return '进行中';
                case 'completed': return '已完成';
                case 'urgent': return '即将试模';
                case 'overdue': return '已逾期';
                default: return '全部';
            }
        }
        
        // 重置所有筛选
        function resetAllFilters() {
            // 重置快速筛选按钮状态
            document.querySelectorAll('.quick-filter').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-yellow-500', 'bg-red-500');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // 重置搜索框
            if (searchMolds) searchMolds.value = '';
            
            // 重置状态筛选器（下拉已移除，保留此处为空操作以兼容旧逻辑）
            // const statusFilter = document.getElementById('statusFilter'); // 已移除下拉状态筛选
            // if (statusFilter) statusFilter.value = '';
            
            // 重置全局状态
            currentQuickFilter = null;
            currentFilteredMolds = null;
            
            // 清除搜索结果提示
            const searchResultsInfo = document.getElementById('searchResultsInfo');
            if (searchResultsInfo) searchResultsInfo.innerHTML = '';
            
            // 重新渲染
            renderMoldsList();
            
            showNotification('已重置所有筛选条件', 'info');
        }
        
        // 初始化筛选功能
        function initializeFilterSystem() {
            // 更新统计数据
            updateMoldsStatistics();
            
            // 设置定时更新
            setInterval(() => {
                updateMoldsStatistics();
            }, 30000); // 每30秒更新一次统计数据
        }
        
        // 重置所有筛选条件
        function resetAllFilters() {
            // 直接刷新页面，重置所有状态
            window.location.reload();
        }
        
        // 加载模具数据
        function loadMoldsData() {
            const savedMolds = localStorage.getItem('moldsManagementData');
            if (savedMolds) {
                try {
                    const data = JSON.parse(savedMolds);
                    moldsData = data.molds || [];
                    nextMoldId = data.nextId || 1;
                } catch (error) {
                    console.error('加载模具数据失败:', error);
                    moldsData = [];
                    nextMoldId = 1;
                }
            }
        }
        
        // 保存模具数据
        function saveMoldsData() {
            try {
                const dataToSave = {
                    molds: moldsData,
                    nextId: nextMoldId,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('moldsManagementData', JSON.stringify(dataToSave));
                return true;
            } catch (error) {
                console.error('保存模具数据失败:', error);
                showNotification('保存模具数据失败', 'error');
                return false;
            }
        }
        
        // 创建新模具项目 - 优化版本
        function createNewMoldProject() {
            showCreateMoldModal();
        }
        
        // 显示创建模具的模态框 - 现代化设计
        function showCreateMoldModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm';
            modal.innerHTML = `
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden border border-gray-100">
                    <!-- 现代化标题栏 -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-8 py-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-1">创建新模具项目</h3>
                                <p class="text-sm text-gray-600">填写基本信息开始您的模具制造项目</p>
                            </div>
                            <button class="close-modal text-gray-400 hover:text-gray-600 w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-50 rounded-full transition-all duration-200">
                                <i class="fa fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 现代化表单内容 -->
                    <div class="overflow-y-auto max-h-[60vh]">
                        <form id="createMoldForm" class="px-8 py-6">
                            <div class="space-y-6">
                                <!-- 基础信息 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            模具编号
                                        </label>
                                        <input type="text" id="newMoldNumber" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="输入唯一编号">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            模具名称
                                        </label>
                                        <input type="text" id="newMoldName"
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="输入模具名称">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">模具类型</label>
                                        <select id="newMoldType" 
                                                class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white">
                                            <option value="">选择类型</option>
                                            <option value="注塑模">注塑模</option>
                                            <option value="压铸模">压铸模</option>
                                            <option value="冲压模">冲压模</option>
                                            <option value="吹塑模">吹塑模</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">产品名称</label>
                                        <input type="text" id="newProductName" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="输入产品名称">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">产品材料</label>
                                        <input type="text" id="newMaterial" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="如: ABS、PC、PP">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">穴数</label>
                                        <input type="number" id="newCavityCount" min="1"
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="输入穴数">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">开模通知日期 <span class="text-red-500">*</span></label>
                                        <input type="date" id="newMoldOpenNotice" 
                                               style="width: 100%; padding: 8px 40px 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
                                               required>
                                        <small class="text-gray-500 text-xs mt-1 block">客户下达开模通知的日期，点击右侧日历图标选择</small>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">版本号</label>
                                        <input type="text" id="newVersion" 
                                               class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white"
                                               placeholder="如: V1.0">
                                    </div>
                                </div>
                                
                                <!-- 备注 -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">备注说明</label>
                                    <textarea id="newMoldRemark" rows="3" 
                                              class="w-full px-4 py-3 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none rounded-xl transition-all duration-200 bg-gray-50 focus:bg-white resize-none"
                                              placeholder="输入备注信息（可选）"></textarea>
                                </div>
                                
                                <!-- 选项 -->
                                <div class="bg-blue-50 rounded-xl p-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">创建选项</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="initWithDefaultProcesses" checked 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 rounded">
                                            <span class="ml-3 text-sm text-gray-700">自动创建标准工艺流程</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="autoSwitchToEdit" checked 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 rounded">
                                            <span class="ml-3 text-sm text-gray-700">创建后立即进入编辑模式</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 现代化底部按钮栏 -->
                    <div class="bg-white border-t border-gray-100 px-8 py-6">
                        <div class="flex gap-4 justify-end">
                            <button type="button" class="cancel-create px-6 py-3 bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all duration-200 font-medium rounded-xl flex items-center">
                                <i class="fa fa-times mr-2"></i>取消
                            </button>
                            <button type="submit" form="createMoldForm" class="px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-semibold rounded-xl shadow-lg hover:shadow-xl flex items-center">
                                <i class="fa fa-plus mr-2"></i>创建项目
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            

            
            // 聚焦到第一个输入框并设置默认值
            setTimeout(() => {
                document.getElementById('newMoldNumber').focus();
                
                // 设置开模通知日期的默认值为当前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('newMoldOpenNotice').value = today;
            }, 100);
            
            // 事件监听
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.cancel-create').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 表单提交
            document.getElementById('createMoldForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateMold(modal);
            });
            
            // 实时验证模具编号
            document.getElementById('newMoldNumber').addEventListener('input', (e) => {
                const value = e.target.value.trim();
                const exists = moldsData.some(mold => mold.moldNumber === value);
                const input = e.target;
                
                if (exists && value) {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-gray-300');
                    
                    // 显示错误提示
                    let errorMsg = input.parentNode.querySelector('.error-msg');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'error-msg text-xs text-red-500 mt-1';
                        input.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = '该编号已存在，请使用其他编号';
                } else {
                    input.classList.remove('border-red-500', 'bg-red-50');
                    input.classList.add('border-gray-300');
                    
                    const errorMsg = input.parentNode.querySelector('.error-msg');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });
        }
        
        // 处理创建模具
        function handleCreateMold(modal) {
            const formData = {
                moldNumber: document.getElementById('newMoldNumber').value.trim(),
                moldName: document.getElementById('newMoldName').value.trim(),
                moldType: document.getElementById('newMoldType').value,
                version: document.getElementById('newVersion').value.trim(),
                productName: document.getElementById('newProductName').value.trim(),
                material: document.getElementById('newMaterial').value.trim(),
                cavityCount: document.getElementById('newCavityCount').value,
                moldOpenNotice: document.getElementById('newMoldOpenNotice').value,
                moldRemark: document.getElementById('newMoldRemark').value.trim(),
                initWithDefaultProcesses: document.getElementById('initWithDefaultProcesses').checked,
                autoSwitchToEdit: document.getElementById('autoSwitchToEdit').checked
            };
            
            // 检查编号是否已存在（仅当提供了编号时检查）
            if (formData.moldNumber && moldsData.some(mold => mold.moldNumber === formData.moldNumber)) {
                showNotification('模具编号已存在，请使用其他编号', 'warning');
                document.getElementById('newMoldNumber').focus();
                return;
            }
            
            // 创建新模具（即使没有提供编号和名称也允许创建）
            const newMold = {
                id: nextMoldId++,
                moldNumber: formData.moldNumber || `MD${nextMoldId}`, // 如果没有提供编号，使用默认编号
                moldName: formData.moldName || '未命名模具', // 如果没有提供名称，使用默认名称
                moldType: formData.moldType,
                version: formData.version,
                productName: formData.productName,
                material: formData.material,
                cavityCount: formData.cavityCount,
                moldOpenNotice: formData.moldOpenNotice,
                testDate: '',
                moldRemark: formData.moldRemark,
                processes: [],
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // 如果选择初始化默认工序
            if (formData.initWithDefaultProcesses) {
                newMold.processes = createDefaultProcesses(formData.moldOpenNotice);
            }
            
            moldsData.push(newMold);
            saveMoldsData();
            
            // 关闭模态框
            document.body.removeChild(modal);
            
            // 刷新列表
            renderMoldsList();
            
            // 显示成功消息
            showNotification(`模具项目 "${newMold.moldNumber}" 创建成功`, 'success');
            
            // 如果选择自动切换到编辑模式
            if (formData.autoSwitchToEdit) {
                setTimeout(() => {
                    editMold(newMold.id);
                }, 500);
            }
        }
        
        // 创建默认工序流程
        function createDefaultProcesses(startDate) {
            const defaultProcesses = [
                { name: '设计评审', planDays: '', remark: '' },
                { name: '材料采购', planDays: '', remark: '' },
                { name: '深孔钻/铣床加工', planDays: '', remark: '' },
                { name: 'CNC粗加工', planDays: '', remark: '' },
                { name: '热处理/磨床加工', planDays: '', remark: '' },
                { name: '线割加工', planDays: '', remark: '' },
                { name: 'CNC精加工', planDays: '', remark: '' },
                { name: 'EDM加工', planDays: '', remark: '' },
                { name: '省模/抛光', planDays: '', remark: '' },
                { name: '配装合模', planDays: '', remark: '' },
                { name: '试模', planDays: '', remark: '' }
            ];
            
            const processes = [];
            let currentDate = startDate ? new Date(startDate) : new Date();
            let processId = 1;
            
            defaultProcesses.forEach((process) => {
                const planStart = formatDate(currentDate);
                
                const endDate = new Date(currentDate);
                if (process.planDays > 1) {
                    endDate.setDate(endDate.getDate() + process.planDays - 1);
                }
                const planEnd = formatDate(endDate);
                
                processes.push({
                    id: processId++,
                    name: process.name,
                    planStart,
                    planEnd,
                    planDays: process.planDays,
                    actualStart: '',
                    actualEnd: '',
                    actualDays: '',
                    status: 'pending',
                    remark: process.remark
                });
                
                currentDate = new Date(endDate);
            });
            
            return processes;
        }
        
        // 渲染模具列表 - 现代化卡片布局（增强版）
        function renderMoldsList() {
            // 更新统计数据
            updateMoldsStatistics();
            
            const filteredMolds = getFilteredMolds();
            const moldsGridElement = document.getElementById('moldsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // 更新筛选计数
            const filteredCountElement = document.getElementById('filteredCount');
            if (filteredCountElement) {
                filteredCountElement.textContent = filteredMolds.length;
            }
            
            if (filteredMolds.length === 0) {
                moldsGridElement.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            moldsGridElement.innerHTML = filteredMolds.map(mold => {
                // 使用增强的进度计算
                const progress = mold.progress || calculateMoldProgress(mold.processes);
                const totalDays = mold.totalDays || calculateTotalPlanDays(mold.processes);
                const completedDays = mold.completedDays || calculateCompletedDays(mold.processes);
                
                // 获取当前工序和下一个工序信息
                const processInfo = getCurrentAndNextProcessInfo(mold);
                
                // 计算剩余天数
                const remainingDays = Math.max(0, totalDays - completedDays);
                
                // 获取进度条颜色
                const progressColor = progress >= 100 ? 'from-green-500 to-green-600' : 
                                    progress >= 50 ? 'from-blue-500 to-blue-600' : 
                                    'from-orange-500 to-orange-600';
                
                return `
                    <div class="mold-card mold-card-details bg-white rounded-lg border border-gray-200 hover:shadow-md hover:border-blue-400 transition-all duration-200 group overflow-hidden" 
                         data-id="${mold.id}">
                        
                        <!-- 优化卡片头部 -->
                        <div class="p-3 border-b border-gray-200">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex items-start gap-2 flex-1 min-w-0">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-semibold text-gray-900 text-sm mb-0.5 truncate">${mold.moldNumber}</h3>
                                        <p class="text-gray-600 text-xs truncate">${mold.moldName || '未命名模具'}</p>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(mold.status)}">
                                        ${getStatusText(mold.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 优化卡片内容 -->
                        <div class="p-3 space-y-3">
                            <!-- 基本信息网格 -->
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex items-center">
                                    <span class="detail-label">产品名称:</span>
                                    <span class="detail-value truncate">${mold.productName || '未设置'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">模具类型:</span>
                                    <span class="detail-value truncate">${mold.moldType || '未设置'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">产品材料:</span>
                                    <span class="detail-value truncate">${mold.material || '未设置'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <span class="detail-label">总工期:</span>
                                    <span class="detail-value font-semibold">${totalDays}天</span>
                                </div>
                            </div>
                            
                            <!-- 工序进度状态 -->
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="card-section-title">工序状态</div>
                                <div class="space-y-2">
                                    <div class="flex items-center text-xs">
                                        <span class="detail-label">当前工序:</span>
                                        <span class="detail-value truncate">
                                            <span class="process-status-indicator ${processInfo.current.color.includes('blue') ? 'process-status-progress' : processInfo.current.color.includes('green') ? 'process-status-completed' : 'process-status-pending'}"></span>
                                            ${processInfo.current.text.replace('🔄 ', '').replace('⏳ ', '').replace('✅ ', '')}
                                        </span>
                                    </div>
                                    <div class="flex items-center text-xs">
                                        <span class="detail-label">下一工序:</span>
                                        <span class="detail-value truncate">
                                            <span class="process-status-indicator ${processInfo.next.color.includes('blue') ? 'process-status-progress' : processInfo.next.color.includes('green') ? 'process-status-completed' : 'process-status-pending'}"></span>
                                            ${processInfo.next.text.replace('🔄 ', '').replace('⏳ ', '').replace('✅ ', '')}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 移除进度条显示 -->
                        </div>
                        
                        <!-- 优化操作按钮 -->
                        <div class="px-3 py-2 bg-gray-50 border-t border-gray-200">
                            <div class="flex gap-2">
                                <button class="edit-mold flex-1 px-2 py-1.5 text-xs font-medium bg-white text-blue-600 border border-blue-300 hover:bg-blue-50 active:bg-blue-100 transition-all duration-200 rounded-lg" data-id="${mold.id}">
                                    编辑
                                </button>
                                <button class="export-mold px-2 py-1.5 text-xs font-medium bg-white text-green-600 border border-green-300 hover:bg-green-50 active:bg-green-100 transition-all duration-200 rounded-lg" data-id="${mold.id}" title="导出Excel">
                                    导出
                                </button>
                                <button class="delete-mold px-2 py-1.5 text-xs font-medium bg-white text-red-600 border border-red-300 hover:bg-red-50 active:bg-red-100 transition-all duration-200 rounded-lg" data-id="${mold.id}" title="删除模具">
                                    删除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 添加事件监听器
            attachMoldCardListeners();
        }
        
        // 格式化相对时间
        function formatRelativeTime(dateString) {
            if (!dateString) return '未知';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 7) return `${diffDays}天前`;
            
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }
        
        // 获取当前进行中的工序信息 - 修复版
        function getCurrentProcessInfo(mold) {
            if (!mold.processes || mold.processes.length === 0) {
                return {
                    text: '暂无工序',
                    color: 'text-gray-500',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">当前工序:</span>
                        <span class="text-gray-400">暂无工序</span>
                    </div>`
                };
            }
            
            // 查找进行中的工序
            const inProgressProcess = mold.processes.find(p => p.status === 'inProgress');
            if (inProgressProcess) {
                return {
                    text: `🔄 ${inProgressProcess.name}`,
                    color: 'text-blue-600',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">当前工序:</span>
                        <span class="text-blue-600 font-medium">🔄 ${inProgressProcess.name}</span>
                    </div>`
                };
            }
            
            // 查找下一个待开始的工序
            const nextProcess = mold.processes.find(p => p.status === 'pending');
            if (nextProcess) {
                return {
                    text: `⏳ ${nextProcess.name}`,
                    color: 'text-orange-600',
                    html: `<div class="flex justify-between text-sm">
                        <span class="text-gray-500">下一工序:</span>
                        <span class="text-orange-600">⏳ ${nextProcess.name}</span>
                    </div>`
                };
            }
            
            // 查找最后完成的工序
            const completedProcesses = mold.processes.filter(p => p.status === 'completed');
            if (completedProcesses.length > 0) {
                const lastCompleted = completedProcesses[completedProcesses.length - 1];
                if (completedProcesses.length === mold.processes.length) {
                    return {
                        text: `✅ 全部完成`,
                        color: 'text-green-600',
                        html: `<div class="flex justify-between text-sm">
                            <span class="text-gray-500">状态:</span>
                            <span class="text-green-600 font-medium">✅ 全部完成</span>
                        </div>`
                    };
                } else {
                    return {
                        text: `✅ ${lastCompleted.name}`,
                        color: 'text-green-600',
                        html: `<div class="flex justify-between text-sm">
                            <span class="text-gray-500">最后完成:</span>
                            <span class="text-green-600">✅ ${lastCompleted.name}</span>
                        </div>`
                    };
                }
            }
            
            // 显示第一个工序（如果都是待开始状态）
            const firstProcess = mold.processes[0];
            return {
                text: `首个: ${firstProcess.name}`,
                color: 'text-blue-600',
                html: `<div class="flex justify-between text-sm">
                    <span class="text-gray-500">首个工序:</span>
                    <span class="text-blue-600">${firstProcess.name}</span>
                </div>`
            };
        }
        
        // 获取当前工序和下一个工序信息
        function getCurrentAndNextProcessInfo(mold) {
            if (!mold.processes || mold.processes.length === 0) {
                return {
                    current: { text: '暂无工序', color: 'text-gray-500' },
                    next: { text: '暂无工序', color: 'text-gray-500' }
                };
            }
            
            // 查找进行中的工序
            const inProgressProcess = mold.processes.find(p => p.status === 'inProgress');
            if (inProgressProcess) {
                // 查找下一个待开始的工序
                const currentIndex = mold.processes.indexOf(inProgressProcess);
                const nextProcess = mold.processes.find((p, index) => index > currentIndex && p.status === 'pending');
                
                return {
                    current: { 
                        text: `🔄 ${inProgressProcess.name}`, 
                        color: 'text-blue-600' 
                    },
                    next: nextProcess ? { 
                        text: `⏳ ${nextProcess.name}`, 
                        color: 'text-orange-600' 
                    } : { 
                        text: '无下一工序', 
                        color: 'text-gray-500' 
                    }
                };
            }
            
            // 查找下一个待开始的工序（如果没有进行中的工序）
            const nextProcess = mold.processes.find(p => p.status === 'pending');
            if (nextProcess) {
                // 查找下一个待开始的工序之后的工序
                const currentIndex = mold.processes.indexOf(nextProcess);
                const followingProcess = mold.processes.find((p, index) => index > currentIndex && p.status === 'pending');
                
                return {
                    current: { 
                        text: `⏳ ${nextProcess.name}`, 
                        color: 'text-orange-600' 
                    },
                    next: followingProcess ? { 
                        text: `⏳ ${followingProcess.name}`, 
                        color: 'text-orange-600' 
                    } : { 
                        text: '无下一工序', 
                        color: 'text-gray-500' 
                    }
                };
            }
            
            // 查找最后完成的工序
            const completedProcesses = mold.processes.filter(p => p.status === 'completed');
            if (completedProcesses.length > 0) {
                const lastCompleted = completedProcesses[completedProcesses.length - 1];
                if (completedProcesses.length === mold.processes.length) {
                    return {
                        current: { 
                            text: `✅ 全部完成`, 
                            color: 'text-green-600' 
                        },
                        next: { 
                            text: '已完成', 
                            color: 'text-green-600' 
                        }
                    };
                } else {
                    return {
                        current: { 
                            text: `✅ ${lastCompleted.name}`, 
                            color: 'text-green-600' 
                        },
                        next: { 
                            text: '无下一工序', 
                            color: 'text-gray-500' 
                        }
                    };
                }
            }
            
            // 显示第一个工序（如果都是待开始状态）
            const firstProcess = mold.processes[0];
            const secondProcess = mold.processes.length > 1 ? mold.processes[1] : null;
            
            return {
                current: { 
                    text: `⏳ ${firstProcess.name}`, 
                    color: 'text-orange-600' 
                },
                next: secondProcess ? { 
                    text: `⏳ ${secondProcess.name}`, 
                    color: 'text-orange-600' 
                } : { 
                    text: '无下一工序', 
                    color: 'text-gray-500' 
                }
            };
        }
        
        // 获取过滤后的模具列表 - 增强版
        function getFilteredMolds() {
            let filtered = [...moldsData];
            
            // 增强的搜索过滤 - 支持多关键词和更多字段（不再通过搜索栏匹配状态，避免与筛选栏重复）
            const searchTerm = searchMolds ? searchMolds.value.toLowerCase().trim() : '';
            if (searchTerm) {
                // 过滤掉状态类关键词，状态统一交由快速筛选处理
                const statusKeywords = ['待开始','进行中','已完成','已延迟','pending','active','inprogress','completed','delayed'];
                const searchKeywords = searchTerm
                    .split(/\s+/)
                    .filter(keyword => keyword.length > 0 && !statusKeywords.includes(keyword));
                
                if (searchKeywords.length > 0) {
                    filtered = filtered.filter(mold => {
                        const searchableText = [
                            mold.moldNumber || '',
                            mold.moldName || '',
                            mold.productName || '',
                            mold.material || '',
                            mold.moldType || '',
                            mold.version || '',
                            mold.remark || '',
                            // 状态文本不参与搜索，避免与筛选栏重复
                            // 添加日期搜索支持
                            formatDisplayDate(mold.moldOpenNotice) || '',
                            formatDisplayDate(mold.testDate) || '',
                            formatDisplayDate(mold.createdAt) || '',
                            // 添加穴数搜索
                            (mold.cavityCount || '').toString()
                        ].join(' ').toLowerCase();
                        
                        // 所有关键词都必须匹配
                        return searchKeywords.every(keyword => 
                            searchableText.includes(keyword)
                        );
                    });
                }
            }
            
            // 状态过滤（下拉已移除，改由快速筛选控制 currentQuickFilter）
            // const statusValue = statusFilter ? statusFilter.value : '';
            // if (statusValue) {
            //     filtered = filtered.filter(mold => normalizeStatus(mold.status) === statusValue);
            // }
            
            // 如果有快速筛选激活，应用快速筛选逻辑
            if (currentQuickFilter && currentQuickFilter !== 'all') {
                filtered = applyQuickFilterLogic(filtered, currentQuickFilter);
            }
            
            // 智能排序：优先级排序
            return filtered.sort((a, b) => {
                // 1. 逾期的排在前面
                const aOverdue = isOverdue(a);
                const bOverdue = isOverdue(b);
                if (aOverdue !== bOverdue) return bOverdue - aOverdue;
                
                // 2. 即将试模的排在前面
                const aUpcoming = isUpcomingTest(a);
                const bUpcoming = isUpcomingTest(b);
                if (aUpcoming !== bUpcoming) return bUpcoming - aUpcoming;
                
                // 3. 按更新时间倒序
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
        }
        
        // 增强的过滤模具函数
        function filterMolds() {
            const filtered = getFilteredMolds();
            currentFilteredMolds = filtered;
            renderMoldsList();
            
            // 更新筛选结果显示
            updateFilterResultsDisplay(filtered);
        }
        
        // 获取状态显示文本
        function getStatusDisplayText(status) {
            const statusMap = {
                'pending': '待开始',
                'active': '进行中',
                'completed': '已完成',
                'paused': '暂停',
                'cancelled': '已取消',
                'delayed': '延期'
            };
            return statusMap[normalizeStatus(status)] || status;
        }
        
        // 应用快速筛选逻辑
        function applyQuickFilterLogic(molds, filterType) {
            const now = new Date();
            
            switch (filterType) {
                case 'today':
                    // 今日更新的模具
                    const today = now.toISOString().split('T')[0];
                    return molds.filter(mold => {
                        const updatedDate = new Date(mold.updatedAt).toISOString().split('T')[0];
                        return updatedDate === today;
                    });
                    
                case 'week':
                    // 本周创建的模具
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return molds.filter(mold => {
                        const createdDate = new Date(mold.createdAt);
                        return createdDate >= weekAgo;
                    });
                    
                case 'recent':
                    // 最近3天创建的模具
                    const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
                    return molds.filter(mold => {
                        const createdDate = new Date(mold.createdAt);
                        return createdDate >= threeDaysAgo;
                    });
                    
                case 'completed':
                    // 全部完成的模具
                    return molds.filter(mold => normalizeStatus(mold.status) === 'completed');
                    
                case 'active':
                    // 进行中的模具（标准化后为 inProgress）
                    return molds.filter(mold => normalizeStatus(mold.status) === 'inProgress');
                    
                case 'urgent':
                    // 即将试模的模具（优化逻辑）
                    return getUpcomingTestMolds(molds);
                    
                case 'overdue':
                    // 逾期的模具
                    return getOverdueMolds(molds);
                    
                default:
                    return molds;
            }
        }
        
        // 获取即将试模的模具（优化逻辑 - 基于下一工序）
        function getUpcomingTestMolds(molds = moldsData) {
            return molds.filter(mold => {
                // 排除已完成的模具
                if (normalizeStatus(mold.status) === 'completed') return false;
                
                // 检查是否有工序数据
                if (!mold.processes || mold.processes.length === 0) return false;
                
                // 查找下一个未完成的工序
                const nextProcess = mold.processes.find(process => 
                    normalizeStatus(process.status) !== 'completed'
                );
                
                // 如果下一工序名称包含"试模"，则认为即将试模
                if (nextProcess && nextProcess.name) {
                    return nextProcess.name.includes('试模');
                }
                
                return false;
            }).sort((a, b) => {
                // 按更新时间排序，最近更新的在前
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
        }
        
        // 获取逾期的模具
        function getOverdueMolds(molds = moldsData) {
            const now = new Date();
            
            return molds.filter(mold => isOverdue(mold))
                .sort((a, b) => {
                    // 按逾期时间排序，逾期最久的在前
                    const aOverdueTime = getOverdueTime(a);
                    const bOverdueTime = getOverdueTime(b);
                    return bOverdueTime - aOverdueTime;
                });
        }
        
        // 判断模具是否逾期
        function isOverdue(mold) {
            const now = new Date();
            
            // 检查试模日期是否逾期
            if (mold.testDate) {
                const testDate = new Date(mold.testDate);
                if (!isNaN(testDate.getTime()) && testDate < now && normalizeStatus(mold.status) !== 'completed') {
                    return true;
                }
            }
            
            return false;
        }
        
        // 判断模具是否即将试模（基于下一工序）
        function isUpcomingTest(mold) {
            // 排除已完成的模具
            if (normalizeStatus(mold.status) === 'completed') return false;
            
            // 检查是否有工序数据
            if (!mold.processes || mold.processes.length === 0) return false;
            
            // 查找下一个未完成的工序
            const nextProcess = mold.processes.find(process => 
                normalizeStatus(process.status) !== 'completed'
            );
            
            // 如果下一工序名称包含"试模"，则认为即将试模
            if (nextProcess && nextProcess.name) {
                return nextProcess.name.includes('试模');
            }
            
            return false;
        }
        
        // 获取逾期时间（毫秒）
        function getOverdueTime(mold) {
            const now = new Date();
            let maxOverdue = 0;
            
            if (mold.testDate) {
                const testDate = new Date(mold.testDate);
                if (!isNaN(testDate.getTime()) && testDate < now) {
                    maxOverdue = Math.max(maxOverdue, now - testDate);
                }
            }
            
            if (mold.moldOpenNotice) {
                const noticeDate = new Date(mold.moldOpenNotice);
                if (!isNaN(noticeDate.getTime()) && noticeDate < now) {
                    maxOverdue = Math.max(maxOverdue, now - noticeDate);
                }
            }
            
            return maxOverdue;
        }
        
        // 更新筛选结果显示
        function updateFilterResultsDisplay(filteredMolds) {
            const filteredCountElement = document.getElementById('filteredCount');
            const searchTerm = searchMolds ? searchMolds.value.toLowerCase().trim() : '';
            
            if (filteredCountElement) {
                filteredCountElement.textContent = filteredMolds.length;
            }
            
            // 显示搜索结果提示
            if (searchTerm && filteredMolds.length === 0) {
                showNotification(`未找到包含 "${searchTerm}" 的模具项目`, 'warning');
            } else if (searchTerm && filteredMolds.length > 0) {
                showNotification(`找到 ${filteredMolds.length} 个包含 "${searchTerm}" 的项目`, 'success');
            }
            
            // 更新空状态显示
            const emptyState = document.getElementById('emptyState');
            const moldsGrid = document.getElementById('moldsGrid');
            
            if (filteredMolds.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                if (moldsGrid) moldsGrid.classList.add('hidden');
            } else {
                if (emptyState) emptyState.classList.add('hidden');
                if (moldsGrid) moldsGrid.classList.remove('hidden');
            }
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            const normalizedStatus = normalizeStatus(status);
            switch (normalizedStatus) {
                case 'inProgress': return 'status-active';
                case 'completed': return 'status-completed';
                case 'pending': return 'status-pending';
                case 'delayed': return 'status-delayed';
                default: return 'status-pending';
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const normalizedStatus = normalizeStatus(status);
            const statusOption = statusOptions.find(s => s.id === normalizedStatus);
            return statusOption ? statusOption.name : '待开始';
        }
        
        // 为模具卡片添加事件监听器
        function attachMoldCardListeners() {
            console.log('绑定模具卡片事件监听器'); // 调试信息
            console.log('当前模具数据:', moldsData); // 调试信息
            
            // 编辑模具
            document.querySelectorAll('.edit-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    editMold(moldId);
                });
            });
            
            // 预览模具
            document.querySelectorAll('.preview-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    previewMold(moldId);
                });
            });
            
            // 导出模具
            document.querySelectorAll('.export-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    exportMoldToExcel(moldId);
                });
            });
            
            // 删除模具
            document.querySelectorAll('.delete-mold').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const moldId = parseInt(e.currentTarget.dataset.id);
                    deleteMold(moldId);
                });
            });
            
            // 点击模具卡片进入编辑（排除按钮）
            document.querySelectorAll('.mold-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // 如果点击的是按钮，不触发卡片点击事件
                    if (e.target.closest('button')) return;
                    
                    const moldId = parseInt(card.dataset.id);
                    editMold(moldId);
                });
            });
        }
        
        // 编辑模具
        function editMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('模具不存在', 'error');
                return;
            }
            
            // 加载模具数据到当前编辑界面
            currentMoldId = moldId;
            loadMoldToEditor(mold);
            switchPage('tracking');
            showNotification(`正在编辑模具: ${mold.moldNumber}`, 'info');
        }
        
        // 预览模具
        function previewMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('模具不存在', 'error');
                return;
            }
            
            // 加载模具数据到预览界面（只读模式）
            loadMoldToEditor(mold, true);
            switchPage('tracking');
            showNotification(`正在预览模具: ${mold.moldNumber}`, 'info');
        }
        
        // 导出单个模具到Excel
        function exportMoldToExcel(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('模具不存在', 'error');
                return;
            }
            
            // 临时加载模具数据并导出
            const originalData = { ...getCurrentMoldData() };
            const originalProcessData = [...processData];
            
            loadMoldToEditor(mold);
            
            // 执行导出
            setTimeout(() => {
                exportToExcel();
                
                // 恢复原始数据
                loadMoldToEditor(originalData);
                processData = originalProcessData;
                renderProcessTable();
                updateCycleStatistics();
            }, 100);
        }
        
        // 删除模具
        function deleteMold(moldId) {
            const mold = moldsData.find(m => m.id === moldId);
            if (!mold) {
                showNotification('模具不存在', 'error');
                return;
            }
            
            if (confirm(`确定要删除模具 "${mold.moldNumber}" 吗？此操作不可恢复。`)) {
                moldsData = moldsData.filter(m => m.id !== moldId);
                saveMoldsData();
                renderMoldsList();
                showNotification('模具已删除', 'success');
                
                // 如果删除的是当前编辑的模具，清空编辑器
                if (currentMoldId === moldId) {
                    currentMoldId = null;
                    clearEditor();
                }
            }
        }
        
        
        
        // 加载模具数据到编辑器
        function loadMoldToEditor(mold, readOnly = false) {
            // 加载基本信息
            document.getElementById('moldNumber').value = mold.moldNumber || '';
            document.getElementById('moldName').value = mold.moldName || '';
            document.getElementById('moldType').value = mold.moldType || '';
            document.getElementById('version').value = mold.version || '';
            document.getElementById('productName').value = mold.productName || '';
            document.getElementById('material').value = mold.material || '';
            document.getElementById('cavityCount').value = mold.cavityCount || '';
            document.getElementById('moldOpenNotice').value = mold.moldOpenNotice || '';
            document.getElementById('testDate').value = mold.testDate || '';
            document.getElementById('moldRemark').value = mold.moldRemark || '';
            
            // 加载工序数据
            processData = mold.processes || [];
            nextProcessId = Math.max(...processData.map(p => p.id), 0) + 1;
            
            // 设置只读模式
            if (readOnly) {
                setEditorReadOnly(true);
            } else {
                setEditorReadOnly(false);
            }
            
            renderProcessTable();
            updateCycleStatistics();
        }
        
        // 获取当前模具数据
        function getCurrentMoldData() {
            return {
                moldNumber: document.getElementById('moldNumber').value.trim(),
                moldName: document.getElementById('moldName').value.trim(),
                moldType: document.getElementById('moldType').value.trim(),
                version: document.getElementById('version').value.trim(),
                productName: document.getElementById('productName').value.trim(),
                material: document.getElementById('material').value.trim(),
                cavityCount: document.getElementById('cavityCount').value.trim(),
                moldOpenNotice: document.getElementById('moldOpenNotice').value,
                testDate: document.getElementById('testDate').value,
                moldRemark: document.getElementById('moldRemark').value.trim(),
                processes: [...processData]
            };
        }
        
        // 设置编辑器只读模式
        function setEditorReadOnly(readOnly) {
            const inputs = document.querySelectorAll('#trackingPage input, #trackingPage textarea, #trackingPage select');
            const buttons = document.querySelectorAll('#trackingPage button');
            
            inputs.forEach(input => {
                input.disabled = readOnly;
            });
            
            buttons.forEach(button => {
                if (readOnly && !button.id.includes('export')) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
        
        // 清空编辑器
        function clearEditor() {
            document.getElementById('moldNumber').value = '';
            document.getElementById('moldName').value = '';
            document.getElementById('moldType').value = '';
            document.getElementById('version').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('material').value = '';
            document.getElementById('cavityCount').value = '';
            document.getElementById('moldOpenNotice').value = '';
            document.getElementById('testDate').value = '';
            document.getElementById('moldRemark').value = '';
            
            processData = [];
            nextProcessId = 1;
            currentMoldId = null;
            
            renderProcessTable();
            updateCycleStatistics();
            setEditorReadOnly(false);
        }
        
        // 新增智能化辅助函数
        
        // 自动保存并同步数据
        function autoSaveWithSync() {
            try {
                // 保存当前数据
                const result = saveData();
                
                if (result) {
                    // 收集模具基本信息
                    const moldInfo = {
                        moldNumber: document.getElementById('moldNumber').value.trim(),
                        moldName: document.getElementById('moldName').value.trim(),
                        moldType: document.getElementById('moldType').value.trim(),
                        version: document.getElementById('version').value.trim(),
                        productName: document.getElementById('productName').value.trim(),
                        material: document.getElementById('material').value.trim(),
                        cavityCount: document.getElementById('cavityCount').value.trim(),
                        moldOpenNotice: document.getElementById('moldOpenNotice').value,
                        testDate: document.getElementById('testDate').value,
                        moldRemark: document.getElementById('moldRemark').value.trim()
                    };
                    
                    // 同步到模具管理列表
                    syncToMoldManagement(moldInfo, processData);
                }
                
                return result;
            } catch (error) {
                console.error('自动保存同步失败:', error);
                return false;
            }
        }
        
        // 智能设置工序默认值
        function autoSetProcessDefaults(process) {
            const processDefaults = {
                '设计评审': { days: 2, remark: '图纸审核、工艺评估' },
                '材料采购': { days: 3, remark: '钢材、标准件采购' },
                '深孔钻': { days: 4, remark: '模板加工、深孔钻削' },
                '铣床加工': { days: 4, remark: '模板加工、深孔钻削' },
                'CNC粗加工': { days: 5, remark: '毛坯CNC粗加工成型' },
                '热处理': { days: 2, remark: '淬火回火处理' },
                '磨床加工': { days: 2, remark: '淬火回火、精密磨削' },
                '线割': { days: 3, remark: '精密线切割加工' },
                '线割加工': { days: 3, remark: '精密线切割加工' },
                'CNC精加工': { days: 7, remark: '精密铣削、钻孔攻丝' },
                'EDM': { days: 4, remark: '电火花加工成型' },
                'EDM加工': { days: 4, remark: '电火花加工成型' },
                '省模': { days: 2, remark: '模具抛光、表面处理' },
                '抛光': { days: 2, remark: '模具抛光、表面处理' },
                '配装': { days: 3, remark: '零件装配、试合模' },
                '合模': { days: 3, remark: '零件装配、试合模' },
                '试模': { days: 1, remark: '首次试模验证' }
            };
            
            // 查找匹配的默认设置
            for (const [key, defaults] of Object.entries(processDefaults)) {
                if (process.name.includes(key)) {
                    if (!process.planDays || process.planDays === 0) {
                        process.planDays = defaults.days;
                    }
                    if (!process.remark) {
                        process.remark = defaults.remark;
                    }
                    
                    // 如果有开始日期，自动计算结束日期
                    if (process.planStart && process.planDays > 0) {
                        calculateAndUpdatePlanEnd(process.id);
                    }
                    break;
                }
            }
        }
        
        // 处理第一道工序日期变更
        function handleFirstProcessDateChange(process) {
            // 自动设置天数（如果为空）
            if (!process.planDays || process.planDays === 0) {
                autoSetProcessDefaults(process);
            }
            
            // 计算结束日期
            if (process.planStart && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
            
            // 重新计算所有后续工序
            fullIntelligentRecalculation();
            
            // 更新界面
            renderProcessTable();
            updateCycleStatistics();
            
            showNotification('第一道工序日期已更新，所有后续工序已自动推算', 'success');
        }
        
        // 处理后续工序日期变更
        function handleSubsequentProcessDateChange(process, processIndex) {
            // 计算结束日期
            if (process.planStart && process.planDays > 0) {
                calculateAndUpdatePlanEnd(process.id);
            }
            
            // 更新后续工序
            updateSubsequentPlansIntelligent(processIndex);
            
            // 更新界面
            renderProcessTable();
            updateCycleStatistics();
            
            showNotification('计划日期已更新，后续工序已自动调整', 'success');
        }
        
        // 处理计划天数变更
        function handlePlanDaysChange(process, processIndex, oldDays, newDays) {
            if (newDays > 0) {
                // 如果有开始日期，重新计算结束日期
                if (process.planStart) {
                    calculateAndUpdatePlanEnd(process.id);
                }
                
                // 更新后续工序
                updateSubsequentPlansIntelligent(processIndex);
                
                // 更新界面
                renderProcessTable();
                updateCycleStatistics();
                
                showNotification(`工序"${process.name}"天数已更新为${newDays}天，日期已自动计算`, 'success');
            } else {
                // 天数为0或空，清空结束日期
                process.planEnd = '';
                renderProcessTable();
                updateCycleStatistics();
            }
        }
        
        // 处理状态变更
        function handleStatusChange(process, oldStatus, newStatus) {
            const now = new Date();
            const today = formatDate(now);
            
            // 根据状态变更自动设置实际日期
            if (newStatus === 'inProgress' && oldStatus === 'pending') {
                // 开始工序
                if (!process.actualStart) {
                    process.actualStart = today;
                    showNotification(`工序"${process.name}"已开始，实际开始日期设为今天`, 'info');
                }
            } else if (newStatus === 'completed' && oldStatus === 'inProgress') {
                // 完成工序
                if (!process.actualEnd) {
                    process.actualEnd = today;
                }
                
                // 自动计算实际天数
                if (process.actualStart && process.actualEnd) {
                    calculateAndUpdateActualDays(process.id);
                }
                
                showNotification(`工序"${process.name}"已完成，实际结束日期设为今天`, 'success');
            }
        }
        
        // 显示工序建议
        function showProcessSuggestions(input) {
            // 这里可以实现工序名称的智能提示功能
            // 暂时简化处理
        }
        
        // 计算模具进度百分比
        function calculateMoldProgress(processes) {
            if (!processes || processes.length === 0) return 0;
            const completedCount = processes.filter(p => p.status === 'completed').length;
            return Math.round((completedCount / processes.length) * 100);
        }
        
        // 获取当前工序名称
        function getCurrentProcessName(processes) {
            if (!processes || processes.length === 0) return '暂无工序';
            
            const inProgress = processes.find(p => p.status === 'inProgress');
            if (inProgress) return inProgress.name;
            
            const nextPending = processes.find(p => p.status === 'pending');
            if (nextPending) return `待开始: ${nextPending.name}`;
            
            const lastCompleted = processes.filter(p => p.status === 'completed').pop();
            if (lastCompleted) return `已完成: ${lastCompleted.name}`;
            
            return processes[0].name;
        }
        
        // 计算总计划天数
        function calculateTotalPlanDays(processes) {
            if (!processes || processes.length === 0) return 0;
            return processes.reduce((sum, p) => sum + (parseInt(p.planDays) || 0), 0);
        }
        
        // 计算已完成天数
        function calculateCompletedDays(processes) {
            if (!processes || processes.length === 0) return 0;
            return processes
                .filter(p => p.status === 'completed')
                .reduce((sum, p) => sum + (parseInt(p.actualDays) || parseInt(p.planDays) || 0), 0);
        }
        
        // 重写保存数据函数以支持模具管理
        const originalSaveData = saveData;
        saveData = function() {
            const result = originalSaveData();
            
            if (result && currentMoldId) {
                // 更新模具管理中的数据
                const moldIndex = moldsData.findIndex(m => m.id === currentMoldId);
                if (moldIndex !== -1) {
                    const currentData = getCurrentMoldData();
                    moldsData[moldIndex] = {
                        ...moldsData[moldIndex],
                        ...currentData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 更新状态和进度信息
                    moldsData[moldIndex].status = calculateMoldStatus(processData);
                    moldsData[moldIndex].progress = calculateMoldProgress(processData);
                    moldsData[moldIndex].currentProcess = getCurrentProcessName(processData);
                    moldsData[moldIndex].totalDays = calculateTotalPlanDays(processData);
                    moldsData[moldIndex].completedDays = calculateCompletedDays(processData);
                    
                    saveMoldsData();
                }
            }
            
            return result;
        };
        
        // ==================== 列宽调整功能 ====================
        
        // 初始化列宽调整功能
        function initColumnResizer() {
            const tables = document.querySelectorAll('.resizable-table');
            
            tables.forEach(table => {
                const resizers = table.querySelectorAll('.column-resizer');
                
                resizers.forEach(resizer => {
                    let isResizing = false;
                    let startX = 0;
                    let startWidth = 0;
                    let currentTh = null;
                    
                    resizer.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        startX = e.clientX;
                        currentTh = resizer.parentElement;
                        startWidth = parseInt(window.getComputedStyle(currentTh).width, 10);
                        
                        resizer.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        
                        e.preventDefault();
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        
                        const width = startWidth + e.clientX - startX;
                        const minWidth = 50; // 最小列宽
                        const maxWidth = 500; // 最大列宽
                        
                        if (width >= minWidth && width <= maxWidth) {
                            currentTh.style.width = width + 'px';
                            
                            // 同步更新对应的tbody中的单元格宽度
                            const columnIndex = Array.from(currentTh.parentElement.children).indexOf(currentTh);
                            const tbody = table.querySelector('tbody');
                            if (tbody) {
                                const rows = tbody.querySelectorAll('tr');
                                rows.forEach(row => {
                                    const cell = row.children[columnIndex];
                                    if (cell) {
                                        cell.style.width = width + 'px';
                                    }
                                });
                            }
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        if (isResizing) {
                            isResizing = false;
                            resizer.classList.remove('resizing');
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            currentTh = null;
                        }
                    });
                });
            });
        }
        
        // 在页面加载完成后初始化列宽调整功能
        document.addEventListener('DOMContentLoaded', () => {
            // 延迟初始化，确保表格已经渲染完成
            setTimeout(() => {
                initColumnResizer();
            }, 500);
        });
        
        // 重新渲染表格后重新初始化列宽调整功能
        const originalRenderProcessTable = renderProcessTable;
        renderProcessTable = function() {
            originalRenderProcessTable();
            setTimeout(() => {
                initColumnResizer();
            }, 100);
        };
        
        const originalRenderMoldsList = renderMoldsList;
        renderMoldsList = function() {
            originalRenderMoldsList();
            setTimeout(() => {
                initColumnResizer();
            }, 100);
        };
        
        // 重新渲染表格后重新初始化列宽调整功能（修复内存泄漏）
        const originalRenderProcessTableFixed = renderProcessTable;
        renderProcessTable = function() {
            // 清理旧的事件监听器
            cleanupEventListeners();
            
            originalRenderProcessTableFixed();
            setTimeout(() => {
                initColumnResizer();
            }, 100);
        };
        
        // 页面卸载时清理事件监听器
        eventManager.addListener(window, 'beforeunload', () => {
            eventManager.cleanup();
        });
   
        // 获取状态配置
        function getStatusConfig(status) {
            const configs = {
                'pending': { name: '未开始', class: 'bg-pending/20 text-pending border border-pending/30' },
                'inProgress': { name: '进行中', class: 'bg-warning/20 text-warning border border-warning/30' },
                'completed': { name: '已完成', class: 'bg-success/20 text-success border border-success/30' },
                'delayed': { name: '已延迟', class: 'bg-danger/20 text-danger border border-danger/30' }
            };
            return configs[status] || configs['pending'];
        }
    </script>

</body>
</html>
